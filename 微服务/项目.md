# 一、项目简介

## 开发环境

- 操作系统：mac
- 开发工具：Intellij IDEA
- 数据库：MySQL 5.7.22
- Java SDK：Oracle JDK 1.8.152

## 部署环境

- 操作系统：centos7
- 虚拟化技术：VMware + Docker

## 项目管理工具

- 项目构建：Maven + Nexus
- 代码管理：Git + GitLab
- 镜像管理：Docker + Registry

## 后台主要技术栈

- 核心框架：Spring Boot + Spring Cloud
- 视图框架：Spring MVC
- 页面引擎：Thymeleaf
- ORM 框架：tk.mybatis 简化 MyBatis 开发
- 数据库连接池：Alibaba Druid
- 数据库缓存：Redis Sentinel
- 消息中间件：RabbitMQ
- 接口文档引擎：Swagger2 RESTful 风格 API 文档生成
- 全文检索引擎：ElasticSearch
- 分布式链路追踪：ZipKin
- 分布式文件系统：HDFS
- 分布式服务监控：Spring Boot Admin
- 分布式协调系统：Spring Cloud Eureka
- 分布式配置中心：Spring Cloud Config
- 分布式日志系统：ELK（ElasticSearch + Logstash + Kibana）
- 反向代理负载均衡：Nginx

## 前端主要技术栈

- 前端框架:vuejs
- 后台模板:AdminLTE

## 自动化运维

- 持续集成：GitLab
- 持续交付：Jenkins
- 容器编排：Kubernetes或docker-compose

## 系统架构

![img](/Users/liujiang/Documents/Typora/imgs/006tNc79ly1g2xr9ayclnj316s0u0jvq.jpg)

## 服务规划

### Cloud

| 服务名称      | 服务端口 | 服务说明       |
| ------------- | -------- | -------------- |
| itoken-eureka | 8761     | 服务注册与发现 |
| itoken-config | 8888     | 分布式配置中心 |
| itoken-zipkin | 9411     | 分布式链路追踪 |
| itoken-zuul   | 8769     | 分布式路由网关 |
| itoken-admin  | 8084     | 分布式系统监控 |

### Service

| 服务名称                  | 服务端口 | 服务说明           |
| ------------------------- | -------- | ------------------ |
| itoken-service-admin      | 8501     | 管理员服务提供者   |
| itoken-service-redis      | 8502     | 数据缓存服务提供者 |
| itoken-service-sso        | 8503     | 单点登录服务提供者 |
| itoken-service-posts      | 8504     | 文章服务提供者     |
| itoken-service-upload     | 8505     | 文件上传服务提供者 |
| itoken-service-digiccy    | 8506     | 数字货币服务提供者 |
| itoken-service-collection | 8507     | 数据采集服务提供者 |

### Web

| 服务名称           | 服务端口 | 服务说明           |
| ------------------ | -------- | ------------------ |
| itoken-web-admin   | 8601     | 管理员服务消费者   |
| itoken-web-posts   | 8602     | 文章服务消费者     |
| itoken-web-backend | 8603     | 后台服务聚合       |
| itoken-web-digiccy | 8604     | 数字货币服务消费者 |

# 二、开发流程

## 1、项目结构

- itoken
  - token-dependencies统一的依赖管理
  - token-eureka服务注册与发现
  - token-zuul路由网关
  - token-config分布式配置中心
  - token-zipkin分布式链路追踪
  - token-admin服务监控
  
- 上面的结构需要现在码云上创建仓库

- Idea在克隆到本地

  ![token__springcloud_-_码云_Gitee_com](https://ws4.sinaimg.cn/large/006tNc79ly1g2xr99u0gbj31e50u042r.jpg)

## 2、导入项目

- idea以open的方式打开

  ![itoken____Documents_itoken_](https://ws2.sinaimg.cn/large/006tNc79ly1g2xr9ahpw6j306f06dt8x.jpg)

## 3、完善配置

#### Token-dependencies 的pom

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.0.2.RELEASE</version>
    </parent>

    <groupId>com.aishang</groupId>
    <artifactId>token-dependencies</artifactId>
    <version>1.0.0-SNAPSHOT</version>
    <packaging>pom</packaging>

    <name>token-dependencies</name>

    <properties>
        <!-- Environment Settings -->
        <java.version>1.8</java.version>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>

        <!-- Spring Settings -->
        <spring-cloud.version>Finchley.RELEASE</spring-cloud.version>

        <!--zipkin-->
        <zipkin.version>2.10.1</zipkin.version>
        <!--spring boot admin-->
        <codecentric.version>2.0.2</codecentric.version>
    </properties>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${spring-cloud.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            <!--zipkin-->
            <dependency>
                <groupId>io.zipkin.java</groupId>
                <artifactId>zipkin</artifactId>
                <version>${zipkin.version}</version>
            </dependency>
            <dependency>
                <groupId>io.zipkin.java</groupId>
                <artifactId>zipkin-server</artifactId>
                <version>${zipkin.version}</version>
            </dependency>
            <dependency>
                <groupId>io.zipkin.java</groupId>
                <artifactId>zipkin-autoconfigure-ui</artifactId>
                <version>${zipkin.version}</version>
            </dependency>
            <!--spring boot admin server-->
            <dependency>
                <groupId>de.codecentric</groupId>
                <artifactId>spring-boot-admin-starter-server</artifactId>
                <version>${codecentric.version}</version>
            </dependency>
            <!--spring boot admin client-->
            <dependency>
                <groupId>de.codecentric</groupId>
                <artifactId>spring-boot-admin-starter-client</artifactId>
                <version>${codecentric.version}</version>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <build>
        <plugins>
            <!-- Compiler 插件, 设定 JDK 版本 -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <configuration>
                    <showWarnings>true</showWarnings>
                </configuration>
            </plugin>

            <!-- 打包 jar 文件时，配置 manifest 文件，加入 lib 包的 jar 依赖 -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-jar-plugin</artifactId>
                <configuration>
                    <archive>
                        <addMavenDescriptor>false</addMavenDescriptor>
                    </archive>
                </configuration>
                <executions>
                    <execution>
                        <configuration>
                            <archive>
                                <manifest>
                                    <!-- Add directory entries -->
                                    <addDefaultImplementationEntries>true</addDefaultImplementationEntries>
                                    <addDefaultSpecificationEntries>true</addDefaultSpecificationEntries>
                                    <addClasspath>true</addClasspath>
                                </manifest>
                            </archive>
                        </configuration>
                    </execution>
                </executions>
            </plugin>

            <!-- resource -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-resources-plugin</artifactId>
            </plugin>

            <!-- install -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-install-plugin</artifactId>
            </plugin>

            <!-- clean -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-clean-plugin</artifactId>
            </plugin>

            <!-- ant -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-antrun-plugin</artifactId>
            </plugin>

            <!-- dependency -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-dependency-plugin</artifactId>
            </plugin>
        </plugins>

        <pluginManagement>
            <plugins>
                <!-- Java Document Generate -->
                <plugin>
                    <groupId>org.apache.maven.plugins</groupId>
                    <artifactId>maven-javadoc-plugin</artifactId>
                    <executions>
                        <execution>
                            <phase>prepare-package</phase>
                            <goals>
                                <goal>jar</goal>
                            </goals>
                        </execution>
                    </executions>
                </plugin>

                <!-- YUI Compressor (CSS/JS压缩) -->
                <plugin>
                    <groupId>net.alchim31.maven</groupId>
                    <artifactId>yuicompressor-maven-plugin</artifactId>
                    <version>1.5.1</version>
                    <executions>
                        <execution>
                            <phase>prepare-package</phase>
                            <goals>
                                <goal>compress</goal>
                            </goals>
                        </execution>
                    </executions>
                    <configuration>
                        <encoding>UTF-8</encoding>
                        <jswarn>false</jswarn>
                        <nosuffix>true</nosuffix>
                        <linebreakpos>30000</linebreakpos>
                        <force>true</force>
                        <includes>
                            <include>**/*.js</include>
                            <include>**/*.css</include>
                        </includes>
                        <excludes>
                            <exclude>**/*.min.js</exclude>
                            <exclude>**/*.min.css</exclude>
                        </excludes>
                    </configuration>
                </plugin>
            </plugins>
        </pluginManagement>

        <!-- 资源文件配置 -->
        <resources>
            <resource>
                <directory>src/main/java</directory>
                <excludes>
                    <exclude>**/*.java</exclude>
                </excludes>
            </resource>
            <resource>
                <directory>src/main/resources</directory>
            </resource>
        </resources>
    </build>

    <!--nexus-->
    <distributionManagement>
        <repository>
            <id>nexus-releases</id>
            <name>Nexus Release Repository</name>
            <url>http://192.168.83.200:8081/repository/maven-releases/</url>
        </repository>
        <snapshotRepository>
            <id>nexus-releases</id>
            <name>Nexus snapshots Repository</name>
            <url>http://192.168.83.200:8081/repository/maven-snapshots/</url>
        </snapshotRepository>
    </distributionManagement>

    <repositories>
        <repository>
            <id>nexus</id>
            <name>Nexus Repository</name>
            <url>http://192.168.0.100:8081/repository/maven-public/</url>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
            <releases>
                <enabled>true</enabled>
            </releases>
        </repository>
        <repository>
            <id>aliyun-repos</id>
            <name>Aliyun Repository</name>
            <url>http://maven.aliyun.com/nexus/content/groups/public</url>
            <releases>
                <enabled>true</enabled>
            </releases>
            <snapshots>
                <enabled>false</enabled>
            </snapshots>
        </repository>

        <repository>
            <id>sonatype-repos</id>
            <name>Sonatype Repository</name>
            <url>https://oss.sonatype.org/content/groups/public</url>
            <releases>
                <enabled>true</enabled>
            </releases>
            <snapshots>
                <enabled>false</enabled>
            </snapshots>
        </repository>
        <repository>
            <id>sonatype-repos-s</id>
            <name>Sonatype Repository</name>
            <url>https://oss.sonatype.org/content/repositories/snapshots</url>
            <releases>
                <enabled>false</enabled>
            </releases>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>

        <repository>
            <id>spring-snapshots</id>
            <name>Spring Snapshots</name>
            <url>https://repo.spring.io/snapshot</url>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
        <repository>
            <id>spring-milestones</id>
            <name>Spring Milestones</name>
            <url>https://repo.spring.io/milestone</url>
            <snapshots>
                <enabled>false</enabled>
            </snapshots>
        </repository>
    </repositories>

    <pluginRepositories>
        <pluginRepository>
            <id>aliyun-repos</id>
            <name>Aliyun Repository</name>
            <url>http://maven.aliyun.com/nexus/content/groups/public</url>
            <releases>
                <enabled>true</enabled>
            </releases>
            <snapshots>
                <enabled>false</enabled>
            </snapshots>
        </pluginRepository>
    </pluginRepositories>
</project>
```



#### token-config

##### Pom

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>com.aishang</groupId>
        <artifactId>token-dependencies</artifactId>
        <version>1.0.0-SNAPSHOT</version>
        <relativePath>../token-dependencies/pom.xml</relativePath>
    </parent>

    <artifactId>token-config</artifactId>
    <packaging>jar</packaging>

    <name>token-config</name>

    <dependencies>
        <!-- Spring Boot Begin -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-tomcat</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <!-- Spring Boot End -->

        <!-- Spring Cloud Begin -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-config-server</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
        </dependency>
        <!-- Spring Cloud End -->

        <!--zipkin-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-zipkin</artifactId>
        </dependency>

        <!--spring boot admin client-->
        <dependency>
            <groupId>org.jolokia</groupId>
            <artifactId>jolokia-core</artifactId>
        </dependency>
        <dependency>
            <groupId>de.codecentric</groupId>
            <artifactId>spring-boot-admin-starter-client</artifactId>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <mainClass>com.aishang.token.config.ConfigApplication</mainClass>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```

##### 新建respo文件夹，存放以下文件

##### token-admin-dev.yml

```yml
spring:
  application:
    name: token-admin
  zipkin:
    base-url: http://localhost:9411

server:
  port: 8084

management:
  endpoint:
    health:
      show-details: always
  endpoints:
    web:
      exposure:
        include: health, info
#incule还有其他功能，可以直接*   原来include: ["health", "info"]这么写在这里报错
#所有的配置里都要添加这段，因为都需要监控
eureka:
  client:
    serviceUrl:
      defaultZone: http://localhost:8761/eureka/
```

- token-zipkin-dev.yml

```yml
spring:
  application:
    name: token-zipkin
  boot:
    admin:
      client:
        url: http://localhost:8084

server:
  port: 9411

eureka:
  client:
    serviceUrl:
      defaultZone: http://localhost:8761/eureka/

management:
  metrics:
    web:
      server:
        auto-time-requests: false
```

##### token-eureka-dev.yml

```yml
spring:
  application:
    name: token-eureka
    #给项目起名，服务注册与发现，别人通过项目名找到服务
  zipkin:
    base-url: http://localhost:9411

  boot:
    admin:
      client:
        url: http://localhost:8084
server:
  port: 8761

eureka:
  instance:
    hostname: localhost
  client:
    registerWithEureka: false
    fetchRegistry: false
    #上面两句改为false代表是服务端，否则是客户端
    serviceUrl:
      defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka/
      #尤里卡访问地址


management:
  endpoint:
    health:
      show-details: always
  endpoints:
    web:
      exposure:
        include: health, info
```

##### token-zipkin-dev.yml

```yml
spring:
  application:
    name: token-zipkin
  boot:
    admin:
      client:
        url: http://localhost:8084

server:
  port: 9411

eureka:
  client:
    serviceUrl:
      defaultZone: http://localhost:8761/eureka/

management:
  metrics:
    web:
      server:
        auto-time-requests: false
  endpoint:
    health:
      show-details: always
  endpoints:
    web:
      exposure:
        include: health, info
```

##### token-eureka-prod.yml

```yml
spring:
  application:
    name: token-eureka
    #给项目起名，服务注册与发现，别人通过项目名找到服务
  zipkin:
    base-url: http://localhost:9411

  boot:
    admin:
      client:
        url: http://localhost:8084
  server:
    port: 8762

  eureka:
    instance:
      hostname: localhost
    client:
      #改成true表示是否将自己注册到eureka，因为要构建集群环境，需要将自己注册到集群，所以应该开启
      registerWithEureka: true
      #表示是否从eureka获取注册信息，如果是单一节点，不需要同步其他尤里卡节点，则可以false，但此处是集群，应该设置为true
      fetchRegistry: true
      #上面两句改为false代表是服务端，否则是客户端
      serviceUrl:
        defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka/,http://${eureka.instance.hostname}:${server.port}/eureka/,http://${eureka.instance.hostname}:${server.port}/eureka/
        #defaultZone: http://ip:${server.port}/eureka/,http://ip:${server.port}/eureka/,http://ip:${server.port}/eureka/
        #ip到时候改成集群的地址，目前只是个案例
        #尤里卡访问地址


  management:
    endpoint:
      health:
        show-details: always
    endpoints:
      web:
        exposure:
          include: health, info
```



##### 新建src/main/java

resouces目录下

##### application.yml

```yml
spring:
  application:
    name: token-config
  cloud:
    config:
      label: master
      server:
        git:
          uri: https://gitee.com/liujiang8800/token
          search-paths: token-config/respo
          #注意这里的路径，对应仓库下的那个文件下的，才能找到配置文件
          username: **
          password: **
  zipkin:
    base-url: http://localhost:9411

  boot:
    admin:
      client:
        url: http://localhost:8084
server:
  port: 8888

eureka:
  client:
    serviceUrl:
      defaultZone: http://localhost:8761/eureka/
```

##### ConfigApplication.java

```java
package com.aishang.token.config;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.config.server.EnableConfigServer;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;

@SpringBootApplication
@EnableConfigServer
@EnableEurekaClient
public class ConfigApplication {
    public static void main(String[] args) {
        SpringApplication.run(ConfigApplication.class, args);
    }
}

```



#### token-eureka

##### pom

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>com.aishang</groupId>
        <artifactId>token-dependencies</artifactId>
        <version>1.0.0-SNAPSHOT</version>
        <relativePath>../token-dependencies/pom.xml</relativePath>
    </parent>

    <artifactId>token-eureka</artifactId>
    <packaging>jar</packaging>

    <name>token-eureka</name>

    <dependencies>
        <!-- Spring Boot Begin -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <!-- Spring Boot End -->

        <!-- Spring Cloud Begin -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
        </dependency>
        <!-- Spring Cloud End -->
        <!--zipkin-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-zipkin</artifactId>
        </dependency>

        <!--分布式配置中心-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-config</artifactId>
        </dependency>
        <!--springboot admin client-->
        <dependency>
            <groupId>org.jolokia</groupId>
            <artifactId>jolokia-core</artifactId>
        </dependency>
        <dependency>
            <groupId>de.codecentric</groupId>
            <artifactId>spring-boot-admin-starter-client</artifactId>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <mainClass>com.aishang.token.eureka.EurekaApplication</mainClass>
                </configuration>
            </plugin>
        </plugins>
    </build>
  
  
  
<!--nexus地址 获取依赖-->
    <repositories>
        <repository>
            <id>nexus</id>
            <name>Nexus Repository</name>
            <url>http://192.168.83.200:8081/repository/maven-public/</url>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
            <releases>
                <enabled>true</enabled>
            </releases>
        </repository>
    </repositories>
</project>
```

##### application.yml

```yml
spring:
  cloud:
    config:
      uri: http://localhost:8888
      name: token-eureka
      label: master
      profile: dev

```

##### application-prod.yml

```yml
spring:
  cloud:
    config:
      uri: http://localhost:8888
      name: token-eureka
      label: master
      profile: prod

```

##### EurekaApplication.java

```java
package com.aishang.token.eureka;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;

@SpringBootApplication
@EnableEurekaServer
public class EurekaApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaApplication.class, args);
    }
}
```



#### token-zipkin

##### pom

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>com.aishang</groupId>
        <artifactId>token-dependencies</artifactId>
        <version>1.0.0-SNAPSHOT</version>
        <relativePath>../token-dependencies/pom.xml</relativePath>
    </parent>

    <artifactId>token-zipkin</artifactId>
    <packaging>jar</packaging>

    <name>token-zipkin</name>

    <dependencies>
        <!-- Spring Boot Begin -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-tomcat</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <!-- Spring Boot End -->

        <!-- Spring Cloud Begin -->
        <!--zipkin ，如果打开把自己也加入链条追踪-->
        <!--<dependency>-->
            <!--<groupId>org.springframework.cloud</groupId>-->
            <!--<artifactId>spring-cloud-starter-zipkin</artifactId>-->
        <!--</dependency>-->
        <dependency>
            <groupId>io.zipkin.java</groupId>
            <artifactId>zipkin</artifactId>
        </dependency>
        <dependency>
            <groupId>io.zipkin.java</groupId>
            <artifactId>zipkin-server</artifactId>
            <exclusions>
                <exclusion>
                    <groupId>org.springframework.boot</groupId>
                    <artifactId>spring-boot-starter-log4j2</artifactId>
                </exclusion>
            </exclusions>
        </dependency>
        <dependency>
            <groupId>io.zipkin.java</groupId>
            <artifactId>zipkin-autoconfigure-ui</artifactId>
        </dependency>
        <!--分布式配置中心-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-config</artifactId>
        </dependency>
        <!--eureka服务器-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
        </dependency>
        <!-- Spring Cloud End -->
        <!--spring boot admin client-->
        <dependency>
            <groupId>org.jolokia</groupId>
            <artifactId>jolokia-core</artifactId>
        </dependency>
        <dependency>
            <groupId>de.codecentric</groupId>
            <artifactId>spring-boot-admin-starter-client</artifactId>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <mainClass>com.aishang.token.zipkin.ZipKinApplication</mainClass>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```

##### application.yml

```yml
spring:
  cloud:
    config:
      uri: http://localhost:8888
      name: token-zipkin
      label: master
      profile: dev
```

##### application-prod.yml

```yml
spring:
  cloud:
    config:
      uri: http://localhost:8888
      name: token-zipkin
      label: master
      profile: prod

```

##### ZipKinApplication.java

```java
package com.aishang.token.zipkin;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import zipkin.server.internal.EnableZipkinServer;

@SpringBootApplication
@EnableEurekaClient
@EnableZipkinServer
public class ZipKinApplication {
    public static void main(String[] args) {
        SpringApplication.run(ZipKinApplication.class, args);
    }
}
```

测试一下

启动顺序，cofig报错因为没有启动eureka，不用管

- config
- eureka
- zipkin

#### token-admin

##### pom

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>com.aishang</groupId>
        <artifactId>token-dependencies</artifactId>
        <version>1.0.0-SNAPSHOT</version>
        <relativePath>../token-dependencies/pom.xml</relativePath>
    </parent>

    <artifactId>token-admin</artifactId>
    <packaging>jar</packaging>

    <name>token-admin</name>

    <dependencies>
        <!-- Spring Boot Begin -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-tomcat</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-webflux</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <!--spring boot admin 服务端-->
        <dependency>
            <groupId>org.jolokia</groupId>
            <artifactId>jolokia-core</artifactId>
        </dependency>
        <dependency>
            <groupId>de.codecentric</groupId>
            <artifactId>spring-boot-admin-starter-server</artifactId>
        </dependency>

        <!-- Spring Cloud Begin -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-zipkin</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
        </dependency>
        <!-- Spring Cloud End -->


        <!--分布式配置中心-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-config</artifactId>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <mainClass>com.aishang.token.admin.TokenAdminApplication</mainClass>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```

##### application.yml

```yml
spring:
  cloud:
    config:
      uri: http://localhost:8888
      name: token-admin
      label: master
      profile: dev


```

##### TokenAdminApplication.java

```java
package com.aishang.token.admin;

import de.codecentric.boot.admin.server.config.EnableAdminServer;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;

@SpringBootApplication
@EnableEurekaClient
@EnableAdminServer
public class TokenAdminApplication {
    public static void main(String[] args) {
        SpringApplication.run(TokenAdminApplication.class, args);
    }
}

```

启动后报错，pipe不用管

#### token-zuul

##### pom

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>com.aishang</groupId>
        <artifactId>token-dependencies</artifactId>
        <version>1.0.0-SNAPSHOT</version>
        <relativePath>../token-dependencies/pom.xml</relativePath>
    </parent>

    <artifactId>token-zuul</artifactId>
    <packaging>jar</packaging>

    <name>token-zuul</name>

    <dependencies>
        <!-- Spring Boot Begin -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-tomcat</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <!-- Spring Boot End -->

        <!-- Spring Cloud Begin -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-zuul</artifactId>
        </dependency>
        <!-- Spring Cloud End -->

        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-zipkin</artifactId>
        </dependency>

        <dependency>
            <groupId>org.jolokia</groupId>
            <artifactId>jolokia-core</artifactId>
        </dependency>
        <dependency>
            <groupId>de.codecentric</groupId>
            <artifactId>spring-boot-admin-starter-client</artifactId>
        </dependency>


        <!--分布式配置中心-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-config</artifactId>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <mainClass>com.aishang.token.zuul.ZuulApplication</mainClass>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```

##### filter文件夹下创建类

##### LoginFilter.java

```java
package com.aishang.token.zuul.filter;
import com.netflix.zuul.ZuulFilter;
import com.netflix.zuul.context.RequestContext;
import com.netflix.zuul.exception.ZuulException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
@Component
public class LoginFilter extends ZuulFilter {

    private static final Logger logger = LoggerFactory.getLogger(LoginFilter.class);

    /**
     * 配置过滤类型，有四种不同生命周期的过滤器类型
     * 1. pre：路由之前
     * 2. routing：路由之时
     * 3. post：路由之后
     * 4. error：发送错误调用
     * @return
     */
    @Override
    public String filterType() {
        return "pre";
    }

    /**
     * 配置过滤的顺序
     * @return
     */
    @Override
    public int filterOrder() {
        return 0;
    }

    /**
     * 配置是否需要过滤：true/需要，false/不需要
     * @return
     */
    @Override
    public boolean shouldFilter() {
        return true;
    }

    /**
     * 过滤器的具体业务代码
     * @return
     * @throws ZuulException
     */
    @Override
    public Object run() throws ZuulException {
        RequestContext context = RequestContext.getCurrentContext();
        HttpServletRequest request = context.getRequest();
        String token = request.getParameter("token");
        if (token == null) {
            context.setSendZuulResponse(false);
            context.setResponseStatusCode(401);
            try {
                HttpServletResponse response = context.getResponse();
                response.setContentType("text/html;charset=utf-8");
                context.getResponse().getWriter().write("非法请求");
            } catch (IOException e) {
            }
        } else {
        }
        return null;
    }
}
```

##### ZuulApplication.java

```java
package com.aishang.token.zuul;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.cloud.netflix.zuul.EnableZuulProxy;

@SpringBootApplication
@EnableEurekaClient
@EnableZuulProxy
public class ZuulApplication {
    public static void main(String[] args) {
        SpringApplication.run(ZuulApplication.class, args);
    }
}
```

##### application.yml

```yml
spring:
  cloud:
    config:
      uri: http://localhost:8888
      name: token-zuul
      label: master
      profile: dev


```

#### 配置完毕

- 启动
  - config
  - eureka
  - zipkin
  - tokenAdmin
  - Zuul

# 三、部署到容器

目前五个服务，除了zuul路由网关，跟开发是没有关系的，是要开着运行就可以，开发的时候，提供者、消费者，其他模块等只要能连上尤里卡和分布式配置中心就可以了，就不用每次开发的时候单独启动它

- 停掉所有服务器

## 1、创建虚拟机

- spring-cloud

- Ssh root@192.168.0.103

- 安装docker，dock-compose

- 测试docker-compose -version

  ```sh
  cd /usr/local
  mkdir docker
  
  ```

- 虚拟机安装git

- ```sh
  
  ```

![SSH公钥_-_码云_Gitee_com](https://ws3.sinaimg.cn/large/006tNc79ly1g2xrnoyp0gj31f80u0q6j.jpg)



- cd /usr/local/docker

  ```sh
  git clone git@gitee.com:liujiang8800/token.git
  
  进入token/token-config
  
  要想生成jar包，需要java和maven
  ```

- yum install java-1.8.0-openjdk
- 安装Java1.8
- 按两次Y确认
- cd /usr/lib/jvm
- 进入安装目录

![image-20190126183822389](https://ws1.sinaimg.cn/large/006tNc79ly1fzk67j43rjj30de03eabe.jpg)

- vim /etc/profile
- 设置Java环境变量
- \#set java environment

```sh
 JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.212.b04-0.el7_6.x86_64
 JRE_HOME=$JAVA_HOME/jre
 CLASS_PATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar:$JRE_HOME/lib
 PATH=$PATH:$JAVA_HOME/bin:$JRE_HOME/bin
 
 export JAVA_HOME JRE_HOME CLASS_PATH PATH
```

source /etc/profile
 使配置生效

java -version
 查看Java版本

java

javac

**echo $JAVA_HOME**

![pastedGraphic.png](https://ws4.sinaimg.cn/large/006tNc79ly1fzk67tbnd6j30de022mxq.jpg)

- 安装maven

- yum install wget

  ```sh
  把maven的zip包传到服务器
  
  yum install -y unzip zip
  
  unzip 包
  
  
  
  配置环境变量
  vi /etc/profile
  
  
  export MAVEN_HOME=/usr/local/docker/apache-maven-3.6.1
  export PATH=${MAVEN_HOME}/bin:${PATH}
  
  source /etc/profile
  
  mvn -version
  
  
  
  添加阿里云的镜像地址
  vi /usr/share/apache-maven/conf/settings.xml
  修改下面节点
  <mirror>
    <id>alimaven</id>
    <name>aliyun maven</name>
    <url>http://maven.aliyun.com/nexus/content/groups/public/</url>
    <mirrorOf>central</mirrorOf>
  </mirror>
  配置仓库位置
  <localRepository>/cicro/var/m2/repo</localRepository>
  ```



## 2、修改配置文件

### 修改配置中心token-config

- 修改application-prod.yml

  ```yml
  spring:
    application:
      name: token-config
    cloud:
      config:
        label: master
        server:
          git:
            uri: https://gitee.com/liujiang8800/token
            search-paths: token-config/respo
            #注意这里的路径，对应仓库下的那个文件下的，才能找到配置文件
            username: 18104628800
            password: liujiang8800
    zipkin:
      base-url: http://192.168.0.103:9411
  
    boot:
      admin:
        client:
          url: http://192.168.0.103:8084
  server:
    port: 8888
  
  eureka:
    client:
      serviceUrl:
        defaultZone: http://192.168.0.103:8761/eureka/
  
  
    management:
      endpoint:
        health:
          show-details: always
      endpoints:
        web:
          exposure:
            include: health, info
  ```

  

### 修改eureka配置文件

Application.yml

```yml
spring:
  cloud:
    config:
      uri: http://192.168.0.103:8888
      name: token-eureka
      label: master
      profile: prod

```

提交一下

- 需要把这些项目打包jar，打包config，但是他依赖dependencies，需要把他上传到私服

- 部署dependencies

- dependencies的pom中添加

  ```sh
  <distributionManagement>
  	<repository>
    	<id>nexus-releases</id>
      <name>Nexus Release Repository</name>
      <url>http://192.168.83.200:8081/repository/maven-releases/</url>
    </repository>
    <snapshotRepository>
    	<id>nexus-releases</id>
      <name>Nexus snapshots Repository</name>
      <url>http://192.168.83.200:8081/repository/maven-snapshots/</url>
    </snapshotRepository>
  </distributionManagement>
  ```

  放在build节点外添加

- idea终端打开dependencies目录-mvn deploy![Browse_-_Nexus_Repository_Manager](https://ws3.sinaimg.cn/large/006tNc79ly1g2yosmts07j31b20lgmzz.jpg)

- 成功，那么其他项目都需要这个私服地址

- 配置依赖到pom文件中，config添加

  ```xml
  <!--要去找nexus的dependencies的地址-->
      <repositories>
          <repository>
              <id>nexus</id>
              <name>Nexus Repository</name>
              <url>http://192.168.0.100:8081/repository/maven-public/</url>
              <snapshots>
                  <enabled>true</enabled>
              </snapshots>
              <releases>
                  <enabled>true</enabled>
              </releases>
          </repository>
      </repositories>
  ```

- 上传后，在虚拟机中token-config目录下先拉取下刚才的代码
- git pull
- mvn clean package
- 进入target
- java -jar token….jar
- 过程中报错不用管，因为配置文件ip地址没有改，用的是localhost
- ![liujiang_—_root_localhost__usr_local_docker_token_token-config_target_—_ssh_root_192_168_0_100_—_92×24](https://ws3.sinaimg.cn/large/006tNc79ly1g2ypm9cd1qj31900pogs5.jpg)

- 访问测试，192.168.0.100:8888/token-eureka/dev/master
- ![192_168_0_100_8888_token-eureka_dev_master](https://ws1.sinaimg.cn/large/006tNc79ly1g2ypy7n5voj31br0u0wmm.jpg)

- 正常访问，停掉

- 自定义一个docker镜像

- 要把这个jar放进docker-file

- 在token-config目录下创建docker文件夹

- 把jar包复制到此文件夹

- cp ../target/token-config-1.0.0-SNAPSHOT.jar .

- vi Dockerfile

  ```dockerfile
  FROM openjdk:8-jre
  
  RUN mkdir /app
  
  COPY token-config-1.0.0-SNAPSHOT.jar /app/
  
  CMD java -jar /app/token-config-1.0.0-SNAPSHOT.jar --spring.profiles.active=prod
  
  EXPOSE 8888
  ```

- docker info

- docker build -t 192.168.83.200:5000/token-config .

- 运行测试

  ```sh
  docker run -p 8888:8888 192.168.83.200:5000/token-config
  
  
  访问测试，192.168.83.200:8888/token-eureka/dev/master
  ```

  

### 修改token-config下respo的token-eureka-prod.yml

token-eureka-prod.yml

```yml
spring:
  application:
    name: token-eureka
    #给项目起名，服务注册与发现，别人通过项目名找到服务
  zipkin:
    base-url: http://192.168.83.200:9411

  boot:
    admin:
      client:
        url: http://192.168.83.200:8084
  server:
    port: 8761

  eureka:
    instance:
      hostname: host
    client:
      #改成true表示是否将自己注册到eureka，因为要构建集群环境，需要将自己注册到集群，所以应该开启
      registerWithEureka: true
      #表示是否从eureka获取注册信息，如果是单一节点，不需要同步其他尤里卡节点，则可以false，但此处是集群，应该设置为true
      fetchRegistry: true
      #上面两句改为false代表是服务端，否则是客户端
      serviceUrl:
        defaultZone: http://192.168.83.200:8761/eureka/,http://192.168.83.200:8861/eureka/,http://192.168.83.200:8961/eureka/
        #defaultZone: http://ip:${server.port}/eureka/,http://ip:${server.port}/eureka/,http://ip:${server.port}/eureka/
        #ip到时候改成集群的地址，目前只是个案例
        #尤里卡访问地址


  management:
    endpoint:
      health:
        show-details: always
    endpoints:
      web:
        exposure:
          include: health, info
```

- 提交代码

- 在token-config目录在拉去代码git pull

- 修改token-eureka的pom及yml文件，在pom中添加

  ```xml
  
  <!--nexus地址 获取依赖-->
      <repositories>
          <repository>
              <id>nexus</id>
              <name>Nexus Repository</name>
              <url>http://192.168.83.200:8081/repository/maven-public/</url>
              <snapshots>
                  <enabled>true</enabled>
              </snapshots>
              <releases>
                  <enabled>true</enabled>
              </releases>
          </repository>
      </repositories>
  ```

  - 修改yml

    ```yml
    application.yml
    
    spring:
      cloud:
        config:
          uri: http://192.168.83.200:8888
          name: token-eureka
          label: master
          profile: prod
    
    
    
    application-prod.yml
    
    spring:
      cloud:
        config:
          uri: http://192.168.83.200:8888
          name: token-eureka
          label: master
          profile: prod
    
    ```

    - 提交代码

- 切换到token-eureka目录

- mvn clean package

- 自定义一个docker镜像
- 要把这个jar放进docker-file
- 在token-eureka目录下创建docker文件夹
- 把jar包复制到此文件夹
- cp target/token-eureka-1.0.0-SNAPSHOT.jar ./docker/

- 把尤里卡上传到私服镜像

- 回到token-config目录创建 vi docker-compose.yml,因为要启动config容器，

  ```sh
  私服必须有这个镜像,如果没有执行下面命令
  docker tag 192.168.83.200:5000/token-config 192.168.83.200:5000/token-config
  docker push 192.168.83.200:5000/token-config
  ```

  

  ```yml
  version: '3.1'
  services:
    token-config:
      restart: always
      image: 192.168.83.200:5000/token-config
      container_name: token-config
      ports:
       - 8888:8888
   
  ```

- docker-compose up -d

- 再回到token-eureka/docker

- vi Dockerfile

  ```dockerfile
  FROM openjdk:8-jre
  
  RUN mkdir /app
  
  COPY token-eureka-1.0.0-SNAPSHOT.jar /app/
  
  CMD java -jar /app/token-eureka-1.0.0-SNAPSHOT.jar --spring.profiles.active=prod
  
  EXPOSE 8761
  ```

- docker build -t 192.168.83.200:5000/token-eureka .

- docker tag 192.168.83.200:5000/token-eureka 192.168.83.200:5000/token-eureka

- docker push 192.168.83.200:5000/token-eureka

- 创建 vi docker-compose.yml   启动集群模式

  ```yml
  version: '3.1'
  services:
    token-eureka-1:
      restart: always
      image: 192.168.83.200:5000/token-eureka
      container_name: token-eureka-1
      ports:
       - 8761:8761
    token-eureka-2:
      restart: always
      image: 192.168.83.200:5000/token-eureka
      container_name: token-eureka-2
      ports:
       - 8861:8761
    token-eureka-3:
      restart: always
      image: 192.168.83.200:5000/token-eureka
      container_name: token-eureka-3
      ports:
       - 8961:8761
  ```

  ports：左边是本机的，右面是容器的

  - 注意：配置服务器的默认端口为8888，如果修改了默认端口，则客户端项目就不能存在application.yml或properties文件中配置spring.cloud.config.uri,必须在bootstrap.yml或是bootstrap.preoperties中配置。
  - 原因是bootstrap开头的文件会被优先加载和配置，切记

- 把尤里卡和config的配置文件，改名为bootstrap

- 之后上传代码，虚拟机在git pull 完事在重新打包，在启动上传镜像，启动容器。。。

- docker-compose up -d

  ![liujiang_—_root_bogon__usr_local_docker_token_token-eureka_docker_—_ssh_root_192_168_83_200_—_204×39](https://ws1.sinaimg.cn/large/006tNc79ly1g3041ikyh7j32aq0bi46b.jpg)

- 测试，访问

  ```sh
  192.168.83.200:8761
  192.168.83.200:8861
  192.168.83.200:8961
  ```

  

### 修改token-zipkin

Token-zipkin

bootstrap-prod.yml

```yml
spring:
  cloud:
    config:
      uri: http://192.168.83.200:8888
      name: token-zipkin
      label: master
      profile: prod


```

bootstrap.yml

```yml
spring:
  cloud:
    config:
      uri: http://1ocalhost:8888
      name: token-zipkin
      label: master
      profile: dev


```

![Run_Debug_Configurations_和_token____Documents_IDEA_token__-_____token-config_respo_token-zipkin-prod_yml__token-config_](https://ws4.sinaimg.cn/large/006tNc79ly1g30ya8xzykj31ab0u0n18.jpg)

如果是本地运行，默认执行dev，但是是localhost，所以需要在启动的时候，传参，或者改ip

token-config

token-zipkin-prod.yml

```yml
spring:
  application:
    name: token-zipkin
  boot:
    admin:
      client:
        url: http://192.168.83.200:8084

server:
  port: 9411

eureka:
  client:
    serviceUrl:
      defaultZone: http://192.168.83.200:8761/eureka/,http://192.168.83.200:8861/eureka/,http://192.168.83.200:8961/eureka/

management:
  metrics:
    web:
      server:
        auto-time-requests: false
  endpoint:
    health:
      show-details: always
  endpoints:
    web:
      exposure:
        include: health, info
```

- 上传代码

- idean启动zipkin
- 访问zipkin，刷新eureka成功

测试成功：

- 把剩下服务部署到服务器
- 继续修改zipkin

pom中添加

```xml
<!--nexus地址 获取依赖-->
    <repositories>
        <repository>
            <id>nexus</id>
            <name>Nexus Repository</name>
            <url>http://192.168.83.200:8081/repository/maven-public/</url>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
            <releases>
                <enabled>true</enabled>
            </releases>
        </repository>
    </repositories>
```

- vi Dockfile

  ```sh
  FROM openjdk:8-jre
  
  RUN mkdir /app
  
  COPY token-zipkin-1.0.0-SNAPSHOT.jar /app/
  
  CMD java -jar /app/token-zipkin-1.0.0-SNAPSHOT.jar --spring.profiles.active=prod
  
  EXPOSE 9411
  ```

- vi docker-compose.yml

  ```yml
  version: '3.1'
  services:
    token-zipkin:
      restart: always
      image: 192.168.83.200:5000/token-zipkin
      container_name: token-zipkin
      ports:
       - 9411:9411
  ```

```sh
docker build -t 192.168.83.200:5000/token-zipkin .


http://192.168.83.200:9411/zipkin/
```

### 修改token-admin

pom

```xml
<!--nexus地址 获取依赖-->
    <repositories>
        <repository>
            <id>nexus</id>
            <name>Nexus Repository</name>
            <url>http://192.168.83.200:8081/repository/maven-public/</url>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
            <releases>
                <enabled>true</enabled>
            </releases>
        </repository>
    </repositories>
```

- 修改为bootstrap.yml

  ```yml
  spring:
    cloud:
      config:
        uri: http://localhost:8888
        name: token-admin
        label: master
        profile: dev
  
  
  ```

  

- 修改bootstrap-prod.yml

  ```yml
  spring:
    cloud:
      config:
        uri: http://192.168.83.200:8888
        name: token-admin
        label: master
        profile: prod
  
  
  ```

- token-admin-dev.yml

  ```yml
  spring:
    application:
      name: token-admin
    zipkin:
      base-url: http://192.168.83.200:9411
  
  server:
    port: 8084
  
  management:
    endpoint:
      health:
        show-details: always
    endpoints:
      web:
        exposure:
          include: health, info
  #        include: *
  #incule还有其他功能，可以直接*   原来include: ["health", "info"]这么写在这里报错
  #所有的配置里都要添加这段，因为都需要监控
  eureka:
    client:
      serviceUrl:
        defaultZone: http://192.168.83.200:8761/eureka/,http://192.168.83.200:8861/eureka/,http://192.168.83.200:8961/eureka/
  ```

- Token-config

- token-admin-prod.yml

  ```yml
  spring:
    application:
      name: token-admin
    zipkin:
      base-url: http://192.168.83.200:9411
  
  server:
    port: 8084
  
  management:
    endpoint:
      health:
        show-details: always
    endpoints:
      web:
        exposure:
          include: health, info
  #        include: *
  #incule还有其他功能，可以直接*   原来include: ["health", "info"]这么写在这里报错
  #所有的配置里都要添加这段，因为都需要监控
  eureka:
    client:
      serviceUrl:
        defaultZone: http://192.168.83.200:8761/eureka/,http://192.168.83.200:8861/eureka/,http://192.168.83.200:8961/eureka/
  ```

- vi Dockerfile

  ```sh
  FROM openjdk:8-jre
  
  RUN mkdir /app
  
  COPY token-admin-1.0.0-SNAPSHOT.jar /app/
  
  CMD java -jar /app/token-admin-1.0.0-SNAPSHOT.jar --spring.profiles.active=prod
  
  EXPOSE 8084
  ```

- docker build -t 192.168.83.200:5000/token-admin .

- vi docker-compose.yml

  ```yml
  version: '3.1'
  services:
    token-admin:
      restart: always
      image: 192.168.83.200:5000/token-admin
      container_name: token-admin
      ports:
       - 8084:8084
  ```

  ```sh
  http://192.168.83.200:8084
  ```

  

### 修改token-zuul

bootstrap-prod.yml

```yml
spring:
  cloud:
    config:
      uri: http://192.168.83.200:8888
      name: token-zuul
      label: master
      profile: prod


```

token-zuul-prod.yml

```yml
spring:
  application:
    name: token-zuul
  zipkin:
    base-url: http://192.168.83.200:9411
  boot:
    admin:
      client:
        url: http://192.168.83.200:8084


server:
  port: 8769

eureka:
  client:
    serviceUrl:
      defaultZone: http://192.168.83.200:8761/eureka/,http://192.168.83.200:8861/eureka/,http://192.168.83.200:8961/eureka/

zuul:
  routes:
    api-a:
      path: /api/ribbon/**
      serviceId: token-consumer-ribbon
    api-b:
      path: /api/feign/**
      serviceId: token-consumer-feign

management:
  endpoint:
    health:
      show-details: always
  endpoints:
    web:
      exposure:
        include: health, info
```

- mvn clean package

- vi Dockerfile

  ```sh
  FROM openjdk:8-jre
  
  RUN mkdir /app
  
  COPY token-zuul-1.0.0-SNAPSHOT.jar /app/
  
  CMD java -jar /app/token-zuul-1.0.0-SNAPSHOT.jar --spring.profiles.active=prod
  
  EXPOSE 8769
  ```

- docker build -t 192.168.83.200:5000/token-zuul .

- vi docker-compose.yml

  ```yml
  version: '3.1'
  services:
    token-zuul:
      restart: always
      image: 192.168.83.200:5000/token-zuul
      container_name: token-zuul
      ports:
       - 8769:8769
  ```

  ```sh
  docker-compose up 
  http://192.168.83.200:8769/api/feign/message=token
  ```

## token的docker-compose.yml

```yml
version: '3.1'
services:
  token-config:
    restart: always
    image: 192.168.83.200:5000/token-config
    container_name: token-config
    ports:
     - 8888:8888
  token-eureka-1:
    restart: always
    image: 192.168.83.200:5000/token-eureka
    container_name: token-eureka-1
    ports:
     - 8761:8761
  token-eureka-2:
    restart: always
    image: 192.168.83.200:5000/token-eureka
    container_name: token-eureka-2
    ports:
     - 8861:8761
  token-eureka-3:
    restart: always
    image: 192.168.83.200:5000/token-eureka
    container_name: token-eureka-3
    ports:
     - 8961:8761
  token-zipkin:
    restart: always
    image: 192.168.83.200:5000/token-zipkin
    container_name: token-zipkin
    ports:
     - 9411:9411
  token-admin:
    restart: always
    image: 192.168.83.200:5000/token-admin
    container_name: token-admin
    ports:
     - 8084:8084
  token-zuul:
    restart: always
    image: 192.168.83.200:5000/token-zuul
    container_name: token-zuul
    ports:
     - 8769:8769
```



```sh
http://192.168.83.200:8081        												nexus
http://192.168.83.200:8888/token-eureka/dev/master        config  
http://192.168.83.200:8761/																eureka1
http://192.168.83.200:8861/																eureka2
http://192.168.83.200:8961/																eureka3
http://192.168.83.200:9411/																zipkin
http://192.168.83.200:8084/																admin

```



### 问题

- 目前需要把所有服务部署到容器
- 上传代码
- 虚拟机git代码
- mvn clean package
- 构建镜像
- 上传私服
- 启动
- 很麻烦，所以需要持续集成，把手动变成自动，自动化运维

- jenkins+docker+码云

# 四、服务提供者与服务消费者

需要在建一个项目token-backview，把后面所有需要显示的页面，聚合到这个项目里，访问时有zuul分发

- token-view-backview

  - zuul

    - token-userview
    - token-productview

    

## 1、服务提供者

主依赖pom

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.0.2.RELEASE</version>
    </parent>

    <groupId>com.aishang</groupId>
    <artifactId>token-dependencies</artifactId>
    <version>1.0.0-SNAPSHOT</version>
    <packaging>pom</packaging>

    <name>token-dependencies</name>

    <properties>
        <!-- Environment Settings -->
        <java.version>1.8</java.version>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>

        <!-- Spring Settings -->
        <spring-cloud.version>Finchley.RELEASE</spring-cloud.version>

        <!--zipkin-->
        <zipkin.version>2.10.1</zipkin.version>
        <!--spring boot admin-->
        <codecentric.version>2.0.2</codecentric.version>
        <!--druid-->
        <druid.version>1.1.10</druid.version>
        <!--mysql-->
        <mysql.version>5.1.46</mysql.version>


        <tk.mybatis.version>2.0.2</tk.mybatis.version>
        <pagehelper.version>1.2.5</pagehelper.version>
        <fastjson.version>1.2.54</fastjson.version>
    </properties>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${spring-cloud.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            <!--zipkin-->
            <dependency>
                <groupId>io.zipkin.java</groupId>
                <artifactId>zipkin</artifactId>
                <version>${zipkin.version}</version>
            </dependency>
            <dependency>
                <groupId>io.zipkin.java</groupId>
                <artifactId>zipkin-server</artifactId>
                <version>${zipkin.version}</version>
            </dependency>
            <dependency>
                <groupId>io.zipkin.java</groupId>
                <artifactId>zipkin-autoconfigure-ui</artifactId>
                <version>${zipkin.version}</version>
            </dependency>
            <!--spring boot admin server-->
            <dependency>
                <groupId>de.codecentric</groupId>
                <artifactId>spring-boot-admin-starter-server</artifactId>
                <version>${codecentric.version}</version>
            </dependency>
            <!--spring boot admin client-->
            <dependency>
                <groupId>de.codecentric</groupId>
                <artifactId>spring-boot-admin-starter-client</artifactId>
                <version>${codecentric.version}</version>
            </dependency>
            <!--druid-->
            <dependency>
                <groupId>com.alibaba</groupId>
                <artifactId>druid-spring-boot-starter</artifactId>
                <version>${druid.version}</version>
            </dependency>
            <!--mysql-->
            <dependency>
                <groupId>mysql</groupId>
                <artifactId>mysql-connector-java</artifactId>
                <version>${mysql.version}</version>
            </dependency>
            <!--代替mybatis-->
            <dependency>
                <groupId>tk.mybatis</groupId>
                <artifactId>mapper-spring-boot-starter</artifactId>
                <version>${tk.mybatis.version}</version>
            </dependency>
            <!--pageHelper-->
            <dependency>
                <groupId>com.github.pagehelper</groupId>
                <artifactId>pagehelper-spring-boot-starter</artifactId>
                <version>${pagehelper.version}</version>
            </dependency>
            <!--fastjson-->
            <dependency>
                <groupId>com.alibaba</groupId>
                <artifactId>fastjson</artifactId>
                <version>${fastjson.version}</version>
            </dependency>
        </dependencies>

    </dependencyManagement>

    <build>
        <plugins>
            <!-- Compiler 插件, 设定 JDK 版本 -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <configuration>
                    <showWarnings>true</showWarnings>
                </configuration>
            </plugin>

            <!-- 打包 jar 文件时，配置 manifest 文件，加入 lib 包的 jar 依赖 -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-jar-plugin</artifactId>
                <configuration>
                    <archive>
                        <addMavenDescriptor>false</addMavenDescriptor>
                    </archive>
                </configuration>
                <executions>
                    <execution>
                        <configuration>
                            <archive>
                                <manifest>
                                    <!-- Add directory entries -->
                                    <addDefaultImplementationEntries>true</addDefaultImplementationEntries>
                                    <addDefaultSpecificationEntries>true</addDefaultSpecificationEntries>
                                    <addClasspath>true</addClasspath>
                                </manifest>
                            </archive>
                        </configuration>
                    </execution>
                </executions>
            </plugin>

            <!-- resource -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-resources-plugin</artifactId>
            </plugin>

            <!-- install -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-install-plugin</artifactId>
            </plugin>

            <!-- clean -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-clean-plugin</artifactId>
            </plugin>

            <!-- ant -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-antrun-plugin</artifactId>
            </plugin>

            <!-- dependency -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-dependency-plugin</artifactId>
            </plugin>
        </plugins>

        <pluginManagement>
            <plugins>
                <!-- Java Document Generate -->
                <plugin>
                    <groupId>org.apache.maven.plugins</groupId>
                    <artifactId>maven-javadoc-plugin</artifactId>
                    <executions>
                        <execution>
                            <phase>prepare-package</phase>
                            <goals>
                                <goal>jar</goal>
                            </goals>
                        </execution>
                    </executions>
                </plugin>

                <!-- YUI Compressor (CSS/JS压缩) -->
                <plugin>
                    <groupId>net.alchim31.maven</groupId>
                    <artifactId>yuicompressor-maven-plugin</artifactId>
                    <version>1.5.1</version>
                    <executions>
                        <execution>
                            <phase>prepare-package</phase>
                            <goals>
                                <goal>compress</goal>
                            </goals>
                        </execution>
                    </executions>
                    <configuration>
                        <encoding>UTF-8</encoding>
                        <jswarn>false</jswarn>
                        <nosuffix>true</nosuffix>
                        <linebreakpos>30000</linebreakpos>
                        <force>true</force>
                        <includes>
                            <include>**/*.js</include>
                            <include>**/*.css</include>
                        </includes>
                        <excludes>
                            <exclude>**/*.min.js</exclude>
                            <exclude>**/*.min.css</exclude>
                        </excludes>
                    </configuration>
                </plugin>
            </plugins>
        </pluginManagement>

        <!-- 资源文件配置 -->
        <resources>
            <resource>
                <directory>src/main/java</directory>
                <excludes>
                    <exclude>**/*.java</exclude>
                </excludes>
            </resource>
            <resource>
                <directory>src/main/resources</directory>
            </resource>
        </resources>
    </build>

    <!--nexus-->
    <distributionManagement>
        <repository>
            <id>nexus-releases</id>
            <name>Nexus Release Repository</name>
            <url>http://192.168.83.200:8081/repository/maven-releases/</url>
        </repository>
        <snapshotRepository>
            <id>nexus-releases</id>
            <name>Nexus snapshots Repository</name>
            <url>http://192.168.83.200:8081/repository/maven-snapshots/</url>
        </snapshotRepository>
    </distributionManagement>

    <repositories>
        <repository>
            <id>nexus</id>
            <name>Nexus Repository</name>
            <url>http://192.168.0.100:8081/repository/maven-public/</url>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
            <releases>
                <enabled>true</enabled>
            </releases>
        </repository>
        <repository>
            <id>aliyun-repos</id>
            <name>Aliyun Repository</name>
            <url>http://maven.aliyun.com/nexus/content/groups/public</url>
            <releases>
                <enabled>true</enabled>
            </releases>
            <snapshots>
                <enabled>false</enabled>
            </snapshots>
        </repository>

        <repository>
            <id>sonatype-repos</id>
            <name>Sonatype Repository</name>
            <url>https://oss.sonatype.org/content/groups/public</url>
            <releases>
                <enabled>true</enabled>
            </releases>
            <snapshots>
                <enabled>false</enabled>
            </snapshots>
        </repository>
        <repository>
            <id>sonatype-repos-s</id>
            <name>Sonatype Repository</name>
            <url>https://oss.sonatype.org/content/repositories/snapshots</url>
            <releases>
                <enabled>false</enabled>
            </releases>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>

        <repository>
            <id>spring-snapshots</id>
            <name>Spring Snapshots</name>
            <url>https://repo.spring.io/snapshot</url>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
        <repository>
            <id>spring-milestones</id>
            <name>Spring Milestones</name>
            <url>https://repo.spring.io/milestone</url>
            <snapshots>
                <enabled>false</enabled>
            </snapshots>
        </repository>
    </repositories>

    <pluginRepositories>
        <pluginRepository>
            <id>aliyun-repos</id>
            <name>Aliyun Repository</name>
            <url>http://maven.aliyun.com/nexus/content/groups/public</url>
            <releases>
                <enabled>true</enabled>
            </releases>
            <snapshots>
                <enabled>false</enabled>
            </snapshots>
        </pluginRepository>
    </pluginRepositories>
</project>
```



token-service-provider

pom

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>com.aishang</groupId>
        <artifactId>token-dependencies</artifactId>
        <version>1.0.0-SNAPSHOT</version>
        <relativePath>../token-dependencies/pom.xml</relativePath>
    </parent>

    <artifactId>token-service-provider</artifactId>
    <packaging>jar</packaging>

    <name>token-service-provider</name>

    <dependencies>
        <dependency>
            <groupId>com.aishang</groupId>
            <artifactId>token-provider-common</artifactId>
            <version>${project.version}</version>
        </dependency>
    </dependencies>
    <!--nexus地址 获取依赖-->
    <repositories>
        <repository>
            <id>nexus</id>
            <name>Nexus Repository</name>
            <url>http://192.168.83.200:8081/repository/maven-public/</url>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
            <releases>
                <enabled>true</enabled>
            </releases>
        </repository>
    </repositories>
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <mainClass>com.aishang.token.service.provider.ProviderApplication</mainClass>
                </configuration>
            </plugin>
          
          <plugin>
            <groupId>org.mybatis.generator</groupId>
            <artifactId>mybatis-generator-maven-plugin</artifactId>
            <version>1.3.5</version>
            <configuration>
                <configurationFile>${basedir}/src/main/resources/generator/generatorConfig.xml</configurationFile>
                <overwrite>true</overwrite>
                <verbose>true</verbose>
            </configuration>
            <dependencies>
                <dependency>
                    <groupId>mysql</groupId>
                    <artifactId>mysql-connector-java</artifactId>
                    <version>${mysql.version}</version>
                </dependency>
                <dependency>
                    <groupId>tk.mybatis</groupId>
                    <artifactId>mapper</artifactId>
                    <version>3.4.4</version>
                </dependency>
            </dependencies>
        </plugin>
        </plugins>
    </build>
</project>
```

```java
package com.aishang.token.service.provider;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;

@SpringBootApplication
@EnableEurekaClient//服务提供者
public class ProviderApplication {
    public static void main(String[] args) {
        SpringApplication.run(ProviderApplication.class,args);
    }
}
```

bootstrap.yml

```yml
spring:
  cloud:
    config:
      uri: http://localhost:8888
      name: token-service-provider
      label: master
      profile: dev
#默认启动此文件的配置，先去云服务器，就是码云仓库，找token-eureka文件开头-dev的配置文件
```



bootstrap-prod.yml

```yml
spring:
  cloud:
    config:
      uri: http://192.168.83.200:8888
      name: token-service-provider
      label: master
      profile: prod

```

Token-config新建两个配置文件

token-service-provider-dev.yml

```yml
spring:
  application:
    name: token-service-provider
    #给项目起名，服务注册与发现，别人通过项目名找到服务
  zipkin:
    base-url: http://localhost:9411

  boot:
    admin:
      client:
        url: http://localhost:8084
  datasource:
    druid:
      url: jdbc:mysql://localhost:3306/token-service-provider?useUnicode=true&characterEncoding=utf-8&useSSL=false
      username: root
      password: password
      initial-size: 1
      min-idle: 1
      max-active: 20
      test-on-borrow: true
      # MySQL 8.x: com.mysql.cj.jdbc.Driver
      driver-class-name: com.mysql.jdbc.Driver


mybatis:
  type-aliases-package: com.aishang.token.service.provider.pojo
  mapper-locations: classpath:mapper/*.xml

server:
  port: 8501

eureka:
  client:
    serviceUrl:
      defaultZone: http://localhost:8761/eureka/


management:
  endpoint:
    health:
      show-details: always
  endpoints:
    web:
      exposure:
        include: health, info
```



token-service-provider-prod.yml

```yml
spring:
  application:
    name: token-service-provider
    #给项目起名，服务注册与发现，别人通过项目名找到服务
  zipkin:
    base-url: http://192.168.83.200:9411

  boot:
    admin:
      client:
        url: http://192.168.83.200:8084
server:
  port: 8761

eureka:
  instance:
    hostname: 192.168.83.200
  client:
#    registerWithEureka: true
#    fetchRegistry: true
    #上面两句改为false代表是服务端，否则是客户端
    serviceUrl:
      defaultZone: http://192.168.83.200:8761/eureka/,http://192.168.83.200:8861/eureka/,http://192.168.83.200:8961/eureka/
      #尤里卡访问地址


management:
  endpoint:
    health:
      show-details: always
  endpoints:
    web:
      exposure:
        include: health, info
```

提供者需要配置mybatis

修改token-dependencise的pom文件

添加

```
<!--druid-->
<druid.version>1.1.10</druid.version>
```

```xml
   

<!--druid-->
            <dependency>
                <groupId>com.alibaba</groupId>
                <artifactId>druid-spring-boot-starter</artifactId>
                <version>${druid.version}</version>
            </dependency>
```

```
<!--mysql-->
<mysql.version>5.1.46</mysql.version>
```

```
<!--mysql-->
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <version>${mysql.version}</version>
</dependency>
```

yml

```yml
spring:
  datasource:
    druid:
      url: jdbc:mysql://localhost:3306/token-service-provider?useUnicode=true&characterEncoding=utf-8&useSSL=false
      username: root
      password: password
      initial-size: 1
      min-idle: 1
      max-active: 20
      test-on-borrow: true
      # MySQL 8.x: com.mysql.cj.jdbc.Driver
      driver-class-name: com.mysql.cj.jdbc.Driver
```

服务所需数据库脚本

```sql
/*
SQLyog  v12.2.6 (64 bit)
MySQL - 5.7.22 : Database - token-service-provider
*********************************************************************
*/


/*!40101 SET NAMES utf8 */;

/*!40101 SET SQL_MODE=''*/;

/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;
CREATE DATABASE /*!32312 IF NOT EXISTS*/`token-service-provider` /*!40100 DEFAULT CHARACTER SET utf8mb4 */;

USE `token-service-provider`;

DROP TABLE IF EXISTS tb_sys_user;

-- 管理员表
CREATE TABLE tb_sys_user
(
	user_code varchar(100) NOT NULL COMMENT '用户编码',
	login_code varchar(100) NOT NULL COMMENT '登录账号',
	user_name varchar(100) NOT NULL COMMENT '用户昵称',
	password varchar(100) NOT NULL COMMENT '登录密码',
	email varchar(300) COMMENT '电子邮箱',
	mobile varchar(100) COMMENT '手机号码',
	phone varchar(100) COMMENT '办公电话',
	sex char(1) COMMENT '用户性别',
	avatar varchar(1000) COMMENT '头像路径',
	sign varchar(200) COMMENT '个性签名',
	wx_openid varchar(100) COMMENT '绑定的微信号',
	mobile_imei varchar(100) COMMENT '绑定的手机串号',
	user_type varchar(16) NOT NULL COMMENT '用户类型',
	ref_code varchar(64) COMMENT '用户类型引用编号',
	ref_name varchar(100) COMMENT '用户类型引用姓名',
	mgr_type char(1) NOT NULL COMMENT '管理员类型（0非管理员 1系统管理员  2二级管理员）',
	pwd_security_level decimal(1) COMMENT '密码安全级别（0初始 1很弱 2弱 3安全 4很安全）',
	pwd_update_date datetime COMMENT '密码最后更新时间',
	pwd_update_record varchar(1000) COMMENT '密码修改记录',
	pwd_question varchar(200) COMMENT '密保问题',
	pwd_question_answer varchar(200) COMMENT '密保问题答案',
	pwd_question_2 varchar(200) COMMENT '密保问题2',
	pwd_question_answer_2 varchar(200) COMMENT '密保问题答案2',
	pwd_question_3 varchar(200) COMMENT '密保问题3',
	pwd_question_answer_3 varchar(200) COMMENT '密保问题答案3',
	pwd_quest_update_date datetime COMMENT '密码问题修改时间',
	last_login_ip varchar(100) COMMENT '最后登陆IP',
	last_login_date datetime COMMENT '最后登陆时间',
	freeze_date datetime COMMENT '冻结时间',
	freeze_cause varchar(200) COMMENT '冻结原因',
	user_weight decimal(8) DEFAULT 0 COMMENT '用户权重（降序）',
	status char NOT NULL COMMENT '状态（0正常 1删除 2停用 3冻结）',
	create_by varchar(64) NOT NULL COMMENT '创建者',
	create_date datetime NOT NULL COMMENT '创建时间',
	update_by varchar(64) NOT NULL COMMENT '更新者',
	update_date datetime NOT NULL COMMENT '更新时间',
	remarks varchar(500) COMMENT '备注信息',
	corp_code varchar(64) DEFAULT '0' NOT NULL COMMENT '归属集团Code',
	corp_name varchar(100) DEFAULT 'iToken' NOT NULL COMMENT '归属集团Name',
	extend_s1 varchar(500) COMMENT '扩展 String 1',
	extend_s2 varchar(500) COMMENT '扩展 String 2',
	extend_s3 varchar(500) COMMENT '扩展 String 3',
	extend_s4 varchar(500) COMMENT '扩展 String 4',
	extend_s5 varchar(500) COMMENT '扩展 String 5',
	extend_s6 varchar(500) COMMENT '扩展 String 6',
	extend_s7 varchar(500) COMMENT '扩展 String 7',
	extend_s8 varchar(500) COMMENT '扩展 String 8',
	extend_i1 decimal(19) COMMENT '扩展 Integer 1',
	extend_i2 decimal(19) COMMENT '扩展 Integer 2',
	extend_i3 decimal(19) COMMENT '扩展 Integer 3',
	extend_i4 decimal(19) COMMENT '扩展 Integer 4',
	extend_f1 decimal(19,4) COMMENT '扩展 Float 1',
	extend_f2 decimal(19,4) COMMENT '扩展 Float 2',
	extend_f3 decimal(19,4) COMMENT '扩展 Float 3',
	extend_f4 decimal(19,4) COMMENT '扩展 Float 4',
	extend_d1 datetime COMMENT '扩展 Date 1',
	extend_d2 datetime COMMENT '扩展 Date 2',
	extend_d3 datetime COMMENT '扩展 Date 3',
	extend_d4 datetime COMMENT '扩展 Date 4',
	PRIMARY KEY (user_code)
) COMMENT = '用户表';

CREATE INDEX idx_sys_user_lc ON tb_sys_user (login_code ASC);
CREATE INDEX idx_sys_user_email ON tb_sys_user (email ASC);
CREATE INDEX idx_sys_user_mobile ON tb_sys_user (mobile ASC);
CREATE INDEX idx_sys_user_wo ON tb_sys_user (wx_openid ASC);
CREATE INDEX idx_sys_user_imei ON tb_sys_user (mobile_imei ASC);
CREATE INDEX idx_sys_user_rt ON tb_sys_user (user_type ASC);
CREATE INDEX idx_sys_user_rc ON tb_sys_user (ref_code ASC);
CREATE INDEX idx_sys_user_mt ON tb_sys_user (mgr_type ASC);
CREATE INDEX idx_sys_user_us ON tb_sys_user (user_weight ASC);
CREATE INDEX idx_sys_user_ud ON tb_sys_user (update_date ASC);
CREATE INDEX idx_sys_user_status ON tb_sys_user (status ASC);
CREATE INDEX idx_sys_user_cc ON tb_sys_user (corp_code ASC);
```

mybatis的存放路径，云配置文件

```yml
spring:
  application:
    name: token-service-provider
    #给项目起名，服务注册与发现，别人通过项目名找到服务
  zipkin:
    base-url: http://localhost:9411

  boot:
    admin:
      client:
        url: http://localhost:8084
  datasource:
    druid:
      url: jdbc:mysql://localhost:3306/token-service-provider?useUnicode=true&characterEncoding=utf-8&useSSL=false
      username: root
      password: password
      initial-size: 1
      min-idle: 1
      max-active: 20
      test-on-borrow: true
      # MySQL 8.x: com.mysql.cj.jdbc.Driver
      driver-class-name: com.mysql.jdbc.Driver


mybatis:
  type-aliases-package: com.aishang.token.service.provider.pojo
  mapper-locations: classpath:mapper/*.xml

server:
  port: 8501

eureka:
  client:
    registerWithEureka: false
    fetchRegistry: false
    #上面两句改为false代表是服务端，否则是客户端
    serviceUrl:
      defaultZone: http://localhost:${server.port}/eureka/
      #尤里卡访问地址


management:
  endpoint:
    health:
      show-details: always
  endpoints:
    web:
      exposure:
        include: health, info
```

Token-provider-common

pom

```pom
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>com.aishang</groupId>
        <artifactId>token-dependencies</artifactId>
        <version>1.0.0-SNAPSHOT</version>
        <relativePath>../token-dependencies/pom.xml</relativePath>
    </parent>

    <artifactId>token-service-provider</artifactId>
    <packaging>jar</packaging>

    <name>token-service-provider</name>

    <dependencies>
        <!-- Spring Boot Begin -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <!-- Spring Boot End -->

        <!-- Spring Cloud Begin -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
        </dependency>
        <!-- Spring Cloud End -->



        <!--zipkin-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-zipkin</artifactId>
        </dependency>

        <!--分布式配置中心-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-config</artifactId>
        </dependency>
        <!--springboot admin client-->
        <dependency>
            <groupId>org.jolokia</groupId>
            <artifactId>jolokia-core</artifactId>
        </dependency>
        <dependency>
            <groupId>de.codecentric</groupId>
            <artifactId>spring-boot-admin-starter-client</artifactId>
        </dependency>




        <!--druid-->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>druid-spring-boot-starter</artifactId>
        </dependency>
        <!--mysql-->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
        </dependency>
        <!--代替mybatis-->
        <dependency>
            <groupId>tk.mybatis</groupId>
            <artifactId>mapper-spring-boot-starter</artifactId>
        </dependency>
        <!--pageHelper-->
        <dependency>
            <groupId>com.github.pagehelper</groupId>
            <artifactId>pagehelper-spring-boot-starter</artifactId>
        </dependency>
        <!--fastjson-->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
        </dependency>
    </dependencies>
    <!--nexus地址 获取依赖-->
    <repositories>
        <repository>
            <id>nexus</id>
            <name>Nexus Repository</name>
            <url>http://192.168.83.200:8081/repository/maven-public/</url>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
            <releases>
                <enabled>true</enabled>
            </releases>
        </repository>
    </repositories>
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <mainClass>com.aishang.token.service.provider.ProviderApplication</mainClass>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```

在provider-common中创建通用的父级接口  

tk.mybatis.mapper包下

创建接口

```java
package tk.mybatis.mapper;

import tk.mybatis.mapper.common.Mapper;
import tk.mybatis.mapper.common.MySqlMapper;

public interface MyMapper<T> extends Mapper<T>, MySqlMapper<T> {
}

```

![token____Documents_IDEA_token_](https://ws3.sinaimg.cn/large/006tNc79ly1g31we3c9o0j30dy0c60td.jpg)

添加service-provider的pom依赖插件

```pom

  <!--tk.mybatis-->
            <plugin>
                <groupId>org.mybatis.generator</groupId>
                <artifactId>mybatis-generator-maven-plugin</artifactId>
                <version>1.3.5</version>
                <configuration>
                    <configurationFile>${basedir}/src/main/resources/generator/generatorConfig.xml</configurationFile>
                    <overwrite>true</overwrite>
                    <verbose>true</verbose>
                </configuration>
                <dependencies>
                    <dependency>
                        <groupId>mysql</groupId>
                        <artifactId>mysql-connector-java</artifactId>
                        <version>${mysql.version}</version>
                    </dependency>
                    <dependency>
                        <groupId>tk.mybatis</groupId>
                        <artifactId>mapper</artifactId>
                        <version>3.4.4</version>
                    </dependency>
                </dependencies>
            </plugin>
```

jdbc.properties

```properties
# MySQL 8.x: com.mysql.cj.jdbc.Driver
jdbc.driverClass=com.mysql.jdbc.Driver
jdbc.connectionURL=jdbc:mysql://localhost:3306/token-service-provider?useUnicode=true&characterEncoding=utf-8&useSSL=false
jdbc.username=root
jdbc.password=password
```

generatorConfig.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE generatorConfiguration
                PUBLIC "-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN"
                "http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd">

<generatorConfiguration>
<!-- 引入数据库连接配置 -->
<properties resource="jdbc.properties"/>

<context id="Mysql" targetRuntime="MyBatis3Simple" defaultModelType="flat">
    <property name="beginningDelimiter" value="`"/>
    <property name="endingDelimiter" value="`"/>

    <!-- 配置 tk.mybatis 插件 -->
    <plugin type="tk.mybatis.mapper.generator.MapperPlugin">
        <property name="mappers" value="tk.mybatis.mapper.MyMapper"/>
    </plugin>

    <!-- 配置数据库连接 -->
    <jdbcConnection
            driverClass="${jdbc.driverClass}"
            connectionURL="${jdbc.connectionURL}"
            userId="${jdbc.username}"
            password="${jdbc.password}">
    </jdbcConnection>

    <!-- 配置实体类存放路径 -->
    <javaModelGenerator targetPackage="com.aishang.token.service.provider.pojo" targetProject="src/main/java"/>

    <!-- 配置 XML 存放路径 -->
    <sqlMapGenerator targetPackage="mapper" targetProject="src/main/resources"/>

    <!-- 配置 DAO 存放路径 -->
    <javaClientGenerator
            targetPackage="com.aishang.token.service.provider.mapper"
            targetProject="src/main/java"
            type="XMLMAPPER"/>

    <!-- 配置需要指定生成的数据库和表，% 代表所有表 -->
    <table catalog="token-service-provider" tableName="tb_sys_user">
        <!-- mysql 配置 -->
        <generatedKey column="user_code" sqlStatement="Mysql" identity="false"/>
    </table>
</context>
</generatorConfiguration>
```

### 测试用例

token-service-provider的pom中添加依赖

```xml
 <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
```

```java
package com.aishang.token.service.provider;

import com.aishang.token.service.provider.pojo.TbSysUser;
import com.aishang.token.service.provider.service.UserService;
import org.junit.Assert;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.context.junit4.SpringRunner;

@RunWith(SpringRunner.class)
@SpringBootTest(classes = ProviderApplication.class)
//@ActiveProfiles(value = "prod")
public class ProviderTest {
    @Autowired
    private UserService userService;
    //注册
    @Test
    public void register(){
        TbSysUser tbSysUser = new TbSysUser();
        tbSysUser.setLoginCode("tom");
        tbSysUser.setPassword("123");
        userService.register(tbSysUser);

    }
    //登陆
    @Test
    public void login(){
        TbSysUser user = userService.login("tom", "123");
        Assert.assertNotNull(user);
    }
}

```

UserServiceImpl

```java
package com.aishang.token.service.provider.service.impl;

import com.aishang.token.service.provider.mapper.TbSysUserMapper;
import com.aishang.token.service.provider.pojo.TbSysUser;
import com.aishang.token.service.provider.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;

@Service
public class UserServiceImpl implements UserService {
    @Resource
    private TbSysUserMapper tbSysUserMapper;

    @Override
    public void register(TbSysUser tbSysUser) {

    }

    @Override
    public TbSysUser login(String loginCode, String plantPassword) {
        return null;
    }
}

```

```java

@Table(name = "token-service-provider..tb_sys_user")
public class TbSysUser {
  
  
  自动生成的实体类注解注意改成
 @Table(name = "tb_sys_user")   
```



运行

- 创建包service，创建接口
- 注册成功，登录失败，断言他不为空，但是得现有账号吧

## 2、服务消费者

token-service-consumer

pom

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>com.aishang</groupId>
        <artifactId>token-dependencies</artifactId>
        <version>1.0.0-SNAPSHOT</version>
        <relativePath>../token-dependencies/pom.xml</relativePath>
    </parent>

    <artifactId>token-service-consumer</artifactId>
    <packaging>jar</packaging>

    <name>token-service-consumer</name>

    <dependencies>
        <!-- Spring Boot Begin -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-tomcat</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-thymeleaf</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <!-- Spring Boot End -->

        <!-- Spring Cloud Begin -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
        </dependency>

        <!--feign-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>
        <!-- Spring Cloud End -->

        <!-- 解决 thymeleaf 模板引擎一定要执行严格的 html5 格式校验问题 -->
        <dependency>
            <groupId>net.sourceforge.nekohtml</groupId>
            <artifactId>nekohtml</artifactId>
            <version>1.9.22</version>
        </dependency>

        <!--分布式配置中心-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-config</artifactId>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <mainClass>com.aishang.token.service.consumer.ConsumerFeginApplication</mainClass>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```

Bootstarp.yml

```yml
spring:
  application:
    name: token-service-consumer
  thymeleaf:
    cache: false
    mode: LEGACYHTML5
    encoding: UTF-8
    servlet:
      content-type: text/html

server:
  port: 8601

eureka:
  client:
    serviceUrl:
      defaultZone: http://localhost:8761/eureka/
```

提供者

UserController

```java
package com.aishang.token.service.provider.controller;

import com.aishang.token.service.provider.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class UserController {
    @Value("${server.port}")
    private String port;
    @Autowired
    private UserService userService;
    @RequestMapping("/hi")
    public String sayHi(String message) {
//        return String.format("Hi，your message is : %s i am from port : %s", message, port);
        String s = userService.sayHi(message);
        return s;
    }
}

```

```
@Mapper
public interface TbSysUserMapper extends MyMapper<TbSysUser> {
}
```

UserService

```java
package com.aishang.token.service.provider.service;

import com.aishang.token.service.provider.pojo.TbSysUser;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

public interface UserService {
    //注册
    public void register(TbSysUser tbSysUser);
    //登陆

    /**
     *
     * @param loginCode 登陆账号
     * @param plantPassword 明文密码
     * @return
     */
    public TbSysUser login(String loginCode,String plantPassword);

    public String sayHi(String message);
}

```

UserServiceImpl

```java
package com.aishang.token.service.provider.service.impl;

        import com.aishang.token.service.provider.mapper.TbSysUserMapper;
        import com.aishang.token.service.provider.pojo.TbSysUser;
        import com.aishang.token.service.provider.service.UserService;
        import org.springframework.beans.factory.annotation.Autowired;
        import org.springframework.stereotype.Service;
        import org.springframework.transaction.annotation.Transactional;
        import org.springframework.util.DigestUtils;
        import org.springframework.web.bind.annotation.RequestMapping;
        import tk.mybatis.mapper.entity.Example;

        import javax.annotation.Resource;

@Service
@Transactional
public class UserServiceImpl implements UserService {
    @Resource
    private TbSysUserMapper tbSysUserMapper;

    @Override
    public void register(TbSysUser tbSysUser) {
        tbSysUser.setPassword(DigestUtils.md5DigestAsHex(tbSysUser.getPassword().getBytes()));
        tbSysUserMapper.insert(tbSysUser);
    }

    @Override
    public TbSysUser login(String loginCode, String plantPassword) {
        Example example = new Example(TbSysUser.class);
        example.createCriteria().andEqualTo("loginCode",loginCode);
        System.out.println(example.getCountColumn());
        TbSysUser tbSysUser = tbSysUserMapper.selectOneByExample(example);
        String pass = DigestUtils.md5DigestAsHex(plantPassword.getBytes());
        System.out.println(tbSysUser.getLoginCode());
        TbSysUser tbSysUser1 = tbSysUserMapper.selectOne(tbSysUser);
        System.out.println(tbSysUser1.getLoginCode());
        if (pass.equals(tbSysUser.getPassword())){
            return tbSysUser;
        }

        return null;
    }

    @Override
    public String sayHi(String message) {
        return message+"jrebel=========provider";
    }


}

```

消费者

UserController

```java
package com.aishang.token.service.consumer.controller;

import com.aishang.token.service.consumer.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class UserController {
    @Autowired
    private UserService userService;

    @RequestMapping("/hi")
    public String sayHi(String message) {

//        return userService.sayHi(message);
        String s = userService.sayHi(message);
        return s;
    }

}

```

UserService

```java
package com.aishang.token.service.consumer.service;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.stereotype.Service;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;

@FeignClient(value = "token-service-provider")
public interface UserService {
    @RequestMapping("/hi")
    public String sayHi(@RequestParam(value = "message") String message);
}

```

总结：

- 提供者必须有controller注解是RestController

  ```java
  
  @RestController
  @RequestMapping("/cate")
  public class CategoryController {
      @Resource
      private CategoryService categoryService;
      @RequestMapping("/findAllCategory")
      public  List<Category> findAllCategory(){
          List<Category> allCategory = categoryService.findAllCategory();
          return allCategory;
      }
  
  }
  ```

- 提供者controller的请求路径

  ```sh
  @RequestMapping("/cate/findAllCategory")
  
  对应的是 消费者的service里的@RequestMapping("/cate/findAllCategory")
  ```

  

- 消费者

  ```java
  package com.liujiang.shop.consumer.controller;
  
  import com.liujiang.shop.consumer.service.CategoryService;
  import com.liujiang.shop.core.pojo.Category;
  import org.springframework.stereotype.Controller;
  import org.springframework.ui.Model;
  import org.springframework.web.bind.annotation.RequestMapping;
  
  import javax.annotation.Resource;
  import java.util.List;
  
  @Controller
  public class IndexController {
      @Resource
      private CategoryService categoryService;
  
      @RequestMapping("/index")
      public String findIndexInfo(Model model){
          List<Category> findAllCategory = categoryService.findAllCategory();
  
          model.addAttribute("findAllCategory",findAllCategory);
          return "index";
      }
  }
  
  ```

  ```java
  package com.liujiang.shop.consumer.service;
  
  
  import com.liujiang.shop.core.pojo.Category;
  import org.springframework.cloud.openfeign.FeignClient;
  import org.springframework.web.bind.annotation.RequestMapping;
  
  import java.util.List;
  @FeignClient(value = "shop-view-provider")
  public interface CategoryService {
      //查询以及类目
      @RequestMapping("/cate/findAllCategory")
      public List<Category> findAllCategory();
  }
  
  ```

  

# 创建数字货币服务提供者

## 创建项目

创建一个名为 `itoken-service-digiccy` 的服务提供者项目

## 服务所需数据库脚本

```sql
/*
SQLyog  v12.2.6 (64 bit)
MySQL - 5.7.22 : Database - itoken-service-digiccy
*********************************************************************
*/


/*!40101 SET NAMES utf8 */;

/*!40101 SET SQL_MODE=''*/;

/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;
CREATE DATABASE /*!32312 IF NOT EXISTS*/`itoken-service-digiccy` /*!40100 DEFAULT CHARACTER SET utf8mb4 */;

USE `itoken-service-digiccy`;

DROP TABLE IF EXISTS tb_digiccy_exchange;

-- 交易所表
CREATE TABLE tb_digiccy_exchange
(
	exch_guid varchar(100) NOT NULL COMMENT '交易所编码',
    exch_name varchar(64) NOT NULL COMMENT '交易所名称',
    exch_code varchar(64) NOT NULL COMMENT '交易所代号',
    exch_url varchar(64) NOT NULL COMMENT '交易所网址',
	create_by varchar(64) NOT NULL COMMENT '创建者',
	create_date datetime NOT NULL COMMENT '创建时间',
	update_by varchar(64) NOT NULL COMMENT '更新者',
	update_date datetime NOT NULL COMMENT '更新时间',
	remarks varchar(500) COMMENT '备注信息',
	extend_s1 varchar(500) COMMENT '扩展 String 1',
	extend_s2 varchar(500) COMMENT '扩展 String 2',
	extend_s3 varchar(500) COMMENT '扩展 String 3',
	extend_s4 varchar(500) COMMENT '扩展 String 4',
	extend_s5 varchar(500) COMMENT '扩展 String 5',
	extend_s6 varchar(500) COMMENT '扩展 String 6',
	extend_s7 varchar(500) COMMENT '扩展 String 7',
	extend_s8 varchar(500) COMMENT '扩展 String 8',
	extend_i1 decimal(19) COMMENT '扩展 Integer 1',
	extend_i2 decimal(19) COMMENT '扩展 Integer 2',
	extend_i3 decimal(19) COMMENT '扩展 Integer 3',
	extend_i4 decimal(19) COMMENT '扩展 Integer 4',
	extend_f1 decimal(19,4) COMMENT '扩展 Float 1',
	extend_f2 decimal(19,4) COMMENT '扩展 Float 2',
	extend_f3 decimal(19,4) COMMENT '扩展 Float 3',
	extend_f4 decimal(19,4) COMMENT '扩展 Float 4',
	extend_d1 datetime COMMENT '扩展 Date 1',
	extend_d2 datetime COMMENT '扩展 Date 2',
	extend_d3 datetime COMMENT '扩展 Date 3',
	extend_d4 datetime COMMENT '扩展 Date 4',
	PRIMARY KEY (exch_guid)
) COMMENT = '交易所表';

CREATE INDEX idx_digiccy_exchange_eg ON tb_digiccy_exchange (exch_guid ASC);
```