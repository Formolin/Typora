# Redis

- å®‰è£…

  ```sh
  brew install redis
  ```

- å¯åŠ¨

  ```sh
  brew services start redis
  ```

  

```sh
==> Caveats
To have launchd start redis now and restart at login:
  brew services start redis
Or, if you don't want/need a background service you can just run:
  redis-server /usr/local/etc/redis.conf
==> Summary
ğŸº  /usr/local/Cellar/redis/5.0.4: 13 files, 3.1MB
liujiangdeMacBook-Pro:~ liujiang$ brew services start redis
==> Successfully started `redis` (label: homebrew.mxcl.redis)
```

- åœæ­¢

  ```sh
  brew services stop redis
  ```

## Linuxå®‰è£…

- ä¸Šä¼ æ–‡ä»¶ï¼Œè§£å‹
- è¿›å…¥ç›®å½•
- æ‰§è¡Œ make å‘½ä»¤
- åœ¨æ‰§è¡Œ  make install

### NoSqlå’Œå…³ç³»å‹æ•°æ®åº“åŒæ­¥é—®é¢˜

### Rediså…·å¤‡æŒä¹…åŒ–

- rdb
  - é»˜è®¤æŒä¹…åŒ–ç­–ç•¥
  - æ¯éš”ä¸€å®šæ—¶é—´åå§å†…å­˜ä¸­æ•°æ®æŒä¹…åŒ–åˆ°dump.rdbæ–‡ä»¶ä¸­
  - ç¼ºç‚¹ï¼š
    - æ•°æ®è¿‡äºé›†ä¸­
    - å¯èƒ½å¯¼è‡´æœ€åçš„æ•°æ®æ²¡æœ‰æŒä¹…åŒ–åˆ°è¯¥æ–‡ä»¶ä¸­ï¼Œå› ä¸ºæ˜¯æ¯éš”ä¸€æ®µæ—¶é—´
      - ä½¿ç”¨å‘½ä»¤saveæˆ–bgsaveæ‰‹åŠ¨æŒä¹…åŒ–
- aof
  - ç›‘å¬redisçš„æ—¥å¿—æ–‡ä»¶ï¼Œç›‘å¬å¦‚æœå‘ç°æ‰§è¡Œä¿®æ”¹åˆ é™¤æ–°å¢å‘½ä»¤ï¼Œç«‹å³æ ¹æ®è¿™æ¡å‘½ä»¤å§æ•°æ®å†™å…¥æŒä¹…åŒ–
  - ç¼ºç‚¹ï¼šæ•ˆç‡é™ä½ï¼Œä¸ºäº†åˆè¡·ï¼Œé«˜æ€§èƒ½
- ä½¿ç”¨rdbï¼Œå› ä¸ºå°±æ˜¯ä¸´æ—¶å­˜å‚¨åŠŸèƒ½

### å‘½ä»¤

æ•°æ®ç±»å‹å¸¸ç”¨ç±»å‹

- String
  - æ–°å¢set
  - del
  - æ”¹set
  - æŸ¥get
- Hash
- List
- Set
- SortedSet(æœ‰åºseté›†åˆ)

### å®‰è£…åˆ°è™šæ‹Ÿæœº

- yum install -y gcc-c++

  - ç”±äºæ˜¯cè¯­è¨€ç¼–å†™ï¼Œæ‰€ä»¥éœ€è¦å®‰è£…æ”¯æŒç»„ä»¶

- æŠŠå‹ç¼©åŒ…ä¸Šä¼ çš„linuxæœåŠ¡å™¨ä¸Š

  - ä½ç½®ï¼š/usr/local/tmp/ä¸‹

- cd /usr/local/tmp

  - è¿›å…¥åˆ°ç›®å½•ä¸‹è§£å‹ï¼štar zxvf redis-5.0.4.tar.gz

- make

  - è¿›å…¥åˆ°è§£å‹åçš„ç›®å½•ç¼–è¯‘
  - make install PREFIX=/usr/local/redis
    - ä¸Šéƒ¨æ˜¯å®‰è£…ï¼Œè®¾ç½®è·¯å¾„
  - è¿›å…¥/usr/local/redis/binä¸‹

- å¯åŠ¨

  - ./redis-server

  - å‰ç«¯å¯åŠ¨ï¼Œå®‰è£…åä¸èƒ½è¿›è¡Œå…¶ä»–æ“ä½œ

  - ctrl+cé€€å‡º

  - å‘½ä»¤è¦åœ¨binç›®å½•ä¸‹æ‰§è¡Œ

    ```sh
    [root@192-192-199-127 bin]# ./redis-server 
    11380:C 09 Apr 2019 16:24:51.307 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo
    11380:C 09 Apr 2019 16:24:51.307 # Redis version=5.0.4, bits=64, commit=00000000, modified=0, pid=11380, just started
    11380:C 09 Apr 2019 16:24:51.307 # Warning: no config file specified, using the default config. In order to specify a config file use ./redis-server /path/to/redis.conf
    11380:M 09 Apr 2019 16:24:51.308 * Increased maximum number of open files to 10032 (it was originally set to 1024).
                    _._                                                  
               _.-``__ ''-._                                             
          _.-``    `.  `_.  ''-._           Redis 5.0.4 (00000000/0) 64 bit
      .-`` .-```.  ```\/    _.,_ ''-._                                   
     (    '      ,       .-`  | `,    )     Running in standalone mode
     |`-._`-...-` __...-.``-._|'` _.-'|     Port: 6379
     |    `-._   `._    /     _.-'    |     PID: 11380
      `-._    `-._  `-./  _.-'    _.-'                                   
     |`-._`-._    `-.__.-'    _.-'_.-'|                                  
     |    `-._`-._        _.-'_.-'    |           http://redis.io        
      `-._    `-._`-.__.-'_.-'    _.-'                                   
     |`-._`-._    `-.__.-'    _.-'_.-'|                                  
     |    `-._`-._        _.-'_.-'    |                                  
      `-._    `-._`-.__.-'_.-'    _.-'                                   
          `-._    `-.__.-'    _.-'                                       
              `-._        _.-'                                           
                  `-.__.-'                                               
    
    11380:M 09 Apr 2019 16:24:51.309 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.
    11380:M 09 Apr 2019 16:24:51.309 # Server initialized
    11380:M 09 Apr 2019 16:24:51.309 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.
    11380:M 09 Apr 2019 16:24:51.309 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo never > /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.
    11380:M 09 Apr 2019 16:24:51.309 * Ready to accept connections
    
    
    ```

    

- å¼€å¯å®ˆæŠ¤è¿›ç¨‹ï¼Œè¿›å…¥åå°æ¨¡å¼
  - cp /usr/local/tmp/redis-5.0.4/redis.conf /usr/local/redis/bin
    - æŠŠè§£å‹ç›®å½•ä¸‹é…ç½®æ–‡ä»¶æ‹·è´åˆ°å®‰è£…ç›®å½•çš„binä¸‹
  - vi redis.conf
    - ä¿®æ”¹binä¸‹redis.conf
    - æŠŠdaemonizeç”±noä¿®æ”¹æˆyesï¼Œå®ˆæŠ¤è¿›ç¨‹å¯åŠ¨
  - ./redis-server redis.conf
    - å¯åŠ¨redisæœåŠ¡
  - ps aux|grep redis
    - æŸ¥çœ‹rediså¯åŠ¨æƒ…å†µ
  - ./redis-cli shutdown
    - å…³é—­
  - æµ‹è¯•ï¼Œè‡ªå¸¦å®¢æˆ·ç«¯å·¥å…·
    - ./redis-cli
      - set name "tom"
      - get name
      - set name "hello redis"
      - get name
      - Del name
      - Get name ç»“æœnil
      - Setex name 5 "hello" å¦‚æœå­˜åœ¨åœ¨è®¾ç½®ï¼Œæœ‰æ•ˆæ—¶é—´5ç§’ï¼Œå­˜åœ¨è¦†ç›–æ—§å€¼
      - get name
      - set name "hello"
      - Setnx name "hello1" æ²¡æœ‰çš„æ—¶å€™æ‰è®¾ç½®ï¼Œæœ‰çš„è¯ä¸æ”¹å˜ï¼Œç»“æœæ˜¯0
      - get name  ç»“æœæ˜¯hello

# æ•°æ®æ ¼å¼

![image-20191018113918000](/Users/liujiang/Documents/Typora/imgs/006y8mN6ly1g827b78wrzj314c086tik.jpg)

![image-20191018115222303](/Users/liujiang/Documents/Typora/imgs/image-20191018115222303.png)

# redisæŒä¹…åŒ–ï¼šRDBï¼ŒAOF

### 1ã€RDBå’ŒAOFä¸¤ç§æŒä¹…åŒ–æœºåˆ¶çš„ä»‹ç»

RDBæŒä¹…åŒ–æœºåˆ¶ï¼Œå¯¹redisä¸­çš„æ•°æ®æ‰§è¡Œå‘¨æœŸæ€§çš„æŒä¹…åŒ–

AOFæœºåˆ¶å¯¹æ¯æ¡å†™å…¥å‘½ä»¤ä½œä¸ºæ—¥å¿—ï¼Œä»¥append-onlyçš„æ¨¡å¼å†™å…¥ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ä¸­ï¼Œåœ¨redisé‡å¯çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡å›æ”¾AOFæ—¥å¿—ä¸­çš„å†™å…¥æŒ‡ä»¤æ¥é‡æ–°æ„å»ºæ•´ä¸ªæ•°æ®é›†

å¦‚æœæˆ‘ä»¬æƒ³è¦redisä»…ä»…ä½œä¸ºçº¯å†…å­˜çš„ç¼“å­˜æ¥ç”¨ï¼Œé‚£ä¹ˆå¯ä»¥ç¦æ­¢RDBå’ŒAOFæ‰€æœ‰çš„æŒä¹…åŒ–æœºåˆ¶

é€šè¿‡RDBæˆ–AOFï¼Œéƒ½å¯ä»¥å°†rediså†…å­˜ä¸­çš„æ•°æ®ç»™æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šé¢æ¥ï¼Œç„¶åå¯ä»¥å°†è¿™äº›æ•°æ®å¤‡ä»½åˆ°åˆ«çš„åœ°æ–¹å»ï¼Œæ¯”å¦‚è¯´é˜¿é‡Œäº‘ï¼Œäº‘æœåŠ¡

å¦‚æœredisæŒ‚äº†ï¼ŒæœåŠ¡å™¨ä¸Šçš„å†…å­˜å’Œç£ç›˜ä¸Šçš„æ•°æ®éƒ½ä¸¢äº†ï¼Œå¯ä»¥ä»äº‘æœåŠ¡ä¸Šæ‹·è´å›æ¥ä¹‹å‰çš„æ•°æ®ï¼Œæ”¾åˆ°æŒ‡å®šçš„ç›®å½•ä¸­ï¼Œç„¶åé‡æ–°å¯åŠ¨redisï¼Œrediså°±ä¼šè‡ªåŠ¨æ ¹æ®æŒä¹…åŒ–æ•°æ®æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œå»æ¢å¤å†…å­˜ä¸­çš„æ•°æ®ï¼Œç»§ç»­å¯¹å¤–æä¾›æœåŠ¡

å¦‚æœåŒæ—¶ä½¿ç”¨RDBå’ŒAOFä¸¤ç§æŒä¹…åŒ–æœºåˆ¶ï¼Œé‚£ä¹ˆåœ¨redisé‡å¯çš„æ—¶å€™ï¼Œä¼šä½¿ç”¨AOFæ¥é‡æ–°æ„å»ºæ•°æ®ï¼Œå› ä¸ºAOFä¸­çš„æ•°æ®æ›´åŠ å®Œæ•´

### 2ã€RDBæŒä¹…åŒ–æœºåˆ¶çš„ä¼˜ç‚¹

ï¼ˆ1ï¼‰RDBä¼šç”Ÿæˆå¤šä¸ªæ•°æ®æ–‡ä»¶ï¼Œæ¯ä¸ªæ•°æ®æ–‡ä»¶éƒ½ä»£è¡¨äº†æŸä¸€ä¸ªæ—¶åˆ»ä¸­redisçš„æ•°æ®ï¼Œè¿™ç§å¤šä¸ªæ•°æ®æ–‡ä»¶çš„æ–¹å¼ï¼Œéå¸¸é€‚åˆåšå†·å¤‡ï¼Œå¯ä»¥å°†è¿™ç§å®Œæ•´çš„æ•°æ®æ–‡ä»¶å‘é€åˆ°ä¸€äº›è¿œç¨‹çš„å®‰å…¨å­˜å‚¨ä¸Šå»ï¼Œæ¯”å¦‚è¯´Amazonçš„S3äº‘æœåŠ¡ä¸Šå»ï¼Œåœ¨å›½å†…å¯ä»¥æ˜¯é˜¿é‡Œäº‘çš„ODPSåˆ†å¸ƒå¼å­˜å‚¨ä¸Šï¼Œä»¥é¢„å®šå¥½çš„å¤‡ä»½ç­–ç•¥æ¥å®šæœŸå¤‡ä»½redisä¸­çš„æ•°æ®

RDBä¹Ÿå¯ä»¥åšå†·å¤‡ï¼Œç”Ÿæˆå¤šä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½ä»£è¡¨äº†æŸä¸€ä¸ªæ—¶åˆ»çš„å®Œæ•´çš„æ•°æ®å¿«ç…§
AOFä¹Ÿå¯ä»¥åšå†·å¤‡ï¼Œåªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œä½†æ˜¯ä½ å¯ä»¥ï¼Œæ¯éš”ä¸€å®šæ—¶é—´ï¼Œå»copyä¸€ä»½è¿™ä¸ªæ–‡ä»¶å‡ºæ¥

RDBåšå†·å¤‡ï¼Œä¼˜åŠ¿åœ¨å“ªå„¿å‘¢ï¼Ÿç”±rediså»æ§åˆ¶å›ºå®šæ—¶é•¿ç”Ÿæˆå¿«ç…§æ–‡ä»¶çš„äº‹æƒ…ï¼Œæ¯”è¾ƒæ–¹ä¾¿; AOFï¼Œè¿˜éœ€è¦è‡ªå·±å†™ä¸€äº›è„šæœ¬å»åšè¿™ä¸ªäº‹æƒ…ï¼Œå„ç§å®šæ—¶
RDBæ•°æ®åšå†·å¤‡ï¼Œåœ¨æœ€åçš„æƒ…å†µä¸‹ï¼Œæä¾›æ•°æ®æ¢å¤çš„æ—¶å€™ï¼Œé€Ÿåº¦æ¯”AOFå¿«

ï¼ˆ2ï¼‰RDBå¯¹rediså¯¹å¤–æä¾›çš„è¯»å†™æœåŠ¡ï¼Œå½±å“éå¸¸å°ï¼Œå¯ä»¥è®©redisä¿æŒé«˜æ€§èƒ½ï¼Œå› ä¸ºredisä¸»è¿›ç¨‹åªéœ€è¦forkä¸€ä¸ªå­è¿›ç¨‹ï¼Œè®©å­è¿›ç¨‹æ‰§è¡Œç£ç›˜IOæ“ä½œæ¥è¿›è¡ŒRDBæŒä¹…åŒ–å³å¯

RDBï¼Œæ¯æ¬¡å†™ï¼Œéƒ½æ˜¯ç›´æ¥å†™rediså†…å­˜ï¼Œåªæ˜¯åœ¨ä¸€å®šçš„æ—¶å€™ï¼Œæ‰ä¼šå°†æ•°æ®å†™å…¥ç£ç›˜ä¸­
AOFï¼Œæ¯æ¬¡éƒ½æ˜¯è¦å†™æ–‡ä»¶çš„ï¼Œè™½ç„¶å¯ä»¥å¿«é€Ÿå†™å…¥os cacheä¸­ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰ä¸€å®šçš„æ—¶é—´å¼€é”€çš„,é€Ÿåº¦è‚¯å®šæ¯”RDBç•¥æ…¢ä¸€äº›

ï¼ˆ3ï¼‰ç›¸å¯¹äºAOFæŒä¹…åŒ–æœºåˆ¶æ¥è¯´ï¼Œç›´æ¥åŸºäºRDBæ•°æ®æ–‡ä»¶æ¥é‡å¯å’Œæ¢å¤redisè¿›ç¨‹ï¼Œæ›´åŠ å¿«é€Ÿ

AOFï¼Œå­˜æ”¾çš„æŒ‡ä»¤æ—¥å¿—ï¼Œåšæ•°æ®æ¢å¤çš„æ—¶å€™ï¼Œå…¶å®æ˜¯è¦å›æ”¾å’Œæ‰§è¡Œæ‰€æœ‰çš„æŒ‡ä»¤æ—¥å¿—ï¼Œæ¥æ¢å¤å‡ºæ¥å†…å­˜ä¸­çš„æ‰€æœ‰æ•°æ®çš„
RDBï¼Œå°±æ˜¯ä¸€ä»½æ•°æ®æ–‡ä»¶ï¼Œæ¢å¤çš„æ—¶å€™ï¼Œç›´æ¥åŠ è½½åˆ°å†…å­˜ä¸­å³å¯

ç»“åˆä¸Šè¿°ä¼˜ç‚¹ï¼ŒRDBç‰¹åˆ«é€‚åˆåšå†·å¤‡ä»½ï¼Œå†·å¤‡

### 3ã€RDBæŒä¹…åŒ–æœºåˆ¶çš„ç¼ºç‚¹

ï¼ˆ1ï¼‰å¦‚æœæƒ³è¦åœ¨redisæ•…éšœæ—¶ï¼Œå°½å¯èƒ½å°‘çš„ä¸¢å¤±æ•°æ®ï¼Œé‚£ä¹ˆRDBæ²¡æœ‰AOFå¥½ã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒRDBæ•°æ®å¿«ç…§æ–‡ä»¶ï¼Œéƒ½æ˜¯æ¯éš”5åˆ†é’Ÿï¼Œæˆ–è€…æ›´é•¿æ—¶é—´ç”Ÿæˆä¸€æ¬¡ï¼Œè¿™ä¸ªæ—¶å€™å°±å¾—æ¥å—ä¸€æ—¦redisè¿›ç¨‹å®•æœºï¼Œé‚£ä¹ˆä¼šä¸¢å¤±æœ€è¿‘5åˆ†é’Ÿçš„æ•°æ®

è¿™ä¸ªé—®é¢˜ï¼Œä¹Ÿæ˜¯rdbæœ€å¤§çš„ç¼ºç‚¹ï¼Œå°±æ˜¯ä¸é€‚åˆåšç¬¬ä¸€ä¼˜å…ˆçš„æ¢å¤æ–¹æ¡ˆï¼Œå¦‚æœä½ ä¾èµ–RDBåšç¬¬ä¸€ä¼˜å…ˆæ¢å¤æ–¹æ¡ˆï¼Œä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±çš„æ¯”è¾ƒå¤š

ï¼ˆ2ï¼‰RDBæ¯æ¬¡åœ¨forkå­è¿›ç¨‹æ¥æ‰§è¡ŒRDBå¿«ç…§æ•°æ®æ–‡ä»¶ç”Ÿæˆçš„æ—¶å€™ï¼Œå¦‚æœæ•°æ®æ–‡ä»¶ç‰¹åˆ«å¤§ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¯¹å®¢æˆ·ç«¯æä¾›çš„æœåŠ¡æš‚åœæ•°æ¯«ç§’ï¼Œæˆ–è€…ç”šè‡³æ•°ç§’

ä¸€èˆ¬ä¸è¦è®©RDBçš„é—´éš”å¤ªé•¿ï¼Œå¦åˆ™æ¯æ¬¡ç”Ÿæˆçš„RDBæ–‡ä»¶å¤ªå¤§äº†ï¼Œå¯¹redisæœ¬èº«çš„æ€§èƒ½å¯èƒ½ä¼šæœ‰å½±å“çš„

### 4ã€AOFæŒä¹…åŒ–æœºåˆ¶çš„ä¼˜ç‚¹

ï¼ˆ1ï¼‰AOFå¯ä»¥æ›´å¥½çš„ä¿æŠ¤æ•°æ®ä¸ä¸¢å¤±ï¼Œä¸€èˆ¬AOFä¼šæ¯éš”1ç§’ï¼Œé€šè¿‡ä¸€ä¸ªåå°çº¿ç¨‹æ‰§è¡Œä¸€æ¬¡fsyncæ“ä½œï¼Œæœ€å¤šä¸¢å¤±1ç§’é’Ÿçš„æ•°æ®

æ¯éš”1ç§’ï¼Œå°±æ‰§è¡Œä¸€æ¬¡fsyncæ“ä½œï¼Œä¿è¯os cacheä¸­çš„æ•°æ®å†™å…¥ç£ç›˜ä¸­

redisè¿›ç¨‹æŒ‚äº†ï¼Œæœ€å¤šä¸¢æ‰1ç§’é’Ÿçš„æ•°æ®

ï¼ˆ2ï¼‰AOFæ—¥å¿—æ–‡ä»¶ä»¥append-onlyæ¨¡å¼å†™å…¥ï¼Œæ‰€ä»¥æ²¡æœ‰ä»»ä½•ç£ç›˜å¯»å€çš„å¼€é”€ï¼Œå†™å…¥æ€§èƒ½éå¸¸é«˜ï¼Œè€Œä¸”æ–‡ä»¶ä¸å®¹æ˜“ç ´æŸï¼Œå³ä½¿æ–‡ä»¶å°¾éƒ¨ç ´æŸï¼Œä¹Ÿå¾ˆå®¹æ˜“ä¿®å¤

ï¼ˆ3ï¼‰AOFæ—¥å¿—æ–‡ä»¶å³ä½¿è¿‡å¤§çš„æ—¶å€™ï¼Œå‡ºç°åå°é‡å†™æ“ä½œï¼Œä¹Ÿä¸ä¼šå½±å“å®¢æˆ·ç«¯çš„è¯»å†™ã€‚å› ä¸ºåœ¨rewrite logçš„æ—¶å€™ï¼Œä¼šå¯¹å…¶ä¸­çš„æŒ‡å¯¼è¿›è¡Œå‹ç¼©ï¼Œåˆ›å»ºå‡ºä¸€ä»½éœ€è¦æ¢å¤æ•°æ®çš„æœ€å°æ—¥å¿—å‡ºæ¥ã€‚å†åˆ›å»ºæ–°æ—¥å¿—æ–‡ä»¶çš„æ—¶å€™ï¼Œè€çš„æ—¥å¿—æ–‡ä»¶è¿˜æ˜¯ç…§å¸¸å†™å…¥ã€‚å½“æ–°çš„mergeåçš„æ—¥å¿—æ–‡ä»¶readyçš„æ—¶å€™ï¼Œå†äº¤æ¢æ–°è€æ—¥å¿—æ–‡ä»¶å³å¯ã€‚

ï¼ˆ4ï¼‰AOFæ—¥å¿—æ–‡ä»¶çš„å‘½ä»¤é€šè¿‡éå¸¸å¯è¯»çš„æ–¹å¼è¿›è¡Œè®°å½•ï¼Œè¿™ä¸ªç‰¹æ€§éå¸¸é€‚åˆåšç¾éš¾æ€§çš„è¯¯åˆ é™¤çš„ç´§æ€¥æ¢å¤ã€‚æ¯”å¦‚æŸäººä¸å°å¿ƒç”¨flushallå‘½ä»¤æ¸…ç©ºäº†æ‰€æœ‰æ•°æ®ï¼Œåªè¦è¿™ä¸ªæ—¶å€™åå°rewriteè¿˜æ²¡æœ‰å‘ç”Ÿï¼Œé‚£ä¹ˆå°±å¯ä»¥ç«‹å³æ‹·è´AOFæ–‡ä»¶ï¼Œå°†æœ€åä¸€æ¡flushallå‘½ä»¤ç»™åˆ äº†ï¼Œç„¶åå†å°†è¯¥AOFæ–‡ä»¶æ”¾å›å»ï¼Œå°±å¯ä»¥é€šè¿‡æ¢å¤æœºåˆ¶ï¼Œè‡ªåŠ¨æ¢å¤æ‰€æœ‰æ•°æ®

### 5ã€AOFæŒä¹…åŒ–æœºåˆ¶çš„ç¼ºç‚¹

ï¼ˆ1ï¼‰å¯¹äºåŒä¸€ä»½æ•°æ®æ¥è¯´ï¼ŒAOFæ—¥å¿—æ–‡ä»¶é€šå¸¸æ¯”RDBæ•°æ®å¿«ç…§æ–‡ä»¶æ›´å¤§

ï¼ˆ2ï¼‰AOFå¼€å¯åï¼Œæ”¯æŒçš„å†™QPSä¼šæ¯”RDBæ”¯æŒçš„å†™QPSä½ï¼Œå› ä¸ºAOFä¸€èˆ¬ä¼šé…ç½®æˆæ¯ç§’fsyncä¸€æ¬¡æ—¥å¿—æ–‡ä»¶ï¼Œå½“ç„¶ï¼Œæ¯ç§’ä¸€æ¬¡fsyncï¼Œæ€§èƒ½ä¹Ÿè¿˜æ˜¯å¾ˆé«˜çš„

å¦‚æœä½ è¦ä¿è¯ä¸€æ¡æ•°æ®éƒ½ä¸ä¸¢ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ï¼ŒAOFçš„fsyncè®¾ç½®æˆæ²¡å†™å…¥ä¸€æ¡æ•°æ®ï¼Œfsyncä¸€æ¬¡ï¼Œé‚£å°±å®Œè›‹äº†ï¼Œredisçš„QPSå¤§é™

ï¼ˆ3ï¼‰ä»¥å‰AOFå‘ç”Ÿè¿‡bugï¼Œå°±æ˜¯é€šè¿‡AOFè®°å½•çš„æ—¥å¿—ï¼Œè¿›è¡Œæ•°æ®æ¢å¤çš„æ—¶å€™ï¼Œæ²¡æœ‰æ¢å¤ä¸€æ¨¡ä¸€æ ·çš„æ•°æ®å‡ºæ¥ã€‚æ‰€ä»¥è¯´ï¼Œç±»ä¼¼AOFè¿™ç§è¾ƒä¸ºå¤æ‚çš„åŸºäºå‘½ä»¤æ—¥å¿—/merge/å›æ”¾çš„æ–¹å¼ï¼Œæ¯”åŸºäºRDBæ¯æ¬¡æŒä¹…åŒ–ä¸€ä»½å®Œæ•´çš„æ•°æ®å¿«ç…§æ–‡ä»¶çš„æ–¹å¼ï¼Œæ›´åŠ è„†å¼±ä¸€äº›ï¼Œå®¹æ˜“æœ‰bugã€‚ä¸è¿‡AOFå°±æ˜¯ä¸ºäº†é¿å…rewriteè¿‡ç¨‹å¯¼è‡´çš„bugï¼Œå› æ­¤æ¯æ¬¡rewriteå¹¶ä¸æ˜¯åŸºäºæ—§çš„æŒ‡ä»¤æ—¥å¿—è¿›è¡Œmergeçš„ï¼Œè€Œæ˜¯åŸºäºå½“æ—¶å†…å­˜ä¸­çš„æ•°æ®è¿›è¡ŒæŒ‡ä»¤çš„é‡æ–°æ„å»ºï¼Œè¿™æ ·å¥å£®æ€§ä¼šå¥½å¾ˆå¤šã€‚

ï¼ˆ4ï¼‰å”¯ä¸€çš„æ¯”è¾ƒå¤§çš„ç¼ºç‚¹ï¼Œå…¶å®å°±æ˜¯åšæ•°æ®æ¢å¤çš„æ—¶å€™ï¼Œä¼šæ¯”è¾ƒæ…¢ï¼Œè¿˜æœ‰åšå†·å¤‡ï¼Œå®šæœŸçš„å¤‡ä»½ï¼Œä¸å¤ªæ–¹ä¾¿ï¼Œå¯èƒ½è¦è‡ªå·±æ‰‹å†™å¤æ‚çš„è„šæœ¬å»åšï¼Œåšå†·å¤‡ä¸å¤ªåˆé€‚

### 6ã€RDBå’ŒAOFåˆ°åº•è¯¥å¦‚ä½•é€‰æ‹©

ï¼ˆ1ï¼‰ä¸è¦ä»…ä»…ä½¿ç”¨RDBï¼Œå› ä¸ºé‚£æ ·ä¼šå¯¼è‡´ä½ ä¸¢å¤±å¾ˆå¤šæ•°æ®

ï¼ˆ2ï¼‰ä¹Ÿä¸è¦ä»…ä»…ä½¿ç”¨AOFï¼Œå› ä¸ºé‚£æ ·æœ‰ä¸¤ä¸ªé—®é¢˜ï¼Œç¬¬ä¸€ï¼Œä½ é€šè¿‡AOFåšå†·å¤‡ï¼Œæ²¡æœ‰RDBåšå†·å¤‡ï¼Œæ¥çš„æ¢å¤é€Ÿåº¦æ›´å¿«; ç¬¬äºŒï¼ŒRDBæ¯æ¬¡ç®€å•ç²—æš´ç”Ÿæˆæ•°æ®å¿«ç…§ï¼Œæ›´åŠ å¥å£®ï¼Œå¯ä»¥é¿å…AOFè¿™ç§å¤æ‚çš„å¤‡ä»½å’Œæ¢å¤æœºåˆ¶çš„bug

ï¼ˆ3ï¼‰ç»¼åˆä½¿ç”¨AOFå’ŒRDBä¸¤ç§æŒä¹…åŒ–æœºåˆ¶ï¼Œç”¨AOFæ¥ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œä½œä¸ºæ•°æ®æ¢å¤çš„ç¬¬ä¸€é€‰æ‹©; ç”¨RDBæ¥åšä¸åŒç¨‹åº¦çš„å†·å¤‡ï¼Œåœ¨AOFæ–‡ä»¶éƒ½ä¸¢å¤±æˆ–æŸåä¸å¯ç”¨çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥ä½¿ç”¨RDBæ¥è¿›è¡Œå¿«é€Ÿçš„æ•°æ®æ¢å¤

# é…ç½®RDB

1ã€å¦‚ä½•é…ç½®RDBæŒä¹…åŒ–æœºåˆ¶
2ã€RDBæŒä¹…åŒ–æœºåˆ¶çš„å·¥ä½œæµç¨‹
3ã€åŸºäºRDBæŒä¹…åŒ–æœºåˆ¶çš„æ•°æ®æ¢å¤å®éªŒ

------------------------------------------------------------------------

### 1ã€å¦‚ä½•é…ç½®RDBæŒä¹…åŒ–æœºåˆ¶

redis.confæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯/etc/redis/6379.confï¼Œå»é…ç½®æŒä¹…åŒ–

save 60 1000

æ¯éš”60sï¼Œå¦‚æœæœ‰è¶…è¿‡1000ä¸ªkeyå‘ç”Ÿäº†å˜æ›´ï¼Œé‚£ä¹ˆå°±ç”Ÿæˆä¸€ä¸ªæ–°çš„dump.rdbæ–‡ä»¶ï¼Œå°±æ˜¯å½“å‰rediså†…å­˜ä¸­å®Œæ•´çš„æ•°æ®å¿«ç…§ï¼Œè¿™ä¸ªæ“ä½œä¹Ÿè¢«ç§°ä¹‹ä¸ºsnapshottingï¼Œå¿«ç…§

ä¹Ÿå¯ä»¥æ‰‹åŠ¨è°ƒç”¨saveæˆ–è€…bgsaveå‘½ä»¤ï¼ŒåŒæ­¥æˆ–å¼‚æ­¥æ‰§è¡Œrdbå¿«ç…§ç”Ÿæˆ

saveå¯ä»¥è®¾ç½®å¤šä¸ªï¼Œå°±æ˜¯å¤šä¸ªsnapshottingæ£€æŸ¥ç‚¹ï¼Œæ¯åˆ°ä¸€ä¸ªæ£€æŸ¥ç‚¹ï¼Œå°±ä¼šå»checkä¸€ä¸‹ï¼Œæ˜¯å¦æœ‰æŒ‡å®šçš„keyæ•°é‡å‘ç”Ÿäº†å˜æ›´ï¼Œå¦‚æœæœ‰ï¼Œå°±ç”Ÿæˆä¸€ä¸ªæ–°çš„dump.rdbæ–‡ä»¶

------------------------------------------------------------------------

### 2ã€RDBæŒä¹…åŒ–æœºåˆ¶çš„å·¥ä½œæµç¨‹

ï¼ˆ1ï¼‰redisæ ¹æ®é…ç½®è‡ªå·±å°è¯•å»ç”Ÿæˆrdbå¿«ç…§æ–‡ä»¶
ï¼ˆ2ï¼‰forkä¸€ä¸ªå­è¿›ç¨‹å‡ºæ¥
ï¼ˆ3ï¼‰å­è¿›ç¨‹å°è¯•å°†æ•°æ®dumpåˆ°ä¸´æ—¶çš„rdbå¿«ç…§æ–‡ä»¶ä¸­
ï¼ˆ4ï¼‰å®Œæˆrdbå¿«ç…§æ–‡ä»¶çš„ç”Ÿæˆä¹‹åï¼Œå°±æ›¿æ¢ä¹‹å‰çš„æ—§çš„å¿«ç…§æ–‡ä»¶

dump.rdbï¼Œæ¯æ¬¡ç”Ÿæˆä¸€ä¸ªæ–°çš„å¿«ç…§ï¼Œéƒ½ä¼šè¦†ç›–ä¹‹å‰çš„è€å¿«ç…§

------------------------------------------------------------------------

### 3ã€åŸºäºRDBæŒä¹…åŒ–æœºåˆ¶çš„æ•°æ®æ¢å¤å®éªŒ

ï¼ˆ1ï¼‰åœ¨redisä¸­ä¿å­˜å‡ æ¡æ•°æ®ï¼Œç«‹å³åœæ‰redisè¿›ç¨‹ï¼Œç„¶åé‡å¯redisï¼Œçœ‹çœ‹åˆšæ‰æ’å…¥çš„æ•°æ®è¿˜åœ¨ä¸åœ¨

æ•°æ®è¿˜åœ¨ï¼Œä¸ºä»€ä¹ˆï¼Ÿ

å¸¦å‡ºæ¥ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œé€šè¿‡redis-cli SHUTDOWNè¿™ç§æ–¹å¼å»åœæ‰redisï¼Œå…¶å®æ˜¯ä¸€ç§å®‰å…¨é€€å‡ºçš„æ¨¡å¼ï¼Œredisåœ¨é€€å‡ºçš„æ—¶å€™ä¼šå°†å†…å­˜ä¸­çš„æ•°æ®ç«‹å³ç”Ÿæˆä¸€ä»½å®Œæ•´çš„rdbå¿«ç…§

/var/redis/6379/dump.rdb

ï¼ˆ2ï¼‰åœ¨redisä¸­å†ä¿å­˜å‡ æ¡æ–°çš„æ•°æ®ï¼Œç”¨kill -9ç²—æš´æ€æ­»redisè¿›ç¨‹ï¼Œæ¨¡æ‹Ÿredisæ•…éšœå¼‚å¸¸é€€å‡ºï¼Œå¯¼è‡´å†…å­˜æ•°æ®ä¸¢å¤±çš„åœºæ™¯

è¿™æ¬¡å°±å‘ç°ï¼Œredisè¿›ç¨‹å¼‚å¸¸è¢«æ€æ‰ï¼Œæ•°æ®æ²¡æœ‰è¿›dumpæ–‡ä»¶ï¼Œå‡ æ¡æœ€æ–°çš„æ•°æ®å°±ä¸¢å¤±äº†

ï¼ˆ2ï¼‰æ‰‹åŠ¨è®¾ç½®ä¸€ä¸ªsaveæ£€æŸ¥ç‚¹ï¼Œsave 5 1
ï¼ˆ3ï¼‰å†™å…¥å‡ æ¡æ•°æ®ï¼Œç­‰å¾…5ç§’é’Ÿï¼Œä¼šå‘ç°è‡ªåŠ¨è¿›è¡Œäº†ä¸€æ¬¡dump rdbå¿«ç…§ï¼Œåœ¨dump.rdbä¸­å‘ç°äº†æ•°æ®
ï¼ˆ4ï¼‰å¼‚å¸¸åœæ‰redisè¿›ç¨‹ï¼Œå†é‡æ–°å¯åŠ¨redisï¼Œçœ‹åˆšæ‰æ’å…¥çš„æ•°æ®è¿˜åœ¨

rdbçš„æ‰‹åŠ¨é…ç½®æ£€æŸ¥ç‚¹ï¼Œä»¥åŠrdbå¿«ç…§çš„ç”Ÿæˆï¼ŒåŒ…æ‹¬æ•°æ®çš„ä¸¢å¤±å’Œæ¢å¤ï¼Œå…¨éƒ½æ¼”ç¤ºè¿‡äº†

# AOFæŒä¹…åŒ–çš„é…ç½®

1ã€AOFæŒä¹…åŒ–çš„é…ç½®
2ã€AOFæŒä¹…åŒ–çš„æ•°æ®æ¢å¤å®éªŒ
3ã€AOF rewrite
4ã€AOFç ´æŸæ–‡ä»¶çš„ä¿®å¤
5ã€AOFå’ŒRDBåŒæ—¶å·¥ä½œ

------------------------------------------------------------------------------

### 1ã€AOFæŒä¹…åŒ–çš„é…ç½®

AOFæŒä¹…åŒ–ï¼Œé»˜è®¤æ˜¯å…³é—­çš„ï¼Œé»˜è®¤æ˜¯æ‰“å¼€RDBæŒä¹…åŒ–

appendonly yesï¼Œå¯ä»¥æ‰“å¼€AOFæŒä¹…åŒ–æœºåˆ¶ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒé‡Œé¢ï¼Œä¸€èˆ¬æ¥è¯´AOFéƒ½æ˜¯è¦æ‰“å¼€çš„ï¼Œé™¤éä½ è¯´éšä¾¿ä¸¢ä¸ªå‡ åˆ†é’Ÿçš„æ•°æ®ä¹Ÿæ— æ‰€è°“

æ‰“å¼€AOFæŒä¹…åŒ–æœºåˆ¶ä¹‹åï¼Œredisæ¯æ¬¡æ¥æ”¶åˆ°ä¸€æ¡å†™å‘½ä»¤ï¼Œå°±ä¼šå†™å…¥æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œå½“ç„¶æ˜¯å…ˆå†™å…¥os cacheçš„ï¼Œç„¶åæ¯éš”ä¸€å®šæ—¶é—´å†fsyncä¸€ä¸‹

è€Œä¸”å³ä½¿AOFå’ŒRDBéƒ½å¼€å¯äº†ï¼Œredisé‡å¯çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯ä¼˜å…ˆé€šè¿‡AOFè¿›è¡Œæ•°æ®æ¢å¤çš„ï¼Œå› ä¸ºaofæ•°æ®æ¯”è¾ƒå®Œæ•´

å¯ä»¥é…ç½®AOFçš„fsyncç­–ç•¥ï¼Œæœ‰ä¸‰ç§ç­–ç•¥å¯ä»¥é€‰æ‹©ï¼Œä¸€ç§æ˜¯æ¯æ¬¡å†™å…¥ä¸€æ¡æ•°æ®å°±æ‰§è¡Œä¸€æ¬¡fsync; ä¸€ç§æ˜¯æ¯éš”ä¸€ç§’æ‰§è¡Œä¸€æ¬¡fsync; ä¸€ç§æ˜¯ä¸ä¸»åŠ¨æ‰§è¡Œfsync

always: æ¯æ¬¡å†™å…¥ä¸€æ¡æ•°æ®ï¼Œç«‹å³å°†è¿™ä¸ªæ•°æ®å¯¹åº”çš„å†™æ—¥å¿—fsyncåˆ°ç£ç›˜ä¸Šå»ï¼Œæ€§èƒ½éå¸¸éå¸¸å·®ï¼Œååé‡å¾ˆä½; ç¡®ä¿è¯´redisé‡Œçš„æ•°æ®ä¸€æ¡éƒ½ä¸ä¸¢ï¼Œé‚£å°±åªèƒ½è¿™æ ·äº†

mysql -> å†…å­˜ç­–ç•¥ï¼Œå¤§é‡ç£ç›˜ï¼ŒQPSåˆ°å¤šå°‘ï¼Œä¸€ä¸¤kã€‚QPSï¼Œæ¯ç§’é’Ÿçš„è¯·æ±‚æ•°é‡
redis -> å†…å­˜ï¼Œç£ç›˜æŒä¹…åŒ–ï¼ŒQPSåˆ°å¤šå°‘ï¼Œå•æœºï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸Šä¸‡QPSæ²¡é—®é¢˜

everysec: æ¯ç§’å°†os cacheä¸­çš„æ•°æ®fsyncåˆ°ç£ç›˜ï¼Œè¿™ä¸ªæœ€å¸¸ç”¨çš„ï¼Œç”Ÿäº§ç¯å¢ƒä¸€èˆ¬éƒ½è¿™ä¹ˆé…ç½®ï¼Œæ€§èƒ½å¾ˆé«˜ï¼ŒQPSè¿˜æ˜¯å¯ä»¥ä¸Šä¸‡çš„

no: ä»…ä»…redisè´Ÿè´£å°†æ•°æ®å†™å…¥os cacheå°±æ’’æ‰‹ä¸ç®¡äº†ï¼Œç„¶ååé¢osè‡ªå·±ä¼šæ—¶ä¸æ—¶æœ‰è‡ªå·±çš„ç­–ç•¥å°†æ•°æ®åˆ·å…¥ç£ç›˜ï¼Œä¸å¯æ§äº†

------------------------------------------------------------------------------

### 2ã€AOFæŒä¹…åŒ–çš„æ•°æ®æ¢å¤å®éªŒ

ï¼ˆ1ï¼‰å…ˆä»…ä»…æ‰“å¼€RDBï¼Œå†™å…¥ä¸€äº›æ•°æ®ï¼Œç„¶åkill -9æ€æ‰redisè¿›ç¨‹ï¼Œæ¥ç€é‡å¯redisï¼Œå‘ç°æ•°æ®æ²¡äº†ï¼Œå› ä¸ºRDBå¿«ç…§è¿˜æ²¡ç”Ÿæˆ
ï¼ˆ2ï¼‰æ‰“å¼€AOFçš„å¼€å…³ï¼Œå¯ç”¨AOFæŒä¹…åŒ–
ï¼ˆ3ï¼‰å†™å…¥ä¸€äº›æ•°æ®ï¼Œè§‚å¯ŸAOFæ–‡ä»¶ä¸­çš„æ—¥å¿—å†…å®¹

å…¶å®ä½ åœ¨appendonly.aofæ–‡ä»¶ä¸­ï¼Œå¯ä»¥çœ‹åˆ°åˆšå†™çš„æ—¥å¿—ï¼Œå®ƒä»¬å…¶å®å°±æ˜¯å…ˆå†™å…¥os cacheçš„ï¼Œç„¶å1ç§’åæ‰fsyncåˆ°ç£ç›˜ä¸­ï¼Œåªæœ‰fsyncåˆ°ç£ç›˜ä¸­äº†ï¼Œæ‰æ˜¯å®‰å…¨çš„ï¼Œè¦ä¸ç„¶å…‰æ˜¯åœ¨os cacheä¸­ï¼Œæœºå™¨åªè¦é‡å¯ï¼Œå°±ä»€ä¹ˆéƒ½æ²¡äº†

ï¼ˆ4ï¼‰kill -9æ€æ‰redisè¿›ç¨‹ï¼Œé‡æ–°å¯åŠ¨redisè¿›ç¨‹ï¼Œå‘ç°æ•°æ®è¢«æ¢å¤å›æ¥äº†ï¼Œå°±æ˜¯ä»AOFæ–‡ä»¶ä¸­æ¢å¤å›æ¥çš„

redisè¿›ç¨‹å¯åŠ¨çš„æ—¶å€™ï¼Œç›´æ¥å°±ä¼šä»appendonly.aofä¸­åŠ è½½æ‰€æœ‰çš„æ—¥å¿—ï¼ŒæŠŠå†…å­˜ä¸­çš„æ•°æ®æ¢å¤å›æ¥

------------------------------------------------------------------------------

### 3ã€AOF rewrite

redisä¸­çš„æ•°æ®å…¶å®æœ‰é™çš„ï¼Œå¾ˆå¤šæ•°æ®å¯èƒ½ä¼šè‡ªåŠ¨è¿‡æœŸï¼Œå¯èƒ½ä¼šè¢«ç”¨æˆ·åˆ é™¤ï¼Œå¯èƒ½ä¼šè¢«redisç”¨ç¼“å­˜æ¸…é™¤çš„ç®—æ³•æ¸…ç†æ‰

redisä¸­çš„æ•°æ®ä¼šä¸æ–­æ·˜æ±°æ‰æ—§çš„ï¼Œå°±ä¸€éƒ¨åˆ†å¸¸ç”¨çš„æ•°æ®ä¼šè¢«è‡ªåŠ¨ä¿ç•™åœ¨rediså†…å­˜ä¸­

æ‰€ä»¥å¯èƒ½å¾ˆå¤šä¹‹å‰çš„å·²ç»è¢«æ¸…ç†æ‰çš„æ•°æ®ï¼Œå¯¹åº”çš„å†™æ—¥å¿—è¿˜åœç•™åœ¨AOFä¸­ï¼ŒAOFæ—¥å¿—æ–‡ä»¶å°±ä¸€ä¸ªï¼Œä¼šä¸æ–­çš„è†¨èƒ€ï¼Œåˆ°å¾ˆå¤§å¾ˆå¤§

æ‰€ä»¥AOFä¼šè‡ªåŠ¨åœ¨åå°æ¯éš”ä¸€å®šæ—¶é—´åšrewriteæ“ä½œï¼Œæ¯”å¦‚æ—¥å¿—é‡Œå·²ç»å­˜æ”¾äº†é’ˆå¯¹100wæ•°æ®çš„å†™æ—¥å¿—äº†; rediså†…å­˜åªå‰©ä¸‹10ä¸‡; åŸºäºå†…å­˜ä¸­å½“å‰çš„10ä¸‡æ•°æ®æ„å»ºä¸€å¥—æœ€æ–°çš„æ—¥å¿—ï¼Œåˆ°AOFä¸­; è¦†ç›–ä¹‹å‰çš„è€æ—¥å¿—; ç¡®ä¿AOFæ—¥å¿—æ–‡ä»¶ä¸ä¼šè¿‡å¤§ï¼Œä¿æŒè·Ÿrediså†…å­˜æ•°æ®é‡ä¸€è‡´

redis 2.4ä¹‹å‰ï¼Œè¿˜éœ€è¦æ‰‹åŠ¨ï¼Œå¼€å‘ä¸€äº›è„šæœ¬ï¼Œcrontabï¼Œé€šè¿‡BGREWRITEAOFå‘½ä»¤å»æ‰§è¡ŒAOF rewriteï¼Œä½†æ˜¯redis 2.4ä¹‹åï¼Œä¼šè‡ªåŠ¨è¿›è¡Œrewriteæ“ä½œ

åœ¨redis.confä¸­ï¼Œå¯ä»¥é…ç½®rewriteç­–ç•¥

auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

æ¯”å¦‚è¯´ä¸Šä¸€æ¬¡AOF rewriteä¹‹åï¼Œæ˜¯128mb

ç„¶åå°±ä¼šæ¥ç€128mbç»§ç»­å†™AOFçš„æ—¥å¿—ï¼Œå¦‚æœå‘ç°å¢é•¿çš„æ¯”ä¾‹ï¼Œè¶…è¿‡äº†ä¹‹å‰çš„100%ï¼Œ256mbï¼Œå°±å¯èƒ½ä¼šå»è§¦å‘ä¸€æ¬¡rewrite

ä½†æ˜¯æ­¤æ—¶è¿˜è¦å»è·Ÿmin-sizeï¼Œ64mbå»æ¯”è¾ƒï¼Œ256mb > 64mbï¼Œæ‰ä¼šå»è§¦å‘rewrite

ï¼ˆ1ï¼‰redis forkä¸€ä¸ªå­è¿›ç¨‹
ï¼ˆ2ï¼‰å­è¿›ç¨‹åŸºäºå½“å‰å†…å­˜ä¸­çš„æ•°æ®ï¼Œæ„å»ºæ—¥å¿—ï¼Œå¼€å§‹å¾€ä¸€ä¸ªæ–°çš„ä¸´æ—¶çš„AOFæ–‡ä»¶ä¸­å†™å…¥æ—¥å¿—
ï¼ˆ3ï¼‰redisä¸»è¿›ç¨‹ï¼Œæ¥æ”¶åˆ°clientæ–°çš„å†™æ“ä½œä¹‹åï¼Œåœ¨å†…å­˜ä¸­å†™å…¥æ—¥å¿—ï¼ŒåŒæ—¶æ–°çš„æ—¥å¿—ä¹Ÿç»§ç»­å†™å…¥æ—§çš„AOFæ–‡ä»¶
ï¼ˆ4ï¼‰å­è¿›ç¨‹å†™å®Œæ–°çš„æ—¥å¿—æ–‡ä»¶ä¹‹åï¼Œredisä¸»è¿›ç¨‹å°†å†…å­˜ä¸­çš„æ–°æ—¥å¿—å†æ¬¡è¿½åŠ åˆ°æ–°çš„AOFæ–‡ä»¶ä¸­
ï¼ˆ5ï¼‰ç”¨æ–°çš„æ—¥å¿—æ–‡ä»¶æ›¿æ¢æ‰æ—§çš„æ—¥å¿—æ–‡ä»¶

------------------------------------------------------------------------------

### 4ã€AOFç ´æŸæ–‡ä»¶çš„ä¿®å¤

å¦‚æœredisåœ¨appendæ•°æ®åˆ°AOFæ–‡ä»¶æ—¶ï¼Œæœºå™¨å®•æœºäº†ï¼Œå¯èƒ½ä¼šå¯¼è‡´AOFæ–‡ä»¶ç ´æŸ

ç”¨redis-check-aof --fixå‘½ä»¤æ¥ä¿®å¤ç ´æŸçš„AOFæ–‡ä»¶

------------------------------------------------------------------------------

### 5ã€AOFå’ŒRDBåŒæ—¶å·¥ä½œ

ï¼ˆ1ï¼‰å¦‚æœRDBåœ¨æ‰§è¡Œsnapshottingæ“ä½œï¼Œé‚£ä¹ˆredisä¸ä¼šæ‰§è¡ŒAOF rewrite; å¦‚æœrediså†æ‰§è¡ŒAOF rewriteï¼Œé‚£ä¹ˆå°±ä¸ä¼šæ‰§è¡ŒRDB snapshotting
ï¼ˆ2ï¼‰å¦‚æœRDBåœ¨æ‰§è¡Œsnapshottingï¼Œæ­¤æ—¶ç”¨æˆ·æ‰§è¡ŒBGREWRITEAOFå‘½ä»¤ï¼Œé‚£ä¹ˆç­‰RDBå¿«ç…§ç”Ÿæˆä¹‹åï¼Œæ‰ä¼šå»æ‰§è¡ŒAOF rewrite
ï¼ˆ3ï¼‰åŒæ—¶æœ‰RDB snapshotæ–‡ä»¶å’ŒAOFæ—¥å¿—æ–‡ä»¶ï¼Œé‚£ä¹ˆredisé‡å¯çš„æ—¶å€™ï¼Œä¼šä¼˜å…ˆä½¿ç”¨AOFè¿›è¡Œæ•°æ®æ¢å¤ï¼Œå› ä¸ºå…¶ä¸­çš„æ—¥å¿—æ›´å®Œæ•´

------------------------------------------------------------------------------

### 6ã€æœ€åä¸€ä¸ªå°å®éªŒï¼Œè®©å¤§å®¶å¯¹redisçš„æ•°æ®æ¢å¤æœ‰æ›´åŠ æ·±åˆ»çš„ä½“ä¼š

ï¼ˆ1ï¼‰åœ¨æœ‰rdbçš„dumpå’Œaofçš„appendonlyçš„åŒæ—¶ï¼Œrdbé‡Œä¹Ÿæœ‰éƒ¨åˆ†æ•°æ®ï¼Œaofé‡Œä¹Ÿæœ‰éƒ¨åˆ†æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™å…¶å®ä¼šå‘ç°ï¼Œrdbçš„æ•°æ®ä¸ä¼šæ¢å¤åˆ°å†…å­˜ä¸­
ï¼ˆ2ï¼‰æˆ‘ä»¬æ¨¡æ‹Ÿè®©aofç ´æŸï¼Œç„¶åfixï¼Œæœ‰ä¸€æ¡æ•°æ®ä¼šè¢«fixåˆ é™¤
ï¼ˆ3ï¼‰å†æ¬¡ç”¨fixå¾—aofæ–‡ä»¶å»é‡å¯redisï¼Œå‘ç°æ•°æ®åªå‰©ä¸‹ä¸€æ¡äº†

æ•°æ®æ¢å¤å®Œå…¨æ˜¯ä¾èµ–äºåº•å±‚çš„ç£ç›˜çš„æŒä¹…åŒ–çš„ï¼Œä¸»è¦rdbå’Œaofä¸Šéƒ½æ²¡æœ‰æ•°æ®ï¼Œé‚£å°±æ²¡äº†

# ä¼ä¸šçº§çš„æ•°æ®å¤‡ä»½å’Œå„ç§ç¾éš¾ä¸‹çš„æ•°æ®æ¢å¤ï¼Œæ˜¯æ€ä¹ˆåšå¾—å‘¢ï¼Ÿ

### 1ã€ä¼ä¸šçº§çš„æŒä¹…åŒ–çš„é…ç½®ç­–ç•¥

åœ¨ä¼ä¸šä¸­ï¼ŒRDBçš„ç”Ÿæˆç­–ç•¥ï¼Œç”¨é»˜è®¤çš„ä¹Ÿå·®ä¸å¤š

save 60 10000ï¼šå¦‚æœä½ å¸Œæœ›å°½å¯èƒ½ç¡®ä¿è¯´ï¼ŒRDBæœ€å¤šä¸¢1åˆ†é’Ÿçš„æ•°æ®ï¼Œé‚£ä¹ˆå°½é‡å°±æ˜¯æ¯éš”1åˆ†é’Ÿéƒ½ç”Ÿæˆä¸€ä¸ªå¿«ç…§ï¼Œä½å³°æœŸï¼Œæ•°æ®é‡å¾ˆå°‘ï¼Œä¹Ÿæ²¡å¿…è¦

10000->ç”ŸæˆRDBï¼Œ1000->RDBï¼Œè¿™ä¸ªæ ¹æ®ä½ è‡ªå·±çš„åº”ç”¨å’Œä¸šåŠ¡çš„æ•°æ®é‡ï¼Œä½ è‡ªå·±å»å†³å®š

AOFä¸€å®šè¦æ‰“å¼€ï¼Œfsyncï¼Œeverysec

auto-aof-rewrite-percentage 100: å°±æ˜¯å½“å‰AOFå¤§å°è†¨èƒ€åˆ°è¶…è¿‡ä¸Šæ¬¡100%ï¼Œä¸Šæ¬¡çš„ä¸¤å€
auto-aof-rewrite-min-size 64mb: æ ¹æ®ä½ çš„æ•°æ®é‡æ¥å®šï¼Œ16mbï¼Œ32mb

### 2ã€ä¼ä¸šçº§çš„æ•°æ®å¤‡ä»½æ–¹æ¡ˆ

RDBéå¸¸é€‚åˆåšå†·å¤‡ï¼Œæ¯æ¬¡ç”Ÿæˆä¹‹åï¼Œå°±ä¸ä¼šå†æœ‰ä¿®æ”¹äº†

æ•°æ®å¤‡ä»½æ–¹æ¡ˆ

ï¼ˆ1ï¼‰å†™crontabå®šæ—¶è°ƒåº¦è„šæœ¬å»åšæ•°æ®å¤‡ä»½
ï¼ˆ2ï¼‰æ¯å°æ—¶éƒ½copyä¸€ä»½rdbçš„å¤‡ä»½ï¼Œåˆ°ä¸€ä¸ªç›®å½•ä¸­å»ï¼Œä»…ä»…ä¿ç•™æœ€è¿‘48å°æ—¶çš„å¤‡ä»½
ï¼ˆ3ï¼‰æ¯å¤©éƒ½ä¿ç•™ä¸€ä»½å½“æ—¥çš„rdbçš„å¤‡ä»½ï¼Œåˆ°ä¸€ä¸ªç›®å½•ä¸­å»ï¼Œä»…ä»…ä¿ç•™æœ€è¿‘1ä¸ªæœˆçš„å¤‡ä»½
ï¼ˆ4ï¼‰æ¯æ¬¡copyå¤‡ä»½çš„æ—¶å€™ï¼Œéƒ½æŠŠå¤ªæ—§çš„å¤‡ä»½ç»™åˆ äº†
ï¼ˆ5ï¼‰æ¯å¤©æ™šä¸Šå°†å½“å‰æœåŠ¡å™¨ä¸Šæ‰€æœ‰çš„æ•°æ®å¤‡ä»½ï¼Œå‘é€ä¸€ä»½åˆ°è¿œç¨‹çš„äº‘æœåŠ¡ä¸Šå»

```sh
/usr/local/redis

æ¯å°æ—¶copyä¸€æ¬¡å¤‡ä»½ï¼Œåˆ é™¤48å°æ—¶å‰çš„æ•°æ®

crontab -e

0 * * * * sh /usr/local/redis/copy/redis_rdb_copy_hourly.sh

redis_rdb_copy_hourly.sh

#!/bin/sh 

cur_date=`date +%Y%m%d%k`
rm -rf /usr/local/redis/snapshotting/$cur_date
mkdir /usr/local/redis/snapshotting/$cur_date
cp /var/redis/6379/dump.rdb /usr/local/redis/snapshotting/$cur_date

del_date=`date -d -48hour +%Y%m%d%k`
rm -rf /usr/local/redis/snapshotting/$del_date

æ¯å¤©copyä¸€æ¬¡å¤‡ä»½

crontab -e

0 0 * * * sh /usr/local/redis/copy/redis_rdb_copy_daily.sh

redis_rdb_copy_daily.sh

#!/bin/sh 

cur_date=`date +%Y%m%d`
rm -rf /usr/local/redis/snapshotting/$cur_date
mkdir /usr/local/redis/snapshotting/$cur_date
cp /var/redis/6379/dump.rdb /usr/local/redis/snapshotting/$cur_date

del_date=`date -d -1month +%Y%m%d`
rm -rf /usr/local/redis/snapshotting/$del_date

æ¯å¤©ä¸€æ¬¡å°†æ‰€æœ‰æ•°æ®ä¸Šä¼ ä¸€æ¬¡åˆ°è¿œç¨‹çš„äº‘æœåŠ¡å™¨ä¸Šå»
```

### 3ã€æ•°æ®æ¢å¤æ–¹æ¡ˆ

ï¼ˆ1ï¼‰å¦‚æœæ˜¯redisè¿›ç¨‹æŒ‚æ‰ï¼Œé‚£ä¹ˆé‡å¯redisè¿›ç¨‹å³å¯ï¼Œç›´æ¥åŸºäºAOFæ—¥å¿—æ–‡ä»¶æ¢å¤æ•°æ®

ä¸æ¼”ç¤ºäº†ï¼Œåœ¨AOFæ•°æ®æ¢å¤é‚£ä¸€å—ï¼Œæ¼”ç¤ºäº†ï¼Œfsync everysecï¼Œæœ€å¤šå°±ä¸¢ä¸€ç§’çš„æ•°æ® 

ï¼ˆ2ï¼‰å¦‚æœæ˜¯redisè¿›ç¨‹æ‰€åœ¨æœºå™¨æŒ‚æ‰ï¼Œé‚£ä¹ˆé‡å¯æœºå™¨åï¼Œå°è¯•é‡å¯redisè¿›ç¨‹ï¼Œå°è¯•ç›´æ¥åŸºäºAOFæ—¥å¿—æ–‡ä»¶è¿›è¡Œæ•°æ®æ¢å¤

AOFæ²¡æœ‰ç ´æŸï¼Œä¹Ÿæ˜¯å¯ä»¥ç›´æ¥åŸºäºAOFæ¢å¤çš„

AOF append-onlyï¼Œé¡ºåºå†™å…¥ï¼Œå¦‚æœAOFæ–‡ä»¶ç ´æŸï¼Œé‚£ä¹ˆç”¨redis-check-aof fix

ï¼ˆ3ï¼‰å¦‚æœrediså½“å‰æœ€æ–°çš„AOFå’ŒRDBæ–‡ä»¶å‡ºç°äº†ä¸¢å¤±/æŸåï¼Œé‚£ä¹ˆå¯ä»¥å°è¯•åŸºäºè¯¥æœºå™¨ä¸Šå½“å‰çš„æŸä¸ªæœ€æ–°çš„RDBæ•°æ®å‰¯æœ¬è¿›è¡Œæ•°æ®æ¢å¤

å½“å‰æœ€æ–°çš„AOFå’ŒRDBæ–‡ä»¶éƒ½å‡ºç°äº†ä¸¢å¤±/æŸååˆ°æ— æ³•æ¢å¤ï¼Œä¸€èˆ¬ä¸æ˜¯æœºå™¨çš„æ•…éšœï¼Œäººä¸º

å¤§æ•°æ®ç³»ç»Ÿï¼Œhadoopï¼Œæœ‰äººä¸å°å¿ƒå°±æŠŠhadoopä¸­å­˜å‚¨çš„å¤§é‡çš„æ•°æ®æ–‡ä»¶å¯¹åº”çš„ç›®å½•ï¼Œrm -rfä¸€ä¸‹ï¼Œæˆ‘æœ‹å‹çš„ä¸€ä¸ªå°å…¬å¸ï¼Œè¿ç»´ä¸å¤ªé è°±ï¼Œæƒé™ä¹Ÿå¼„çš„ä¸å¤ªå¥½

/var/redis/6379ä¸‹çš„æ–‡ä»¶ç»™åˆ é™¤äº†

æ‰¾åˆ°RDBæœ€æ–°çš„ä¸€ä»½å¤‡ä»½ï¼Œå°æ—¶çº§çš„å¤‡ä»½å¯ä»¥äº†ï¼Œå°æ—¶çº§çš„è‚¯å®šæ˜¯æœ€æ–°çš„ï¼Œcopyåˆ°redisé‡Œé¢å»ï¼Œå°±å¯ä»¥æ¢å¤åˆ°æŸä¸€ä¸ªå°æ—¶çš„æ•°æ®

å®¹ç¾æ¼”ç»ƒ

æˆ‘è·Ÿå¤§å®¶è§£é‡Šä¸€ä¸‹ï¼Œæˆ‘å…¶å®ä¸Šè¯¾ï¼Œä¸ºä»€ä¹ˆå¤§é‡çš„è®²å¸ˆå¯èƒ½è®²è¯¾å°±æ˜¯çº¯PPTï¼Œæˆ–è€…æ˜¯å„ç§å¤åˆ¶ç²˜è´´ï¼Œéƒ½ä¸æ˜¯ç°åœºè®²è§£å’Œå†™ä»£ç æ¼”ç¤ºçš„

å¾ˆå®¹æ˜“å‡ºé”™ï¼Œä¸ºäº†é¿å…å‡ºé”™ï¼Œä¸€èˆ¬å°±ä¼šé‚£æ ·ç©å„¿

åæ§½ï¼Œå¿µPPTï¼Œæ•ˆæœå¾ˆå·®

çœŸå®çš„ï¼Œå¤‡è¯¾ï¼Œè®²è¯¾ä¸å¯é¿å…ï¼Œä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼Œä½†æ˜¯æˆ‘è§‰å¾—è¿˜å¥½ï¼ŒçœŸå®

appendonly.aof + dump.rdbï¼Œä¼˜å…ˆç”¨appendonly.aofå»æ¢å¤æ•°æ®ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°redisè‡ªåŠ¨ç”Ÿæˆçš„appendonly.aofæ˜¯æ²¡æœ‰æ•°æ®çš„

ç„¶åæˆ‘ä»¬è‡ªå·±çš„dump.rdbæ˜¯æœ‰æ•°æ®çš„ï¼Œä½†æ˜¯æ˜æ˜¾æ²¡ç”¨æˆ‘ä»¬çš„æ•°æ®

rediså¯åŠ¨çš„æ—¶å€™ï¼Œè‡ªåŠ¨é‡æ–°åŸºäºå†…å­˜çš„æ•°æ®ï¼Œç”Ÿæˆäº†ä¸€ä»½æœ€æ–°çš„rdbå¿«ç…§ï¼Œç›´æ¥ç”¨ç©ºçš„æ•°æ®ï¼Œè¦†ç›–æ‰äº†æˆ‘ä»¬æœ‰æ•°æ®çš„ï¼Œæ‹·è´è¿‡å»çš„é‚£ä»½dump.rdb

ä½ åœæ­¢redisä¹‹åï¼Œå…¶å®åº”è¯¥å…ˆåˆ é™¤appendonly.aofï¼Œç„¶åå°†æˆ‘ä»¬çš„dump.rdbæ‹·è´è¿‡å»ï¼Œç„¶åå†é‡å¯redis

å¾ˆç®€å•ï¼Œå°±æ˜¯è™½ç„¶ä½ åˆ é™¤äº†appendonly.aofï¼Œä½†æ˜¯å› ä¸ºæ‰“å¼€äº†aofæŒä¹…åŒ–ï¼Œrediså°±ä¸€å®šä¼šä¼˜å…ˆåŸºäºaofå»æ¢å¤ï¼Œå³ä½¿æ–‡ä»¶ä¸åœ¨ï¼Œé‚£å°±åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºçš„aofæ–‡ä»¶

åœæ­¢redisï¼Œæš‚æ—¶åœ¨é…ç½®ä¸­å…³é—­aofï¼Œç„¶åæ‹·è´ä¸€ä»½rdbè¿‡æ¥ï¼Œå†é‡å¯redisï¼Œæ•°æ®èƒ½ä¸èƒ½æ¢å¤è¿‡æ¥ï¼Œå¯ä»¥æ¢å¤è¿‡æ¥

è„‘å­ä¸€çƒ­ï¼Œå†å…³æ‰redisï¼Œæ‰‹åŠ¨ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œæ‰“å¼€aofï¼Œå†é‡å¯redisï¼Œæ•°æ®åˆæ²¡äº†ï¼Œç©ºçš„aofæ–‡ä»¶ï¼Œæ‰€æœ‰æ•°æ®åˆæ²¡äº†

åœ¨æ•°æ®å®‰å…¨ä¸¢å¤±çš„æƒ…å†µä¸‹ï¼ŒåŸºäºrdbå†·å¤‡ï¼Œå¦‚ä½•å®Œç¾çš„æ¢å¤æ•°æ®ï¼ŒåŒæ—¶è¿˜ä¿æŒaofå’Œrdbçš„åŒå¼€

åœæ­¢redisï¼Œå…³é—­aofï¼Œæ‹·è´rdbå¤‡ä»½ï¼Œé‡å¯redisï¼Œç¡®è®¤æ•°æ®æ¢å¤ï¼Œç›´æ¥åœ¨å‘½ä»¤è¡Œçƒ­ä¿®æ”¹redisé…ç½®ï¼Œæ‰“å¼€aofï¼Œè¿™ä¸ªrediså°±ä¼šå°†å†…å­˜ä¸­çš„æ•°æ®å¯¹åº”çš„æ—¥å¿—ï¼Œå†™å…¥aofæ–‡ä»¶ä¸­

æ­¤æ—¶aofå’Œrdbä¸¤ä»½æ•°æ®æ–‡ä»¶çš„æ•°æ®å°±åŒæ­¥äº†

redis config setçƒ­ä¿®æ”¹é…ç½®å‚æ•°ï¼Œå¯èƒ½é…ç½®æ–‡ä»¶ä¸­çš„å®é™…çš„å‚æ•°æ²¡æœ‰è¢«æŒä¹…åŒ–çš„ä¿®æ”¹ï¼Œå†æ¬¡åœæ­¢redisï¼Œæ‰‹åŠ¨ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œæ‰“å¼€aofçš„å‘½ä»¤ï¼Œå†æ¬¡é‡å¯redis

ï¼ˆ4ï¼‰å¦‚æœå½“å‰æœºå™¨ä¸Šçš„æ‰€æœ‰RDBæ–‡ä»¶å…¨éƒ¨æŸåï¼Œé‚£ä¹ˆä»è¿œç¨‹çš„äº‘æœåŠ¡ä¸Šæ‹‰å–æœ€æ–°çš„RDBå¿«ç…§å›æ¥æ¢å¤æ•°æ®

ï¼ˆ5ï¼‰å¦‚æœæ˜¯å‘ç°æœ‰é‡å¤§çš„æ•°æ®é”™è¯¯ï¼Œæ¯”å¦‚æŸä¸ªå°æ—¶ä¸Šçº¿çš„ç¨‹åºä¸€ä¸‹å­å°†æ•°æ®å…¨éƒ¨æ±¡æŸ“äº†ï¼Œæ•°æ®å…¨é”™äº†ï¼Œé‚£ä¹ˆå¯ä»¥é€‰æ‹©æŸä¸ªæ›´æ—©çš„æ—¶é—´ç‚¹ï¼Œå¯¹æ•°æ®è¿›è¡Œæ¢å¤

ä¸¾ä¸ªä¾‹å­ï¼Œ12ç‚¹ä¸Šçº¿äº†ä»£ç ï¼Œå‘ç°ä»£ç æœ‰bugï¼Œå¯¼è‡´ä»£ç ç”Ÿæˆçš„æ‰€æœ‰çš„ç¼“å­˜æ•°æ®ï¼Œå†™å…¥redisï¼Œå…¨éƒ¨é”™äº†

æ‰¾åˆ°ä¸€ä»½11ç‚¹çš„rdbçš„å†·å¤‡ï¼Œç„¶åæŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤ï¼Œå»æ¢å¤åˆ°11ç‚¹çš„æ•°æ®ï¼Œä¸å°±å¯ä»¥äº†å—

# æ”¯æ’‘è¶…è¿‡10ä¸‡+çš„å¹¶å‘

### 1ã€redisé«˜å¹¶å‘è·Ÿæ•´ä¸ªç³»ç»Ÿçš„é«˜å¹¶å‘ä¹‹é—´çš„å…³ç³»

redisï¼Œä½ è¦æé«˜å¹¶å‘çš„è¯ï¼Œä¸å¯é¿å…ï¼Œè¦æŠŠåº•å±‚çš„ç¼“å­˜æå¾—å¾ˆå¥½

mysqlï¼Œé«˜å¹¶å‘ï¼Œåšåˆ°äº†ï¼Œé‚£ä¹ˆä¹Ÿæ˜¯é€šè¿‡ä¸€ç³»åˆ—å¤æ‚çš„åˆ†åº“åˆ†è¡¨ï¼Œè®¢å•ç³»ç»Ÿï¼Œäº‹åŠ¡è¦æ±‚çš„ï¼ŒQPSåˆ°å‡ ä¸‡ï¼Œæ¯”è¾ƒé«˜äº†

è¦åšä¸€äº›ç”µå•†çš„å•†å“è¯¦æƒ…é¡µï¼ŒçœŸæ­£çš„è¶…é«˜å¹¶å‘ï¼ŒQPSä¸Šåä¸‡ï¼Œç”šè‡³æ˜¯ç™¾ä¸‡ï¼Œä¸€ç§’é’Ÿç™¾ä¸‡çš„è¯·æ±‚é‡

å…‰æ˜¯redisæ˜¯ä¸å¤Ÿçš„ï¼Œä½†æ˜¯redisæ˜¯æ•´ä¸ªå¤§å‹çš„ç¼“å­˜æ¶æ„ä¸­ï¼Œæ”¯æ’‘é«˜å¹¶å‘çš„æ¶æ„é‡Œé¢ï¼Œéå¸¸é‡è¦çš„ä¸€ä¸ªç¯èŠ‚

é¦–å…ˆï¼Œä½ çš„åº•å±‚çš„ç¼“å­˜ä¸­é—´ä»¶ï¼Œç¼“å­˜ç³»ç»Ÿï¼Œå¿…é¡»èƒ½å¤Ÿæ”¯æ’‘çš„èµ·æˆ‘ä»¬è¯´çš„é‚£ç§é«˜å¹¶å‘ï¼Œå…¶æ¬¡ï¼Œå†ç»è¿‡è‰¯å¥½çš„æ•´ä½“çš„ç¼“å­˜æ¶æ„çš„è®¾è®¡ï¼ˆå¤šçº§ç¼“å­˜æ¶æ„ã€çƒ­ç‚¹ç¼“å­˜ï¼‰ï¼Œæ”¯æ’‘çœŸæ­£çš„ä¸Šåä¸‡ï¼Œç”šè‡³ä¸Šç™¾ä¸‡çš„é«˜å¹¶å‘

### 2ã€redisä¸èƒ½æ”¯æ’‘é«˜å¹¶å‘çš„ç“¶é¢ˆåœ¨å“ªé‡Œï¼Ÿ

å•æœº

![rediså•æœºçš„ç“¶é¢ˆ](/Users/liujiang/Documents/Typora/imgs/rediså•æœºçš„ç“¶é¢ˆ.png)

### 3ã€å¦‚æœredisè¦æ”¯æ’‘è¶…è¿‡10ä¸‡+çš„å¹¶å‘ï¼Œé‚£åº”è¯¥æ€ä¹ˆåšï¼Ÿ

å•æœºçš„rediså‡ ä¹ä¸å¤ªå¯èƒ½è¯´QPSè¶…è¿‡10ä¸‡+ï¼Œé™¤éä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œæ¯”å¦‚ä½ çš„æœºå™¨æ€§èƒ½ç‰¹åˆ«å¥½ï¼Œé…ç½®ç‰¹åˆ«é«˜ï¼Œç‰©ç†æœºï¼Œç»´æŠ¤åšçš„ç‰¹åˆ«å¥½ï¼Œè€Œä¸”ä½ çš„æ•´ä½“çš„æ“ä½œä¸æ˜¯å¤ªå¤æ‚

å•æœºåœ¨å‡ ä¸‡

è¯»å†™åˆ†ç¦»ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå¯¹ç¼“å­˜ï¼Œä¸€èˆ¬éƒ½æ˜¯ç”¨æ¥æ”¯æ’‘è¯»é«˜å¹¶å‘çš„ï¼Œå†™çš„è¯·æ±‚æ˜¯æ¯”è¾ƒå°‘çš„ï¼Œå¯èƒ½å†™è¯·æ±‚ä¹Ÿå°±ä¸€ç§’é’Ÿå‡ åƒï¼Œä¸€ä¸¤åƒ

å¤§é‡çš„è¯·æ±‚éƒ½æ˜¯è¯»ï¼Œä¸€ç§’é’ŸäºŒåä¸‡æ¬¡è¯»

è¯»å†™åˆ†ç¦»

ä¸»ä»æ¶æ„ -> è¯»å†™åˆ†ç¦» -> æ”¯æ’‘10ä¸‡+è¯»QPSçš„æ¶æ„

![redisä¸»ä»å®ç°è¯»å†™åˆ†ç¦»æ”¯æ’‘10ä¸‡+çš„é«˜å¹¶å‘](/Users/liujiang/Documents/Typora/imgs/redisä¸»ä»å®ç°è¯»å†™åˆ†ç¦»æ”¯æ’‘10ä¸‡+çš„é«˜å¹¶å‘.png)

### 4ã€æ¥ä¸‹æ¥è¦è®²è§£çš„ä¸€ä¸ªtopic

redis replication

redisä¸»ä»æ¶æ„ -> è¯»å†™åˆ†ç¦»æ¶æ„ -> å¯æ”¯æŒæ°´å¹³æ‰©å±•çš„è¯»é«˜å¹¶å‘æ¶æ„

![redis replicaæœ€æœ€åŸºæœ¬çš„åŸç†](/Users/liujiang/Documents/Typora/imgs/redis replicaæœ€æœ€åŸºæœ¬çš„åŸç†.png)

##### redis replicationçš„æ ¸å¿ƒæœºåˆ¶

ï¼ˆ1ï¼‰redisé‡‡ç”¨å¼‚æ­¥æ–¹å¼å¤åˆ¶æ•°æ®åˆ°slaveèŠ‚ç‚¹ï¼Œä¸è¿‡redis 2.8å¼€å§‹ï¼Œslave nodeä¼šå‘¨æœŸæ€§åœ°ç¡®è®¤è‡ªå·±æ¯æ¬¡å¤åˆ¶çš„æ•°æ®é‡
ï¼ˆ2ï¼‰ä¸€ä¸ªmaster nodeæ˜¯å¯ä»¥é…ç½®å¤šä¸ªslave nodeçš„
ï¼ˆ3ï¼‰slave nodeä¹Ÿå¯ä»¥è¿æ¥å…¶ä»–çš„slave node
ï¼ˆ4ï¼‰slave nodeåšå¤åˆ¶çš„æ—¶å€™ï¼Œæ˜¯ä¸ä¼šblock master nodeçš„æ­£å¸¸å·¥ä½œçš„
ï¼ˆ5ï¼‰slave nodeåœ¨åšå¤åˆ¶çš„æ—¶å€™ï¼Œä¹Ÿä¸ä¼šblockå¯¹è‡ªå·±çš„æŸ¥è¯¢æ“ä½œï¼Œå®ƒä¼šç”¨æ—§çš„æ•°æ®é›†æ¥æä¾›æœåŠ¡; ä½†æ˜¯å¤åˆ¶å®Œæˆçš„æ—¶å€™ï¼Œéœ€è¦åˆ é™¤æ—§æ•°æ®é›†ï¼ŒåŠ è½½æ–°æ•°æ®é›†ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šæš‚åœå¯¹å¤–æœåŠ¡äº†
ï¼ˆ6ï¼‰slave nodeä¸»è¦ç”¨æ¥è¿›è¡Œæ¨ªå‘æ‰©å®¹ï¼Œåšè¯»å†™åˆ†ç¦»ï¼Œæ‰©å®¹çš„slave nodeå¯ä»¥æé«˜è¯»çš„ååé‡

slaveï¼Œé«˜å¯ç”¨æ€§ï¼Œæœ‰å¾ˆå¤§çš„å…³ç³»

##### masteræŒä¹…åŒ–å¯¹äºä¸»ä»æ¶æ„çš„å®‰å…¨ä¿éšœçš„æ„ä¹‰

å¦‚æœé‡‡ç”¨äº†ä¸»ä»æ¶æ„ï¼Œé‚£ä¹ˆå»ºè®®å¿…é¡»å¼€å¯master nodeçš„æŒä¹…åŒ–ï¼

ä¸å»ºè®®ç”¨slave nodeä½œä¸ºmaster nodeçš„æ•°æ®çƒ­å¤‡ï¼Œå› ä¸ºé‚£æ ·çš„è¯ï¼Œå¦‚æœä½ å…³æ‰masterçš„æŒä¹…åŒ–ï¼Œå¯èƒ½åœ¨masterå®•æœºé‡å¯çš„æ—¶å€™æ•°æ®æ˜¯ç©ºçš„ï¼Œç„¶åå¯èƒ½ä¸€ç»è¿‡å¤åˆ¶ï¼Œsalve nodeæ•°æ®ä¹Ÿä¸¢äº†

master -> RDBå’ŒAOFéƒ½å…³é—­äº† -> å…¨éƒ¨åœ¨å†…å­˜ä¸­

masterå®•æœºï¼Œé‡å¯ï¼Œæ˜¯æ²¡æœ‰æœ¬åœ°æ•°æ®å¯ä»¥æ¢å¤çš„ï¼Œç„¶åå°±ä¼šç›´æ¥è®¤ä¸ºè‡ªå·±IDEæ•°æ®æ˜¯ç©ºçš„

masterå°±ä¼šå°†ç©ºçš„æ•°æ®é›†åŒæ­¥åˆ°slaveä¸Šå»ï¼Œæ‰€æœ‰slaveçš„æ•°æ®å…¨éƒ¨æ¸…ç©º

100%çš„æ•°æ®ä¸¢å¤±

masterèŠ‚ç‚¹ï¼Œå¿…é¡»è¦ä½¿ç”¨æŒä¹…åŒ–æœºåˆ¶

ç¬¬äºŒä¸ªï¼Œmasterçš„å„ç§å¤‡ä»½æ–¹æ¡ˆï¼Œè¦ä¸è¦åšï¼Œä¸‡ä¸€è¯´æœ¬åœ°çš„æ‰€æœ‰æ–‡ä»¶ä¸¢å¤±äº†; ä»å¤‡ä»½ä¸­æŒ‘é€‰ä¸€ä»½rdbå»æ¢å¤master; è¿™æ ·æ‰èƒ½ç¡®ä¿masterå¯åŠ¨çš„æ—¶å€™ï¼Œæ˜¯æœ‰æ•°æ®çš„

å³ä½¿é‡‡ç”¨äº†åç»­è®²è§£çš„é«˜å¯ç”¨æœºåˆ¶ï¼Œslave nodeå¯ä»¥è‡ªåŠ¨æ¥ç®¡master nodeï¼Œä½†æ˜¯ä¹Ÿå¯èƒ½sentinalè¿˜æ²¡æœ‰æ£€æµ‹åˆ°master failureï¼Œmaster nodeå°±è‡ªåŠ¨é‡å¯äº†ï¼Œè¿˜æ˜¯å¯èƒ½å¯¼è‡´ä¸Šé¢çš„æ‰€æœ‰slave nodeæ•°æ®æ¸…ç©ºæ•…éšœ

![redisä¸»ä»å¤åˆ¶çš„åŸç†](/Users/liujiang/Documents/Typora/imgs/redisä¸»ä»å¤åˆ¶çš„åŸç†.png)

# ä¸»ä»å¤åˆ¶

### 1ã€ä¸»ä»æ¶æ„çš„æ ¸å¿ƒåŸç†

å½“å¯åŠ¨ä¸€ä¸ªslave nodeçš„æ—¶å€™ï¼Œå®ƒä¼šå‘é€ä¸€ä¸ªPSYNCå‘½ä»¤ç»™master node

å¦‚æœè¿™æ˜¯slave nodeé‡æ–°è¿æ¥master nodeï¼Œé‚£ä¹ˆmaster nodeä»…ä»…ä¼šå¤åˆ¶ç»™slaveéƒ¨åˆ†ç¼ºå°‘çš„æ•°æ®; å¦åˆ™å¦‚æœæ˜¯slave nodeç¬¬ä¸€æ¬¡è¿æ¥master nodeï¼Œé‚£ä¹ˆä¼šè§¦å‘ä¸€æ¬¡full resynchronization

å¼€å§‹full resynchronizationçš„æ—¶å€™ï¼Œmasterä¼šå¯åŠ¨ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œå¼€å§‹ç”Ÿæˆä¸€ä»½RDBå¿«ç…§æ–‡ä»¶ï¼ŒåŒæ—¶è¿˜ä¼šå°†ä»å®¢æˆ·ç«¯æ”¶åˆ°çš„æ‰€æœ‰å†™å‘½ä»¤ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚RDBæ–‡ä»¶ç”Ÿæˆå®Œæ¯•ä¹‹åï¼Œmasterä¼šå°†è¿™ä¸ªRDBå‘é€ç»™slaveï¼Œslaveä¼šå…ˆå†™å…¥æœ¬åœ°ç£ç›˜ï¼Œç„¶åå†ä»æœ¬åœ°ç£ç›˜åŠ è½½åˆ°å†…å­˜ä¸­ã€‚ç„¶åmasterä¼šå°†å†…å­˜ä¸­ç¼“å­˜çš„å†™å‘½ä»¤å‘é€ç»™slaveï¼Œslaveä¹Ÿä¼šåŒæ­¥è¿™äº›æ•°æ®ã€‚

slave nodeå¦‚æœè·Ÿmaster nodeæœ‰ç½‘ç»œæ•…éšœï¼Œæ–­å¼€äº†è¿æ¥ï¼Œä¼šè‡ªåŠ¨é‡è¿ã€‚masterå¦‚æœå‘ç°æœ‰å¤šä¸ªslave nodeéƒ½æ¥é‡æ–°è¿æ¥ï¼Œä»…ä»…ä¼šå¯åŠ¨ä¸€ä¸ªrdb saveæ“ä½œï¼Œç”¨ä¸€ä»½æ•°æ®æœåŠ¡æ‰€æœ‰slave nodeã€‚

### 2ã€ä¸»ä»å¤åˆ¶çš„æ–­ç‚¹ç»­ä¼ 

ä»redis 2.8å¼€å§‹ï¼Œå°±æ”¯æŒä¸»ä»å¤åˆ¶çš„æ–­ç‚¹ç»­ä¼ ï¼Œå¦‚æœä¸»ä»å¤åˆ¶è¿‡ç¨‹ä¸­ï¼Œç½‘ç»œè¿æ¥æ–­æ‰äº†ï¼Œé‚£ä¹ˆå¯ä»¥æ¥ç€ä¸Šæ¬¡å¤åˆ¶çš„åœ°æ–¹ï¼Œç»§ç»­å¤åˆ¶ä¸‹å»ï¼Œè€Œä¸æ˜¯ä»å¤´å¼€å§‹å¤åˆ¶ä¸€ä»½

master nodeä¼šåœ¨å†…å­˜ä¸­å¸¸è§ä¸€ä¸ªbacklogï¼Œmasterå’Œslaveéƒ½ä¼šä¿å­˜ä¸€ä¸ªreplica offsetè¿˜æœ‰ä¸€ä¸ªmaster idï¼Œoffsetå°±æ˜¯ä¿å­˜åœ¨backlogä¸­çš„ã€‚å¦‚æœmasterå’Œslaveç½‘ç»œè¿æ¥æ–­æ‰äº†ï¼Œslaveä¼šè®©masterä»ä¸Šæ¬¡çš„replica offsetå¼€å§‹ç»§ç»­å¤åˆ¶

ä½†æ˜¯å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„offsetï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œä¸€æ¬¡resynchronization



### 3ã€æ— ç£ç›˜åŒ–å¤åˆ¶

masteråœ¨å†…å­˜ä¸­ç›´æ¥åˆ›å»ºrdbï¼Œç„¶åå‘é€ç»™slaveï¼Œä¸ä¼šåœ¨è‡ªå·±æœ¬åœ°è½åœ°ç£ç›˜äº†

repl-diskless-sync
repl-diskless-sync-delayï¼Œç­‰å¾…ä¸€å®šæ—¶é•¿å†å¼€å§‹å¤åˆ¶ï¼Œå› ä¸ºè¦ç­‰æ›´å¤šslaveé‡æ–°è¿æ¥è¿‡æ¥

### 4ã€è¿‡æœŸkeyå¤„ç†

slaveä¸ä¼šè¿‡æœŸkeyï¼Œåªä¼šç­‰å¾…masterè¿‡æœŸkeyã€‚å¦‚æœmasterè¿‡æœŸäº†ä¸€ä¸ªkeyï¼Œæˆ–è€…é€šè¿‡LRUæ·˜æ±°äº†ä¸€ä¸ªkeyï¼Œé‚£ä¹ˆä¼šæ¨¡æ‹Ÿä¸€æ¡delå‘½ä»¤å‘é€ç»™slaveã€‚



# å¤åˆ¶

### 1ã€å¤åˆ¶çš„å®Œæ•´æµç¨‹

![å¤åˆ¶çš„å®Œæ•´çš„åŸºæœ¬æµç¨‹](/Users/liujiang/Documents/Typora/imgs/å¤åˆ¶çš„å®Œæ•´çš„åŸºæœ¬æµç¨‹.png)

ï¼ˆ1ï¼‰slave nodeå¯åŠ¨ï¼Œä»…ä»…ä¿å­˜master nodeçš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬master nodeçš„hostå’Œipï¼Œä½†æ˜¯å¤åˆ¶æµç¨‹æ²¡å¼€å§‹

master hostå’Œipæ˜¯ä»å“ªå„¿æ¥çš„ï¼Œredis.confé‡Œé¢çš„slaveofé…ç½®çš„

ï¼ˆ2ï¼‰slave nodeå†…éƒ¨æœ‰ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯ç§’æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„master nodeè¦è¿æ¥å’Œå¤åˆ¶ï¼Œå¦‚æœå‘ç°ï¼Œå°±è·Ÿmaster nodeå»ºç«‹socketç½‘ç»œè¿æ¥
ï¼ˆ3ï¼‰slave nodeå‘é€pingå‘½ä»¤ç»™master node
ï¼ˆ4ï¼‰å£ä»¤è®¤è¯ï¼Œå¦‚æœmasterè®¾ç½®äº†requirepassï¼Œé‚£ä¹ˆsalve nodeå¿…é¡»å‘é€masterauthçš„å£ä»¤è¿‡å»è¿›è¡Œè®¤è¯
ï¼ˆ5ï¼‰master nodeç¬¬ä¸€æ¬¡æ‰§è¡Œå…¨é‡å¤åˆ¶ï¼Œå°†æ‰€æœ‰æ•°æ®å‘ç»™slave node
ï¼ˆ6ï¼‰master nodeåç»­æŒç»­å°†å†™å‘½ä»¤ï¼Œå¼‚æ­¥å¤åˆ¶ç»™slave node

### 2ã€æ•°æ®åŒæ­¥ç›¸å…³çš„æ ¸å¿ƒæœºåˆ¶

æŒ‡çš„å°±æ˜¯ç¬¬ä¸€æ¬¡slaveè¿æ¥msaterçš„æ—¶å€™ï¼Œæ‰§è¡Œçš„å…¨é‡å¤åˆ¶ï¼Œé‚£ä¸ªè¿‡ç¨‹é‡Œé¢ä½ çš„ä¸€äº›ç»†èŠ‚çš„æœºåˆ¶

ï¼ˆ1ï¼‰masterå’Œslaveéƒ½ä¼šç»´æŠ¤ä¸€ä¸ªoffset

masterä¼šåœ¨è‡ªèº«ä¸æ–­ç´¯åŠ offsetï¼Œslaveä¹Ÿä¼šåœ¨è‡ªèº«ä¸æ–­ç´¯åŠ offset
slaveæ¯ç§’éƒ½ä¼šä¸ŠæŠ¥è‡ªå·±çš„offsetç»™masterï¼ŒåŒæ—¶masterä¹Ÿä¼šä¿å­˜æ¯ä¸ªslaveçš„offset

è¿™ä¸ªå€’ä¸æ˜¯è¯´ç‰¹å®šå°±ç”¨åœ¨å…¨é‡å¤åˆ¶çš„ï¼Œä¸»è¦æ˜¯masterå’Œslaveéƒ½è¦çŸ¥é“å„è‡ªçš„æ•°æ®çš„offsetï¼Œæ‰èƒ½çŸ¥é“äº’ç›¸ä¹‹é—´çš„æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µ

ï¼ˆ2ï¼‰backlog

master nodeæœ‰ä¸€ä¸ªbacklogï¼Œé»˜è®¤æ˜¯1MBå¤§å°
master nodeç»™slave nodeå¤åˆ¶æ•°æ®æ—¶ï¼Œä¹Ÿä¼šå°†æ•°æ®åœ¨backlogä¸­åŒæ­¥å†™ä¸€ä»½
backlogä¸»è¦æ˜¯ç”¨æ¥åšå…¨é‡å¤åˆ¶ä¸­æ–­å€™çš„å¢é‡å¤åˆ¶çš„

ï¼ˆ3ï¼‰master run id

info serverï¼Œå¯ä»¥çœ‹åˆ°master run id
å¦‚æœæ ¹æ®host+ipå®šä½master nodeï¼Œæ˜¯ä¸é è°±çš„ï¼Œå¦‚æœmaster nodeé‡å¯æˆ–è€…æ•°æ®å‡ºç°äº†å˜åŒ–ï¼Œé‚£ä¹ˆslave nodeåº”è¯¥æ ¹æ®ä¸åŒçš„run idåŒºåˆ†ï¼Œrun idä¸åŒå°±åšå…¨é‡å¤åˆ¶
å¦‚æœéœ€è¦ä¸æ›´æ”¹run idé‡å¯redisï¼Œå¯ä»¥ä½¿ç”¨redis-cli debug reloadå‘½ä»¤

ï¼ˆ4ï¼‰psync

ä»èŠ‚ç‚¹ä½¿ç”¨psyncä»master nodeè¿›è¡Œå¤åˆ¶ï¼Œpsync runid offset
master nodeä¼šæ ¹æ®è‡ªèº«çš„æƒ…å†µè¿”å›å“åº”ä¿¡æ¯ï¼Œå¯èƒ½æ˜¯FULLRESYNC runid offsetè§¦å‘å…¨é‡å¤åˆ¶ï¼Œå¯èƒ½æ˜¯CONTINUEè§¦å‘å¢é‡å¤åˆ¶

### 3ã€å…¨é‡å¤åˆ¶

ï¼ˆ1ï¼‰masteræ‰§è¡Œbgsaveï¼Œåœ¨æœ¬åœ°ç”Ÿæˆä¸€ä»½rdbå¿«ç…§æ–‡ä»¶
ï¼ˆ2ï¼‰master nodeå°†rdbå¿«ç…§æ–‡ä»¶å‘é€ç»™salve nodeï¼Œå¦‚æœrdbå¤åˆ¶æ—¶é—´è¶…è¿‡60ç§’ï¼ˆrepl-timeoutï¼‰ï¼Œé‚£ä¹ˆslave nodeå°±ä¼šè®¤ä¸ºå¤åˆ¶å¤±è´¥ï¼Œå¯ä»¥é€‚å½“è°ƒèŠ‚å¤§è¿™ä¸ªå‚æ•°
ï¼ˆ3ï¼‰å¯¹äºåƒå…†ç½‘å¡çš„æœºå™¨ï¼Œä¸€èˆ¬æ¯ç§’ä¼ è¾“100MBï¼Œ6Gæ–‡ä»¶ï¼Œå¾ˆå¯èƒ½è¶…è¿‡60s
ï¼ˆ4ï¼‰master nodeåœ¨ç”Ÿæˆrdbæ—¶ï¼Œä¼šå°†æ‰€æœ‰æ–°çš„å†™å‘½ä»¤ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œåœ¨salve nodeä¿å­˜äº†rdbä¹‹åï¼Œå†å°†æ–°çš„å†™å‘½ä»¤å¤åˆ¶ç»™salve node
ï¼ˆ5ï¼‰client-output-buffer-limit slave 256MB 64MB 60ï¼Œå¦‚æœåœ¨å¤åˆ¶æœŸé—´ï¼Œå†…å­˜ç¼“å†²åŒºæŒç»­æ¶ˆè€—è¶…è¿‡64MBï¼Œæˆ–è€…ä¸€æ¬¡æ€§è¶…è¿‡256MBï¼Œé‚£ä¹ˆåœæ­¢å¤åˆ¶ï¼Œå¤åˆ¶å¤±è´¥
ï¼ˆ6ï¼‰slave nodeæ¥æ”¶åˆ°rdbä¹‹åï¼Œæ¸…ç©ºè‡ªå·±çš„æ—§æ•°æ®ï¼Œç„¶åé‡æ–°åŠ è½½rdbåˆ°è‡ªå·±çš„å†…å­˜ä¸­ï¼ŒåŒæ—¶åŸºäºæ—§çš„æ•°æ®ç‰ˆæœ¬å¯¹å¤–æä¾›æœåŠ¡
ï¼ˆ7ï¼‰å¦‚æœslave nodeå¼€å¯äº†AOFï¼Œé‚£ä¹ˆä¼šç«‹å³æ‰§è¡ŒBGREWRITEAOFï¼Œé‡å†™AOF

rdbç”Ÿæˆã€rdbé€šè¿‡ç½‘ç»œæ‹·è´ã€slaveæ—§æ•°æ®çš„æ¸…ç†ã€slave aof rewriteï¼Œå¾ˆè€—è´¹æ—¶é—´

å¦‚æœå¤åˆ¶çš„æ•°æ®é‡åœ¨4G~6Gä¹‹é—´ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½å…¨é‡å¤åˆ¶æ—¶é—´æ¶ˆè€—åˆ°1åˆ†åŠåˆ°2åˆ†é’Ÿ

### 4ã€å¢é‡å¤åˆ¶

ï¼ˆ1ï¼‰å¦‚æœå…¨é‡å¤åˆ¶è¿‡ç¨‹ä¸­ï¼Œmaster-slaveç½‘ç»œè¿æ¥æ–­æ‰ï¼Œé‚£ä¹ˆsalveé‡æ–°è¿æ¥masteræ—¶ï¼Œä¼šè§¦å‘å¢é‡å¤åˆ¶
ï¼ˆ2ï¼‰masterç›´æ¥ä»è‡ªå·±çš„backlogä¸­è·å–éƒ¨åˆ†ä¸¢å¤±çš„æ•°æ®ï¼Œå‘é€ç»™slave nodeï¼Œé»˜è®¤backlogå°±æ˜¯1MB
ï¼ˆ3ï¼‰msaterå°±æ˜¯æ ¹æ®slaveå‘é€çš„psyncä¸­çš„offsetæ¥ä»backlogä¸­è·å–æ•°æ®çš„

### 5ã€heartbeat

ä¸»ä»èŠ‚ç‚¹äº’ç›¸éƒ½ä¼šå‘é€heartbeatä¿¡æ¯

masteré»˜è®¤æ¯éš”10ç§’å‘é€ä¸€æ¬¡heartbeatï¼Œsalve nodeæ¯éš”1ç§’å‘é€ä¸€ä¸ªheartbeat

### 6ã€å¼‚æ­¥å¤åˆ¶

masteræ¯æ¬¡æ¥æ”¶åˆ°å†™å‘½ä»¤ä¹‹åï¼Œç°åœ¨å†…éƒ¨å†™å…¥æ•°æ®ï¼Œç„¶åå¼‚æ­¥å‘é€ç»™slave node

![maste run idçš„ä½œç”¨](/Users/liujiang/Documents/Typora/imgs/maste run idçš„ä½œç”¨.png)

# ä¸»ä»å¤åˆ¶è¯»å†™åˆ†ç¦»æ­å»º

```sh
ä¸€ä¸»ä¸€ä»ï¼Œå¾€ä¸»èŠ‚ç‚¹å»å†™ï¼Œåœ¨ä»èŠ‚ç‚¹å»è¯»ï¼Œå¯ä»¥è¯»åˆ°ï¼Œä¸»ä»æ¶æ„å°±æ­å»ºæˆåŠŸäº†

daemonize	yes							è®©redisä»¥daemonè¿›ç¨‹è¿è¡Œ
pidfile		/var/run/redis_6379.pid 	è®¾ç½®redisçš„pidæ–‡ä»¶ä½ç½®
dir 		/var/redis/6379				è®¾ç½®æŒä¹…åŒ–æ–‡ä»¶çš„å­˜å‚¨ä½ç½®

1ã€ä¿®æ”¹masteré…ç½®æ–‡ä»¶
masteré»˜è®¤6379ä¸å˜
ä»èŠ‚ç‚¹ä¿®æ”¹ç«¯å£å· 6380ã€6381

masterï¼š
bind 192.168.83.171(ä¿®æ”¹æˆè™šæ‹Ÿæœºip)
slaveï¼š
bind 192.168.83.172
ä»èŠ‚ç‚¹å¢åŠ ä¸»èŠ‚ç‚¹ipï¼š
slaveof 192.168.83.171 6379
å…¶ä»–åŒæ­¥

ä¾æ¬¡å¯åŠ¨ä¸»ä»

2ã€å¼ºåˆ¶è¯»å†™åˆ†ç¦»

åŸºäºä¸»ä»å¤åˆ¶æ¶æ„ï¼Œå®ç°è¯»å†™åˆ†ç¦»

redis slave nodeåªè¯»ï¼Œé»˜è®¤å¼€å¯ï¼Œslave-read-only

å¼€å¯äº†åªè¯»çš„redis slave nodeï¼Œä¼šæ‹’ç»æ‰€æœ‰çš„å†™æ“ä½œï¼Œè¿™æ ·å¯ä»¥å¼ºåˆ¶æ­å»ºæˆè¯»å†™åˆ†ç¦»çš„æ¶æ„

3ã€é›†ç¾¤å®‰å…¨è®¤è¯

masterä¸Šå¯ç”¨å®‰å…¨è®¤è¯ï¼Œrequirepass
masterè¿æ¥å£ä»¤ï¼Œmasterauth

4ã€è¯»å†™åˆ†ç¦»æ¶æ„çš„æµ‹è¯•

å…ˆå¯åŠ¨ä¸»èŠ‚ç‚¹ï¼Œeshop-cache01ä¸Šçš„rediså®ä¾‹
å†å¯åŠ¨ä»èŠ‚ç‚¹ï¼Œeshop-cache02ä¸Šçš„rediså®ä¾‹

åˆšæ‰æˆ‘è°ƒè¯•äº†ä¸€ä¸‹ï¼Œredis slave nodeä¸€ç›´è¯´æ²¡æ³•è¿æ¥åˆ°ä¸»èŠ‚ç‚¹çš„6379çš„ç«¯å£

åœ¨æ­å»ºç”Ÿäº§ç¯å¢ƒçš„é›†ç¾¤çš„æ—¶å€™ï¼Œä¸è¦å¿˜è®°ä¿®æ”¹ä¸€ä¸ªé…ç½®ï¼Œbind

bind 127.0.0.1 -> æœ¬åœ°çš„å¼€å‘è°ƒè¯•çš„æ¨¡å¼ï¼Œå°±åªèƒ½127.0.0.1æœ¬åœ°æ‰èƒ½è®¿é—®åˆ°6379çš„ç«¯å£

æ¯ä¸ªredis.confä¸­çš„bind 127.0.0.1 -> bindè‡ªå·±çš„ipåœ°å€
åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½: iptables -A INPUT -ptcp --dport  6379 -j ACCEPT

redis-cli -h ipaddr
info replication

åœ¨ä¸»ä¸Šå†™ï¼Œåœ¨ä»ä¸Šè¯»

```

