# 项目完成需求

## 1、修改密码

1. 为修改密码表单中的每一个表单项添加name属性，name属性的值要和接口中的参数名称保持一致

```html
<form class="form-horizontal" id="updatePassword">
    <div class="form-group">
        <label for="old" class="col-sm-3 control-label">旧密码</label>
        <div class="col-sm-7">
            <input id="old" class="form-control" type="password" placeholder="旧密码" name="userPass">
        </div>
    </div>
    <div class="form-group">
        <label for="password" class="col-sm-3 control-label">新密码</label>
        <div class="col-sm-7">
            <input id="password" class="form-control" type="password" placeholder="新密码" name="newPass">
        </div>
    </div>
    <div class="form-group">
        <label for="confirm" class="col-sm-3 control-label">确认新密码</label>
        <div class="col-sm-7">
            <input id="confirm" class="form-control" type="password" placeholder="确认新密码" name="confirmPass">
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-offset-3 col-sm-7">
            <button type="submit" class="btn btn-primary">修改密码</button>
        </div>
    </div>
</form>
```

2. 为修改密码表单添加表单提交事件，在事件处理函数中，阻止表单的默认提交行为

3. 获取到用户在表单中输入的内容

```js
$('#updatePassword').on('submit',function(){
    var formData = $(this).serialize()
    $.ajax({
        type: "put",
        url: "/updatePassword",
        data: formData,
        success: function (response) {
            location.href = '/admin/login.html'
        }
    });
    return false;
})
```

4. 调用修改密码接口，实现密码修改功能，如果密码修改成功，跳转到登录页面，让用户重新登录

```js
user.put('/password', require('./component/user/password'));
```

```js
const { User } = require('../../../model/User');
module.exports = async (req, res) => {
    // 判断用户是否处于登录状态
    // 获取输入的旧密码
    // 获取原始密码
    // 获取新密码
    // 获取确认密码
    // 判断旧密码与当前登录账户的密码是否一致
    // 判断新密码和确认密码是否一致
    if (req.session.userInfo) {
        // 原始正确密码
        const originPass = req.session.userInfo.password;
        // 用户id
        const id = req.session.userInfo._id;     
        // 获取新密码以及确认密码
        const { userPass, newPass, confirmPass } = req.body;
        // 如果用户输入的旧密码和原始密码一致
        if (userPass==originPass) {
            // 如果用户输入的两次密码相同
            if (newPass == confirmPass) {
                let user = await User.updateOne({_id:id}, {$set:{"password":confirmPass}})          
                // 清空session
                req.session.userInfo = null;
                res.send({ message: '密码修改成功' });
            } else {
                res.status(400).send({ message: '两次新密码输入的不相同' });
            }
        } else {
            res.status(400).send({ message: '原始密码输入错误' })
        }
    } else {
        res.status(400).send({ message: '请登录' });
    }

};
```

## 2、添加分类

1. 为表单中的每一个表单项添加name属性，name属性的值要和接口文档中要求的参数名称保持一致
2. 为表单添加表单提交事件，在事件处理函数中，阻止表单提交的默认行为
3. 获取到用户在表单中输入的内容
4. 调用分类添加接口，实现添加分类功能

```html
<form id="addCategory">
    <h2>添加分类</h2>
    <div class="form-group">
        <label>名称</label>
        <input class="form-control" type="text" placeholder="请输入分类名称" name="title">
    </div>
    <div class="form-group">
        <label>图标</label>
        <input class="form-control" type="text" placeholder="请输入分类图标类名" name="className">
    </div>
    <div class="form-group">
        <button class="btn btn-primary" type="submit">添加</button>
    </div>
</form>
```

```js
<link rel="stylesheet" href="../assets/vendors/font-awesome/css/font-awesome.css">
    //由于引入的是font-awesome字体库，想改变图表，需要查看网站样式，这里直接赋值前台页面的图标
```

![粘贴的图片2020_1_4_下午3_18](../%E5%89%8D%E7%AB%AF%E8%AF%BE%E4%BB%B6/47%E3%80%81%E9%A1%B9%E7%9B%AE%E7%AC%AC%E4%BA%8C%E5%A4%A9/%E7%B2%98%E8%B4%B4%E7%9A%84%E5%9B%BE%E7%89%872020_1_4_%E4%B8%8B%E5%8D%883_18.png)

创建categorySchema

```js
// 数据库操作
const mongoose = require('mongoose');
// 模型规则类
const { Schema } = mongoose;
// 文章模型规则
const CategorySchema = new Schema({
	// 分类名称
	title: {
		type: String,
		minlength: 2,
		maxlength: 30,
		required: true,
		unique: true
	},
	// 分类类名
	className: {
		type: String,
		default: null
	},
	// 创建时间
	createAt: {
		type: Date,
		default: Date.now
	}
}, { versionKey: false });

// 创建分类集合
const Category = mongoose.model('Category', CategorySchema);
// 导出模块成员
module.exports = {
	Category
}


```

路由

```js
// 路由集合
module.exports = app => {
    // 用户
    app.use('/users', require('./users'));
	// 分类
	app.use('/categories', require('./category'));
	// 文章
	// 评论
	// 轮播图
	// 网站设置

	// 其他
	// 用户登录
	app.post('/login', require('./other/login'));
    // 用户退出
    app.post('/logout', require('./other/logout'));
    // 判断用户是否登录
    app.get('/login/status', require('./other/loginStatus'));
	// 图片文件上传
	app.post('/upload', require('./other/upload'));
};
```

routes/category.js

```js
// 文章分类路由
const category = require('express').Router();
// 添加分类
category.post('/', require('./component/category/create'));
module.exports = category;
```

Create.js

```js
// 分类模型
const { Category } = require('../../../model/Category');

module.exports = async (req, res) => {
	// 查询分类
	let category = await Category.findOne({title: req.body.title});
	// 分类已存在
	if (category) return res.status(400).send({message: '分类已经存在'});
	// 创建分类对象
	category = new Category(req.body);
	// 保存分类
	await category.save();
	// 响应
	res.send(category);
};

```

发送请求

```js
// 当添加分类表单发生提交行为的时候
$('#addCategory').on('submit', function () {
	// 获取用户在表单中输入的内容
	var formData = $(this).serialize();
	// 向服务器端发送请求 添加分类
	$.ajax({
		type: 'post',
		url: '/categories',
		data: formData,
		success: function () {
			location.reload();
		}
	})
	// 阻止表单默认提交行为
	return false;
});
```

## 3、分类列表展示

1. 向服务器端发送Ajax请求，索要分类页面数据
2. 使用模板引擎将服务器端返回的数据和HTML模板进行拼接
3. 将拼接好的内容展示在页面中

路由

```js
// 文章分类路由
const category = require('express').Router();

// 添加分类
category.post('/', require('./component/category/create'));
// 根据分类ID删除分类信息
category.delete('/:id', require('./component/category/findByIdAndDelete'));
// 查询所有分类
category.get('/', require('./component/category/find'));
// 查询分类数量
category.get('/count', require('./component/category/count'));
// 根据分类ID修改分类信息
category.put('/:id', require('./component/category/findByIdAndUpdate'));
// 根据分类ID查询分类信息
category.get('/:id', require('./component/category/findById'));

module.exports = category;
```

```js

const { Category, validateCategory } = require('../../../model/Category');

module.exports = async (req, res) => {
	// 查询用户信息
	const category = await Category.find();
	// 响应 文章分类存在
	return res.send(category);
	
}
```

```html
  <script src="../assets/vendors/art-template/template-web.js"></script>
```

```html
<script type="text/html" id="categoryListTpl">
    {{each data}}
    <tr>
      <td class="text-center"><input type="checkbox"></td>
      <td>{{$value.title}}</td>
      <td class="text-center">
        <a href="javascript:;" class="btn btn-info btn-xs">编辑</a>
        <a href="javascript:;" class="btn btn-danger btn-xs">删除</a>
    </td>
    </tr>
    {{/each}}
</script>


<tbody id="categoryBox">


</tbody>
```

```js
$.ajax({
    type: "get",
    url: "/categories",
    success: function (response) {
       // 将服务器端返回的数据和HTML模板进行拼接
		var html = template('categoryListTpl', {data: response});
		// 将拼接好的内容放到页面中
		$('#categoryBox').html(html);
    }
});
```

## 4、分类数据修改

1. 通过事件委托为编辑按钮添加点击事件，在事件处理函数中获取到要修改的分类数据id
2. 根据id调用接口，获取分类数据的详细信息
3. 利用模板引擎将分类数据和HTML字符进行拼接，拼接完成以后将内容渲染到页面中
4. 为修改按钮添加点击事件，在事件处理函数中获取到管理员在表单中输入的内容
5. 调用修改分类数据接口，实现分类数据修改功能。

```js
// 为编辑按钮添加点击事件 ,回显到左侧
$('#categoryBox').on('click', '.edit', function () {
    // 获取要修改的分类数据的id
    var id = $(this).attr('data-id');
    // 根据id获取分类数据的详细信息
    $.ajax({
        type: 'put',
        url: '/categories/' + id,
        success: function (response) {
            var html = template('editCategoryTpl', response);
            $('#formBox').html(html);
        }
    })
});
```

```html
<a href="javascript:;" class="btn btn-info btn-xs edit" data-id="{{$value._id}}">编辑</a>


<div class="col-md-4" id="formBox">
    <form id="addCategory">
        <h2>添加分类</h2>
        <div class="form-group">
            <label>名称</label>
            <input class="form-control" type="text" placeholder="请输入分类名称" name="title">
        </div>
        <div class="form-group">
            <label>图标</label>
            <input class="form-control" type="text" placeholder="请输入分类图标类名" name="className">
        </div>
        <div class="form-group">
            <button class="btn btn-primary" type="submit">添加</button>
        </div>
    </form>
</div>
```

```html
<script type="text/html" id="editCategoryTpl">
    <form id="editCategory" data-id="{{_id}}">
      <h2>修改分类</h2>
      <div class="form-group">
        <label>名称</label>
        <input class="form-control" type="text" placeholder="请输入分类名称" name="title" value="{{title}}">
      </div>
      <div class="form-group">
        <label>图标</label>
        <input class="form-control" type="text" placeholder="请输入分类图标类名" name="className" value='{{className}}'>
      </div>
      <div class="form-group">
        <button class="btn btn-primary" type="submit">修改</button>
      </div>
    </form>
  </script>
```

点击修改按钮

```js
const { Category } = require('../../../model/Category');

module.exports = async (req, res) => {
	// 更新分类信息
	let category = await Category.updateOne({_id:req.params.id}, req.body);
	// 响应
	res.send(category);
}
```

```js
// 点击按钮修改
$('#formBox').on('submit', '#editCategory', function () {
    var id = $(this).attr('data-id')
    var formData = $(this).serialize()
    $.ajax({
        type: "put",
        url: "/categories/" + id,
        data: formData,
        success: function (response) {
            location.reload()
        }
    });
    return false;
})
```



## 5、分类数据删除

1. 通过事件委托的方式为删除按钮添加点击事件，在点击事件处理函数弹出删除确认框
2. 在用户点击了确认删除后，获取要删除的分类数据的id
3. 调用删除分类数据接口，实现删除分类数据功能，如果分类删除成功，刷新页面

```js
// 分类模块
const { Category } = require('../../../model/Category');

module.exports = async (req, res) => {
	// 获取用户id
	const id = req.params.id
	// 如果id中存在-
	if (id.indexOf('-') != -1) {
		// 批量删除
		// 将字符串id分割为数组
		const ids = id.split('-');
		for (const item of ids) {
			await Category.findByIdAndDelete(item);
		}
		// 响应
		res.send();
	}else {
		// 单个删除
		let category = await Category.findByIdAndDelete(id);
		// 响应
		res.send(category);
	}
	
};
```

```js
// 删除
$('#categoryBox').on('click', '.del', function () {
    if (confirm('是否删除？')) {
        var id = $(this).attr('data-id')
        $.ajax({
            type: "delete",
            url: "/categories/" + id,
            success: function (response) {
                location.reload()
            }
        });
    }
})
```

```html
<a href="javascript:;" class="btn btn-danger btn-xs del" data-id="{{$value._id}}">删除</a>
```

## 6、批量删除

## 7、添加文章-分类

1. 获取文章分类数据，并将数据显示在所属分类的下拉列表中供管理员选择(post-add.html)

```html
<script src="../assets/vendors/art-template/template-web.js"></script>
<script src="../assets/js/addnews.js"></script>
```

```html
 <script type="text/html" id="categoryTemplate">
    {{each data}}
    <option value="{{$value._id}}">{{$value.title}}</option>
    {{/each}}
  </script>
```

```js
// 向服务器端发送请求 获取文章分类数据
$.ajax({
	url: '/categories',
	type: 'get',
	success: function (response) {
		console.log(response)
		var html = template('categoryTpl', {data: response});
		$('#category').html(html);
	}
})
```

2. 实现文章封面图片的上传，并将上传后的图片地址保存在一个隐藏域中

   ```js
   // 文件上传
   $('#feature').on('change',function(){
       var formData = new FormData()
       formData.append('img', this.files[0])
       $.ajax({
           type: "post",
           url: "/upload",
           data: formData,
           // 告诉$.ajax方法不要解析请求参数  name = tom
           processData: false,
           // 告诉$.ajax方法不设置请求参数类型，因为已在this.files中设置了
           contentType: false,
           success: function (response) {
               console.log(response);
               $('#thumbnail').val(response.avatar)
           }
       });
   })
   ```

   ```html
   <input id="feature" class="form-control" type="file">
   <input type="hidden" name="thumbnail" id="thumbnail">
   ```

   

3. 为添加文章表单中的每一个表单项添加name属性，并且name属性值要和接口中要求的参数名称保持一致

   ```html
   <form class="row">
           <div class="col-md-9">
             <div class="form-group">
               <label for="title">标题</label>
               <input id="title" name="title" class="form-control input-lg" type="text" placeholder="文章标题">
             </div>
             <div class="form-group">
               <label for="content">内容</label>
               <textarea id="content" name="content" class="form-control input-lg" cols="30" rows="10" placeholder="内容"></textarea>
             </div>
           </div>
           <div class="col-md-3">
             <div class="form-group">
               <label for="feature">文章封面</label>
               <!-- show when image chose -->
               <img class="help-block thumbnail" style="display: none">
               <input id="feature" class="form-control" type="file">
               <input type="hidden" name="thumbnail" id="thumbnail">
             </div>
             <div class="form-group">
               <label for="category">所属分类</label>
               <select id="category"  class="form-control" name="category">
                 
               </select>
             </div>
             <div class="form-group">
               <label for="created">发布时间</label>
               <input id="created" name="createAt" class="form-control" type="datetime-local">
             </div>
             <div class="form-group">
               <label for="status">状态</label>
               <select id="status" name="state" class="form-control">
                 <option value="0">草稿</option>
                 <option value="1">已发布</option>
               </select>
             </div>
             <div class="form-group">
               <button class="btn btn-primary" type="submit">保存</button>
             </div>
           </div>
         </form>
   ```

   

4. 为添加文章表单绑定表单提交事件，在事件处理函数中阻止表单默认提交的行为

5. 获取到管理员在表单中输入的内容

6. 向服务器端发送添加文章的请求，实现文章添加功能，文章添加成功以后要跳转到文章列表页面

```js
// 数据库操作
const mongoose = require('mongoose');
// 模型规则类
const { Schema } = mongoose;

// 文章模型规则
const PostSchema = new Schema({
	// 标题
	title: {
		type: String,
		minlength: 2,
		maxlength: 100,
		required: [true, '请输入文章标题']
	},
	// 作者
	author: {
		type: mongoose.Schema.Types.ObjectId,//对象ID
		ref: 'User',
		required: true
	},
	// 状态
	state: {
		type: Number,
		// 0 草稿 1 发布
		default: 0
	},
	// 创建时间
	createAt: {
		type: Date,
		default: Date.now
	},
	// 修改时间
	updateAt: {
		type: Date,
		default: Date.now
	},
	// 内容
	content: {
		type: String,
		default: null
	},
	// 缩略图
	thumbnail: {
		type: String,
		default: null
	},
	// 所属分类
	category: {
		type: mongoose.Schema.Types.ObjectId,
		ref: 'Category',
		required: [true, '分类信息不存在']
	},
	meta: {
		// 看过数量
		views: { type: Number, default: 0 },
		// 喜欢数量
		likes: { type: Number, default: 0 },
		// 评论数量
		comments: { type: Number, default: 0 }
	}
}, {versionKey: false});

const Post = mongoose.model('Post', PostSchema);

// 时间更新->这方法是在修改(findOneAndUpdate)数据库前调用
PostSchema.pre('findOneAndUpdate', function(next) {
	this.findOneAndUpdate({}, { updateAt: Date.now() })
	next();
});


// 导出模块成员
module.exports = {
	Post
};
```

```js
const post = require('express').Router();
// 添加文章信息
post.post('/', require('./component/post/create'));
// 根据ID删除文章
post.delete('/:id', require('./component/post/findByIdAndDelete'));
// 查询所有文章
post.get('/', require('./component/post/find'));
// 查询文章数量
post.get('/count', require(('./component/post/count')));
// 获取最新发布文章(按照发布时间排序)
post.get('/lasted', require('./component/post/lasted'));
// 获取热门推荐(按钮评论数量排序)
post.get('/recommend', require('./component/post/recommend'));
// 获取随机推荐
post.get('/random', require('./component/post/random'));
// 文章点赞
post.post('/fabulous/:id', require('./component/post/fabulous'))
// 根据分类获取文章列表
post.get('/category/:id', require('./component/post/category'))
// 文章搜索
post.get('/search/:key', require('./component/post/search'))
// 根据文章id获取文章信息
post.get('/:id', require('./component/post/findById'));
// 根据ID修改文章
post.put('/:id', require('./component/post/findByIdAndUpdate'));


module.exports = post;
```

```js
// 文章模型
const { Post } = require('../../../model/Post');

module.exports = async (req, res) => {
	// 判断session是否过期如果过期跳到登陆页
	if (req.session.userInfo) {
		// 添加作者
		req.body.author = req.session.userInfo._id;
		// 创建分类
		const post = new Post(req.body);
		// 保存分类
		await post.save();
		// 响应
		res.send(post);
	}else{
		res.status(500).send({message:"session过期了"})
	}

}
```

```js
// 创建文章
    $('#addNewsForm').on('submit', function () {
      var formData = $(this).serialize()
      $.ajax({
        type: "post",
        url: "/posts",
        data: formData,
        success: function (response) {
          location.href = '/admin/posts.html'
        },
        error:function(err){
          // session过期
          location.href = '/admin/login.html'
        }
      });
      return false;
    })
```



## 8、文章列表数据展示

1. 在页面一上来的时候向服务器端发送请求索要文章列表数据
2. 通过模板引擎将文章列表数据和HTML进行拼接，拼接完成以后将内容显示在页面中
3. 根据分页数据实现列表数据分页功能

```html
  <script src="../assets/vendors/art-template/template-web.js"></script>
  <script src="../assets/js/newsList.js"></script>
```

处理时间

```js
// 处理时间
function formateDate(date){
    var time = new Date(date);
    var str = time.getFullYear()+'-'+(time.getMonth()+1)+'-'+time.getDate()
    return str;
}
```

```js
 <td class="text-center">{{$imports.formateDate($value.createAt)}}</td>
```

```html

  <script src="../assets/vendors/art-template/template-web.js"></script>
  <script type="text/html" id="newsListTemplate">
    {{each data}}
    <tr>
      <td>{{$value.title}}</td>
      <td>小小</td>
      <td>{{$value.category}}</td>
      <td class="text-center">{{$imports.formateDate($value.createAt)}}</td>
      <td class="text-center">{{$value.state==0?'草稿':'已发布'}}</td>
      <td class="text-center">
        <a href="javascript:;" class="btn btn-default btn-xs">编辑</a>
        <a href="javascript:;" class="btn btn-danger btn-xs">删除</a>
      </td>
    </tr>
    {{/each}}
  </script>

      <table class="table table-striped table-bordered table-hover">
        <thead>
          <tr>
            <th>标题</th>
            <th>作者</th>
            <th>分类</th>
            <th class="text-center">发表时间</th>
            <th class="text-center">状态</th>
            <th class="text-center" width="100">操作</th>
          </tr>
        </thead>
        <tbody id="newsbox">
          
      
        </tbody>
      </table>
    </div>
  </div>

  <script src="../assets/js/newsList.js"></script>
  <script>NProgress.done()</script>
</body>
</html>

```

```js
  // 获取新闻列表
    app.get('/newsList', (req, res) => {
        News.find().then(result => res.send(result))
    })
```

```js
$.ajax({
    type: "get",
    url: "/newsList",
    success: function (response) {
        console.log(response);
        var html = template('newsListTemplate',{data:response})
        $('#newsbox').html(html)
    }
});
```





# 文章编辑

1. 为编辑按钮添加链接，并将文章id作为链接的查询参数传递到文章编辑页面
2. 在文章编辑页面获取地址栏中的id参数
3. 根据id获取文章详细信息，并将文章信息显示在文章编辑表单中
4. 为修改文章表单绑定表单提交事件，在事件处理函数中阻止表单默认提交的行为
5. 获取到用户在表单中输入的内容
6. 向服务器端发送请求，实现修改文章信息功能，如果文章信息修改成功，跳转到文章列表页面

```html
<a href="post-add.html?id={{$value._id}}" class="btn btn-default btn-xs">编辑</a>
```

跳转后，获取id

```js
function getUrl(name) {
    console.log(location.search);//?id=5e10605390405a6c0d03bba8
    var arr = location.search.substr(1).split('&')
    for(var i=0;i<arr.length;i++){
        var tmp = arr[i].split('=')
        if(tmp[0]==name){
            return tmp[1]
        }
    }
    return -1;
}
```

```js
// 获取地址栏id参数
function getUrl(name) {
    console.log(location.search);//?id=5e10605390405a6c0d03bba8
    var arr = location.search.substr(1).split('&')
    for (var i = 0; i < arr.length; i++) {
        var tmp = arr[i].split('=')
        if (tmp[0] == name) {
            return tmp[1]
        }
    }
    return -1;
}

// 解析get提交字符串  ?id=111&age=20
var id = getUrl('id')
// 当前管理员是在做修改文章操作
if (id != -1) {
    // 根据id获取文章的详细信息
    $.ajax({
        type: 'get',
        url: '/posts/' + id,
        success: function (response) {
            $.ajax({
                url: '/categories',
                type: 'get',
                success: function (categories) {
                    response.categories = categories;
                    console.log(response)
                    var html = template('modifyTpl', response);
                    $('#parentBox').html(html);
                }
            })

        }
    })
}
```

接口

```js
 // 获取新闻列表根据id
    app.get('/newsList/:id', (req, res) => {
        News.findOne({ _id: req.params.id }).then(result => res.send(result))
    })


    // 修改新闻
    app.put('/newsList/:id', (req, res) => {
        var data = req.body
        News.updateOne({ _id: req.params.id }, data).then(result => res.send(result))
    })
```

html

```html
 <div id="parentBox">
        <form class="row" id="addForm">
          <div class="col-md-9">
            <div class="form-group">
              <label for="title">标题</label>
              <input id="title" name="title" class="form-control input-lg" type="text" placeholder="文章标题">
            </div>
            <div class="form-group">
              <label for="content">内容</label>
              <textarea id="content" name="content" class="form-control input-lg" cols="30" rows="10"
                placeholder="内容"></textarea>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label for="feature">文章封面</label>
              <!-- show when image chose -->
              <img class="help-block thumbnail" style="display: none">
              <input id="feature" class="form-control" type="file">
              <input type="hidden" name="thumbnail" id="thumbnail">
            </div>
            <div class="form-group">
              <label for="category">所属分类</label>
              <select id="category" class="form-control" name="category">

              </select>
            </div>
            <div class="form-group">
              <label for="created">发布时间</label>
              <input id="created" name="createAt" class="form-control" type="date">
            </div>
            <div class="form-group">
              <label for="status">状态</label>
              <select id="status" name="state" class="form-control">
                <option value="0">草稿</option>
                <option value="1">已发布</option>
              </select>
            </div>
            <div class="form-group">
              <button class="btn btn-primary" type="submit">保存</button>
            </div>
          </div>
        </form>
      </div>
```

```js
  <!-- 修改文章信息表单模板 -->
  <script type="text/html" id="modifyTpl">
    <form class="row" id="modifyForm" data-id={{_id}}>
      <div class="col-md-9">
        <div class="form-group">
          <label for="title">标题</label>
          <input id="title" class="form-control input-lg" 
          type="text" placeholder="文章标题" name="title" value="{{title}}">
        </div>
        <div class="form-group">
          <label for="content">内容</label>
          <textarea id="content" 
          class="form-control input-lg" cols="30" rows="10" 
          placeholder="内容" name="content">{{content}}</textarea>
        </div>
      </div>
      <div class="col-md-3">
        <div class="form-group">
          <label for="feature">文章封面</label>
          <!-- show when image chose -->
          <img class="help-block thumbnail" style="display: none">
          <input id="feature" class="form-control" type="file">
          <input type="hidden" name="thumbnail" id="thumbnail" value="{{thumbnail}}">
        </div>
        <div class="form-group">
          <label for="category">所属分类</label>
          <select id="category" class="form-control" name="category">
            {{each categories}}
              <option {{category == $value._id ? "selected" : ""}} value="{{$value._id}}">{{$value.title}}</option>
            {{/each}}
          </select>
        </div>
        <div class="form-group">
          <label for="created">发布时间</label>
          <input id="created" class="form-control" 
          type="date" name="createAt" value="{{createAt==null?'':createAt.split('T')[0]}}">
        </div>
        <div class="form-group">
          <label for="status">状态</label>
          <select id="status" class="form-control" name="state">
            <option value="0" {{state == 0 ? "selected": ""}}>草稿</option>
            <option value="1" {{state == 1 ? "selected": ""}}>已发布</option>
          </select>
        </div>
        <div class="form-group">
          <button class="btn btn-primary" type="submit">修改</button>
        </div>
      </div>
    </form>
  </script>
```

点击修改

```js
// 当修改文章信息表单发生提交行为的时候
$('#parentBox').on('submit', '#modifyForm', function () {
	// 获取管理员在表单中输入的内容
	var formData = $(this).serialize()
	// 获取管理员正在修改的文章id值
	var id = $(this).attr('data-id');
	$.ajax({
		type: 'put',
		url: '/posts/' + id,
		data: formData,
		success: function () {
			location.href = '/admin/posts.html';
		}
	})
	// 阻止表单默认提交行为
	return false;
});
```

接口

```js
const { Post } = require('../../../model/Post');

module.exports = async (req, res) => {
	// 要修改的文章id
	const id = req.params.id;
	// 通过验证
	let post = await Post.updateMany({_id:id}, req.body);
	// 响应
	res.send(post);
}
```





# 文章删除

1. 通过事件委托为删除按钮添加点击事件，在事件处理函数中弹出一个删除确认框，跟管理员确认删除操作
2. 在事件处理函数中获取要删除的文章的id
3. 发送Ajax请求，执行删除操作，删除操作成功，刷新页面

```js
// 当删除按钮被点击的时候
$('#postsBox').on('click', '.delete', function () {
	// 弹出删除确认框 和管理员确认是否真的要进行删除操作
	if(confirm('您真的要进行删除操作吗')) {
		// 获取到管理员要删除的文章的id
		var id = $(this).attr('data-id');
		// 向服务器端发送请求 执行删除操作
		$.ajax({
			type: 'delete',
			url: '/posts/' + id,
			success: function () {
				location.reload();
			}
		})
	}
});
```

```html
<a href="javascript:;" class="btn btn-danger btn-xs delete" data-id="{{$value._id}}">删除</a>
```

```js
const { Post } = require('../../../model/Post');

// 文件模块
const fs = require('fs');
// 路径处理
const path = require('path');
// 方法改造
const { promisify } = require('util');
// 删除文件
const unlink = promisify(fs.unlink);

module.exports = async (req, res) => {
	// 获取id
	const id = req.params.id;
	// 删除
	let post = await Post.findOneAndDelete({ _id: id })
	console.log(post);
	
	// 如果缩略图存在
	if (post.thumbnail) {
		// 删除缩略图
		await unlink(path.join(__dirname, '../', '../', '../', 'public', post.thumbnail));
	}
	// 响应
	res.send(post);
}
```

# 图片轮播数据添加

1. 实现图片上传功能，并且将上传后的图片地址保存在一个隐藏域中
2. 为图片轮播表单中的每一个表单项添加name属性，name属性的值要和接口中要求的参数名称保持一致
3. 为图片轮播表单绑定表单提交事件，在事件处理函数中阻止表单默认提交的行为
4. 获取到管理员在表单中输入的内容
5. 向服务器端发送请求，实现图片轮播数据添加功能，如果数据添加成功，刷新页面

```js
// 路由集合
module.exports = app => {
    // 用户
    app.use('/users', require('./users'));
	// 分类
	app.use('/categories', require('./category'));
	// 文章
	app.use('/posts', require('./post'));
	// 评论
	app.use('/comments', require('./comment'));
	// 轮播图
	app.use('/slides', require('./slide'));
	// 网站设置

	// 其他
	// 用户登录
	app.post('/login', require('./other/login'));
    // 用户退出
    app.post('/logout', require('./other/logout'));
    // 判断用户是否登录
    app.get('/login/status', require('./other/loginStatus'));
	// 图片文件上传
	app.post('/upload', require('./other/upload'));
};
```

```js
// 用户路由
const slide = require('express').Router();

// 添加轮播图片
slide.post('/', require('./component/slide/create'));
// 根据id删除轮播图片
slide.delete('/:id', require('./component/slide/findByIdAndDelete'));
// 获取轮播图
slide.get('/', require('./component/slide/find'))

// 导出路由
module.exports = slide;
```

```js
// 数据库操作
const mongoose = require('mongoose');
// 模型规则类
const { Schema } = mongoose;

// 用户集合规则
const SlideSchema = new Schema({
	// 标题
	title: {
		type: String,
		required: true,
		minlength: 2,
		maxlength: 30
	},
	// 头像
	image: {
		type: String,
		required: true,
		default: null
	},
	link: {
		type: String,
		default: null
	}
}, {versionKey: false});

// 用户集合类
const Slide = mongoose.model('Slide', SlideSchema);


// 导出对象
module.exports = {
	Slide
};
```

```js
// 当管理员选择文件的时候
$('#file').on('change', function () {
    // 用户选择到的文件
    var file = this.files[0];
    // 创建formData对象实现二进制文件上传
    var formData = new FormData();
    // 将管理员选择到的文件添加到formData对象中
    formData.append('img', file);
    // 向服务器端发送请求 实现图片上传
    $.ajax({
        type: 'post',
        url: '/upload',
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
            console.log(response)
            $('#image').val(response.avatar)
        }
    })
});
```

```html
<input class="form-control" type="file" id="file">
<input type="hidden" name="image" id="image">
<input id="title" class="form-control" name="title" type="text" placeholder="文本">
<input id="link" class="form-control" name="link" type="text" placeholder="链接">
```

```js
// 当轮播图表单发生提交行为时
$('#slidesForm').on('submit', function () {
	// 获取管理员在表单中输入的内容
	var formData = $(this).serialize();
	// 向服务器端发送请求 添加轮播图数据
	$.ajax({
		type: 'post',
		url: '/slides',
		data: formData,
		success: function () {
			location.reload();
		}
	})
	// 阻止表单默认提交行为
	return false;
})
```

```js
const { Slide } = require('../../../model/Slide');

module.exports = async (req, res) => {
	// 格式符合要求 继续向下执行
	// 创建轮播图
	let slide = new Slide(req.body);
	console.log(slide);
	
	// 保存用户
	await slide.save();
	// 响应
	res.send(slide);
};
```



# 轮播图数据展示

1. 向服务器端发送请求索要图片轮播列表数据
2. 使用模板引擎将图片轮播列表数据和HTML模板进行拼接，拼接完成以后将内容展示在页面中

```js
// 向服务器端发送请求 索要图片轮播列表数据
$.ajax({
	type: 'get',
	url: '/slides',
	success: function (response) {
		console.log(response)
		var html = template('slidesTpl', {data: response});
		$('#slidesBox').html(html);
	}
})
```

```js
<script src="../assets/vendors/art-template/template-web.js"></script>
```

```js
  <!-- 轮播图列表模板 -->
  <script type="text/html" id="slidesTpl">
    {{each data}}
    <tr>
      <td class="text-center"><img class="slide" src="{{$value.image}}"></td>
      <td>{{$value.title}}</td>
      <td>{{$value.link}}</td>
      <td class="text-center">
        <a href="javascript:;" class="btn btn-danger btn-xs delete" data-id="{{$value._id}}">删除</a>
      </td>
    </tr>
    {{/each}}
  </script>
```

```js
const { Slide } = require('../../../model/Slide');

module.exports = async (req, res) => {
	// 查找
	let slides = await Slide.find();
	// 响应
	res.send(slides);
};
```



# 图片轮播数据删除

1. 通过事件委托的方式为删除按钮添加点击事件
2. 在事件处理函数中弹出删除确认框
3. 获取到要删除的轮播图数据的id
4. 向服务器端发送请求，执行删除操作，删除操作成功，刷新页面

```js
// 当删除按钮被点击时
$('#slidesBox').on('click', '.delete', function () {
	if (confirm('您真的要进行删除操作吗')) {
		// 获取管理员要删除的轮播图数据id
		var id = $(this).attr('data-id');
		// 向服务器发送请求 实现轮播数据删除功能
		$.ajax({
			type: 'delete',
			url: '/slides/' + id,
			success: function () {
				location.reload();
			}
		})
	}
});
```

```js
const { Slide } = require('../../../model/Slide');
// 文件模块
const fs = require('fs');
// 路径处理
const path = require('path');
// 方法改造
const { promisify } = require('util');
// 删除文件
const unlink = promisify(fs.unlink);

module.exports = async (req, res) => {
	// 获取轮播id
	const id = req.params['id'];
	// 删除轮播图
	let slide = await Slide.findByIdAndDelete(id);
	// 如果缩略图存在
	if (slide.image) {
		// 删除缩略图
		await unlink(path.join(__dirname, '../', '../', '../', 'public', slide.image));
	}
	// 响应
	res.send(slide);
};
```



# 网站设置

1. 实现网站logo图片的上传，并且将上传后的图片地址保存在一个隐藏域中
2. 为表单中的每一个表单项添加name属性，name属性的值要和接口文档中要求的参数名称保持一致
3. 为表单绑定提交事件，在事件处理函数中阻止表单默认提交的行为
4. 获取到管理员在表单中输入的内容
5. 向服务器端发送请求，实现网站设置数据的添加功能

```js
// 路由集合
module.exports = app => {
    // 用户
    app.use('/users', require('./users'));
	// 分类
	app.use('/categories', require('./category'));
	// 文章
	app.use('/posts', require('./post'));
	// 评论
	app.use('/comments', require('./comment'));
	// 轮播图
	app.use('/slides', require('./slide'));
	// 网站设置
	app.use('/settings', require('./settings'));
	// 其他
	// 用户登录
	app.post('/login', require('./other/login'));
    // 用户退出
    app.post('/logout', require('./other/logout'));
    // 判断用户是否登录
    app.get('/login/status', require('./other/loginStatus'));
	// 图片文件上传
	app.post('/upload', require('./other/upload'));
};
```

```js
// 用户路由
const settings = require('express').Router();

// 添加网站设置
settings.post('/', require('./component/settings/create'));
// 获取网站配置
settings.get('/', require('./component/settings/find'))

// 导出路由
module.exports = settings;
```

```js
// 当管理员选择logo图片时
$('#logo').on('change', function () {
	// 获取到管理员选择到的图片
	var file = this.files[0];
	// 创建formData对象 实现二进制文件上传吧
	var formData = new FormData();
	// 将管理员选择到的文件添加到formData对象中
	formData.append('logo', file);
	// 向服务器端发送请求 实现文件上传
	$.ajax({
		type: 'post',
		url: '/upload',
		data: formData,
		processData: false,
		contentType: false,
		success: function (response) {
			console.log(response)
			$('#hiddenLogo').val(response[0].logo)
			// 将logo图片显示在页面中
			$('#preview').attr('src', response[0].logo)
		}
	})
});
```

```html
<input type="hidden" name="logo" id="hiddenLogo">
<input type="file" id="logo">
<img id="preview" src="../assets/img/logo.png">
```

```js
// 当网站设置表单发生提交行为时
$('#settingsForm').on('submit', function () {
	// 获取管理员在表单中输入的内容
	var formData = $(this).serialize();
	// 向服务器端发送请求 实现网站设置数据添加功能
	$.ajax({
		type: 'post',
		url: '/settings',
		data: formData,
		success: function () {
			location.reload();
		}
	})
	// 阻止表单默认提交行为
	return false;
})
```

```js
// 数据库操作
const mongoose = require('mongoose');
// 模型规则类
const { Schema } = mongoose;
// 对象规则验证
const Joi = require('joi');

// 用户集合规则
const SettingSchema = new Schema({
	// 网站图标
	logo: {
		type: String,
		default: null
	},
	// 站点名称
	title: {
		type: String,
		required: true,
		minlength: 2,
		maxlength: 30
	},
	// 是否开启评论功能
	comment: {
		type: Boolean,
		required: true,
		default: false
	},
	// 评论必须经过人工审核
	review: {
		type: Boolean,
		required: true,
		default: false
	}
}, {versionKey: false});

// 用户集合类
const Setting = mongoose.model('Setting', SettingSchema);


// 导出对象
module.exports = {
	Setting
};
```

```js
const { Setting } = require('../../../model/Setting');

module.exports = async (req, res) => {
	// 清除现有设置
	await Setting.deleteMany({});
	console.log(req.body);
	
	let settings = new Setting(req.body);
	await settings.save();
	// 响应
	res.send(settings);
};
```



# 获取网站设置数据

1. 向服务器端发送请求，获取网站设置数据
2. 判断服务器端返回的数据是否为真，如果为真，将数据展示在表单中

```js
// 向服务器端发送请求 索要网站设置数据
$.ajax({
    type: 'get',
    url: '/settings',
    success: function (response) {
        console.log(response)
        if (response) {
            // 将logo地址存储在隐藏域中
            if (response.logo) {
                $('#hiddenLogo').val(response.logo)
                // 将logo显示在页面中 
                $('#preview').attr('src', response.logo)
            }
            // 将网站标题显示在页面中
            $('input[name="title"]').val(response.title);
            // 将是否开启评论功能显示在页面中
            $('input[name="comment"]').prop('checked', response.comment)
            // 将评论是否经过人工审核显示在页面中
            $('input[name="review"]').prop('checked', response.review)
        }
    }
})
```



# 展示登录用户信息

```js
// 向服务器端发送请求 索要登录用户信息
$.ajax({
    type: 'get',
    url: '/users/' + userId,
    success: function (response) {
        $('.avatar').attr('src', response.avatar)
        $('.profile .name').html(response.name)
    }
})
```

更改loginStatus.js

```js
module.exports =  (req, res) => {
	if (req.session.userInfo) {
		res.end(`var isLogin = true;var userId='${req.session.userInfo._id}'`)
	}else {
		res.end('var isLogin = false')
	}
};
```

# 站长统计

```js
// 获取文章的数量
$.ajax({
	type: 'get',
	url: '/posts/count',
	success: function (response) {
		console.log(response)
		$('#post').html('<strong>'+ response.postCount +'</strong>篇文章（<strong>'+ response.draftCount +'</strong>篇草稿）')
	}
});

// 获取分类数量
$.ajax({
	type: 'get',
	url: '/categories/count',
	success: function (response) {
		$('#category').html('<strong>'+response.categoryCount+'</strong>个分类')
	}
})

// 获取评论数量
$.ajax({
	type: 'get',
	url: '/comments/count',
	success: function (response) {
		$('#comment').html('<strong>'+ response.commentCount +'</strong>条评论')
	}
})
```

```js
const { Post } = require('../../../model/Post');

module.exports = async (req, res) => {
	// 查询所有文章数量
	const postCount = await Post.countDocuments();
	const draftCount = await Post.countDocuments({state: 0});
	// 响应
	res.send({postCount, draftCount});
}
```

```js
const { Category } = require('../../../model/Category');

module.exports = async (req, res) => {
	// 查询所有文章数量
	const categoryCount = await Category.countDocuments();
	// 响应
	res.send({categoryCount});
}
```

# 前端获取轮播图数据，动态追加小圆点

```js
// 向服务器端发送请求 索要轮播图数据
$.ajax({
    type: 'get',
    url: '/slides',
    success: function (response) {
        console.log(response.length)
        var html = template('slidesTpl', { data: response });
        console.log(html);
        $('#slidesBox').html(html)
        // 动态添加圆点
        for(var i=0;i<response.length;i++){
            var span = $('<span></span>')
            $('.cursor').append(span)
        }
        $('.cursor span' ).eq(0).addClass('active')

        //
        var swiper = Swipe(document.querySelector('.swipe'), {
            auto: 3000,
            transitionEnd: function (index) {
                // index++;
                $('.cursor span').eq(index).addClass('active').siblings('.active').removeClass('active');
            }
        });

        // 上/下一张
        $('.swipe .arrow').on('click', function () {
            var _this = $(this);

            if (_this.is('.prev')) {
                swiper.prev();
            } else if (_this.is('.next')) {
                swiper.next();
            }
        })
    }
});
```



# 前端首页获取文章分类列表数据

```js
// 向服务器端发送请求 索要文章分类列表数据
$.ajax({
	type: 'get',
	url: '/categories',
	success: function (response) {
		var navTpl = `
			{{each data}}
			<li>
				<a href="list.html?categoryId={{$value._id}}">
					<i class="fa {{$value.className}}"></i>{{$value.title}}
				</a>
			</li>
			{{/each}}
		`;
		var html = template.render(navTpl, {data: response});
		$('#navBox').html(html)
		$('#topNavBox').html(html)
	}
})
```

# 前端文章列表页面（list.html）

把公有的抽取到public.js  每个页面引入此文件即可

```html
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>阿里百秀-发现生活，发现美!</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="assets/vendors/font-awesome/css/font-awesome.css">
  <link rel="stylesheet" href="assets/vendors/nprogress/nprogress.css">
  <script src="assets/vendors/art-template/template-web.js"></script>
</head>

<body>
  <div class="wrapper">
    <div class="topnav">
      <ul id="topNavBox">
      </ul>
    </div>
    <div class="header">
      <h1 class="logo"><a href="index.html"><img style="width: 85%;padding: 40px 14px" src="assets/img/logo.png"
            alt=""></a></h1>
      <ul class="nav" id="navBox">
      </ul>
      <div class="search">
        <form>
          <input type="text" class="keys" placeholder="输入关键字">
          <input type="submit" class="btn" value="搜索">
        </form>
      </div>
    </div>
    <div class="aside">
      <div class="widgets">
        <h4>搜索</h4>
        <div class="body search">
          <form>
            <input type="text" class="keys" placeholder="输入关键字">
            <input type="submit" class="btn" value="搜索">
          </form>
        </div>
      </div>
      <div class="widgets">
        <h4>随机推荐</h4>
        <ul class="body random" id="randomBox">
        </ul>
      </div>
      <div class="widgets">
        <h4>最新评论</h4>
        <ul class="body discuz">
          <li>
            <a href="javascript:;">
              <div class="avatar">
                <img src="uploads/avatar_1.jpg" alt="">
              </div>
              <div class="txt">
                <p>
                  <span>鲜活</span>2020-02-01说:
                </p>
                <p>挺会玩的</p>
              </div>
            </a>
          </li>
          <li>
            <a href="javascript:;">
              <div class="avatar">
                <img src="uploads/avatar_1.jpg" alt="">
              </div>
              <div class="txt">
                <p>
                  <span>鲜活</span>2020-02-01说:
                </p>
                <p>挺会玩的</p>
              </div>
            </a>
          </li>
          <li>
            <a href="javascript:;">
              <div class="avatar">
                <img src="uploads/avatar_2.jpg" alt="">
              </div>
              <div class="txt">
                <p>
                  <span>鲜活</span>2020-02-01说:
                </p>
                <p>挺会玩的</p>
              </div>
            </a>
          </li>
          <li>
            <a href="javascript:;">
              <div class="avatar">
                <img src="uploads/avatar_1.jpg" alt="">
              </div>
              <div class="txt">
                <p>
                  <span>鲜活</span>2020-02-01说:
                </p>
                <p>挺会玩的</p>
              </div>
            </a>
          </li>
          <li>
            <a href="javascript:;">
              <div class="avatar">
                <img src="uploads/avatar_2.jpg" alt="">
              </div>
              <div class="txt">
                <p>
                  <span>鲜活</span>2020-02-01说:
                </p>
                <p>挺会玩的</p>
              </div>
            </a>
          </li>
          <li>
            <a href="javascript:;">
              <div class="avatar">
                <img src="uploads/avatar_1.jpg" alt="">
              </div>
              <div class="txt">
                <p>
                  <span>鲜活</span>2020-02-01说:
                </p>
                <p>挺会玩的</p>
              </div>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="content">
      <div class="panel new">
        <div id="titleBox">

        </div>

        <div id="listBox">




        </div>
      </div>
    </div>
    <div class="footer">
      <p>© 2016 XIU主题演示 本站主题由 themebetter 提供</p>
    </div>
  </div>
  <script src="assets/vendors/jquery/jquery.js"></script>
  <script src="assets/vendors/nprogress/nprogress.js"></script>
  <script type="text/html" id="titleTpl">
    {{each data}}
    <h3>{{$value._id == id?$value.title:''}}</h3>
    {{/each}}
  </script>
  <!-- 文章列表模板 -->
  <script type="text/html" id="listTpl">
    {{each data}}
    <div class="entry">
      <div class="head">
        <a href="detail.html?id={{$value._id}}">{{$value.title}}</a>
      </div>
      <div class="main">
        <p class="info">{{$value.author.name}} 发表于 {{$imports.formateDate($value.createAt)}}</p>
        <p class="brief">{{$value.content.substr(0, 80)}}</p>
        <p class="extra">
          <span class="reading">阅读({{$value.meta.views}})</span>
          <span class="comment">评论({{$value.meta.comments}})</span>
          <a href="javascript:;" class="like">
            <i class="fa fa-thumbs-up"></i>
            <span>赞({{$value.meta.likes}})</span>
          </a>
          <a href="javascript:;" class="tags">
            分类：<span>{{$value.category.title}}</span>
          </a>
        </p>
        <a href="detail.html?id={{$value._id}}" class="thumb">
          <img src="{{$value.thumbnail}}" alt="">
        </a>
      </div>
    </div>
    {{/each}}
  </script>
  <script>
    // 向服务器端发送请求 索要文章分类列表数据
    $.ajax({
      type: 'get',
      url: '/categories',
      success: function (response) {
        var navTpl = `
              {{each data}}
              <li>
                  <a href="list.html?categoryId={{$value._id}}">
                      <i class="fa {{$value.className}}"></i>{{$value.title}}
                  </a>
              </li>
              {{/each}}
          `;
        var html = template.render(navTpl, { data: response });
        var title = template('titleTpl', { data: response, id: categoryId });
        console.log(response);

        $('#navBox').html(html)
        $('#topNavBox').html(html)
        $('#titleBox').html(title)
      }
    })

    // 向服务器端发送请求 索要随机推荐数据
    $.ajax({
      type: 'get',
      url: '/posts/random',
      success: function (response) {
        var randomTpl = `
              {{each data}}
              <li>
                <a href="detail.html?id={{$value._id}}">
                  <p class="title">{{$value.title}}</p>
                  <p class="reading">阅读({{$value.meta.views}})</p>
                  <div class="pic">
                    <img src="{{$value.thumbnail}}" alt="">
                  </div>
                </a>
              </li>
              {{/each}}
          `;
        var html = template.render(randomTpl, { data: response });
        $('#randomBox').html(html)
      }
    })


    // 从浏览器的地址栏中获取查询参数
    function getUrlParams(name) {
      var paramsAry = location.search.substr(1).split('&');
      // 循环数据
      for (var i = 0; i < paramsAry.length; i++) {
        var tmp = paramsAry[i].split('=');
        if (tmp[0] == name) {
          return tmp[1];
        }
      }
      return -1;
    }

    // 处理日期时间格式
    function formateDate(date) {
      // 将日期时间字符串转换成日期对象
      date = new Date(date);
      return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate()
    }



    // 获取地址栏中的categoryId参数
    var categoryId = getUrlParams('categoryId');

    // 根据分类id获取文章列表
    $.ajax({
      type: 'get',
      url: '/posts/category/' + categoryId,
      success: function (response) {
        var html = template('listTpl', { data: response });
        $('#listBox').html(html);
      }
    });

    // 根据分类id获取分类信息
    $.ajax({
      type: 'get',
      url: '/categories/' + categoryId,
      success: function (response) {
        $('#categoryTitle').html(response.title)
      }
    })


    // 向服务器端发送请求 索要最新评论数据
    $.ajax({
      type: 'get',
      url: '/comments/lasted',
      success: function (response) {
        var commentTpl = `
              {{each data}}
              <li>
                <a href="javascript:;">
                  <div class="avatar">
                    <img src="{{$value.author.avatar}}" alt="">
                  </div>
                  <div class="txt">
                    <p>
                      <span>{{$value.author.name}}</span>{{$imports.formateDate($value.createAt)}}说:
                    </p>
                    <p>{{$value.content}}</p>
                  </div>
                </a>
              </li>
              {{/each}}
          `;
        var html = template.render(commentTpl, { data: response });
        $('#commentBox').html(html);
      }
    })

  </script>
</body>

</html>
```

# 最新评论数据

```js
// 向服务器端发送请求 索要最新评论数据
$.ajax({
	type: 'get',
	url: '/comments/lasted',
	success: function (response) {
		var commentTpl = `
			{{each data}}
			<li>
			  <a href="javascript:;">
			    <div class="avatar">
			      <img src="{{$value.author.avatar}}" alt="">
			    </div>
			    <div class="txt">
			      <p>
			        <span>{{$value.author.name}}</span>{{$imports.formateDate($value.createAt)}}说:
			      </p>
			      <p>{{$value.content}}</p>
			    </div>
			  </a>
			</li>
			{{/each}}
		`;
		var html = template.render(commentTpl, {data: response});
		$('#commentBox').html(html);
	}
})
```

```js
// 数据库操作
const mongoose = require('mongoose');
// 模型规则类
const { Schema } = mongoose;
// 文章模型规则
const CommentSchema = new Schema({
	// 评论人
	author: {
		type: mongoose.Schema.Types.ObjectId,
		ref: 'User',
		required: true
	},
	// 评论内容
	content: {
		type: String,
		minlength: 4,
		required: true
	},
	// 评论文章
	post: {
		type: mongoose.Schema.Types.ObjectId,
		ref: 'Post',
		required: [true, '评论文章id不存在']
	},
	// 状态
	state: {
		type: Number,
		// 0 未批准 1 批准
		default: 0
	},
	// 评论时间
	createAt: {
		type: Date,
		default: Date.now
	}
}, {versionKey: false});
// 创建分类集合
const Comment = mongoose.model('Comment', CommentSchema);


// 导出模块成员
module.exports = {
	Comment
}

```

```js
// 路由集合
module.exports = app => {
	// 文章
	app.use('/posts', require('./post'));
	// 评论
	app.use('/comments', require('./comment'));
	
};
```

```js
// 文章评论路由
const comment = require('express').Router();

// 获取最新评论
comment.get('/lasted', require('./component/comment/lasted'));


// 导出路由
module.exports = comment;
```

```js
// 处理日期时间格式
function formateDate(date) {
    // 将日期时间字符串转换成日期对象
    date = new Date(date);
    return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate()
}
```

```js
const { Comment } = require('../../../model/Comment');

module.exports = async (req, res) => {
	const posts = await Comment.find().populate('author', '-password').sort('-createAt').limit(5)
	// 响应
	res.send(posts);
}
```









# 评论列表展示

1. 向服务器端发送请求，获取评论列表数据
2. 使用模板引擎将评论列表数据和HTML模板进行拼接，拼接完成以后再将内容展示在页面中
3. 根据分页数据实现分页功能

```js
<script src="../assets/vendors/art-template/template-web.js"></script>
```

```js
// 处理时间
function formateDate(date) {
    var time = new Date(date);
    var str = time.getFullYear() + '-' + (time.getMonth() + 1) + '-' + time.getDate()
    return str;
}
```

```js
// 向服务器端发送请求 获取评论列表数据
$.ajax({
    type: 'get',
    url: '/comments',
    success: function (response) {
        console.log(response)
        var html = template('commentsTpl', response);
        $('#commentsBox').html(html);
        var pageHTML = template('pageTpl', response);
        $('#pageBox').html(pageHTML)
    }
})
```

```js
// 数据库操作
const mongoose = require('mongoose');
// 模型规则类
const { Schema } = mongoose;
// 文章模型规则
const CommentSchema = new Schema({
	// 评论人
	author: {
		type: mongoose.Schema.Types.ObjectId,
		ref: 'User',
		required: true
	},
	// 评论内容
	content: {
		type: String,
		minlength: 4,
		required: true
	},
	// 评论文章
	post: {
		type: mongoose.Schema.Types.ObjectId,
		ref: 'Post',
		required: [true, '评论文章id不存在']
	},
	// 状态
	state: {
		type: Number,
		// 0 未批准 1 批准
		default: 0
	},
	// 评论时间
	createAt: {
		type: Date,
		default: Date.now
	}
}, {versionKey: false});
// 创建分类集合
const Comment = mongoose.model('Comment', CommentSchema);


// 导出模块成员
module.exports = {
	Comment
}

```

```js
// 路由集合
module.exports = app => {
    // 用户
    app.use('/users', require('./users'));
	// 分类
	app.use('/categories', require('./category'));
	// 文章
	app.use('/posts', require('./post'));
	// 评论
	app.use('/comments', require('./comment'));
	// 轮播图
	// 网站设置

	// 其他
	// 用户登录
	app.post('/login', require('./other/login'));
    // 用户退出
    app.post('/logout', require('./other/logout'));
    // 判断用户是否登录
    app.get('/login/status', require('./other/loginStatus'));
	// 图片文件上传
	app.post('/upload', require('./other/upload'));
};
```

```js
// 文章评论路由
const comment = require('express').Router();

// 添加评论
comment.post('/', require('./component/comment/create'));
// 根据id删除
comment.delete('/:id', require('./component/comment/findByIdAndDelete'));
// 获取评论列表
comment.get('/', require('./component/comment/find'));
// 获取评论数量
comment.get('/count', require('./component/comment/count'));
// 获取最新评论
comment.get('/lasted', require('./component/comment/lasted'));
// 更改评论状态
comment.put('/:id', require('./component/comment/findByIdAndUpdate'))

// 导出路由
module.exports = comment;
```

# 评论审核

1. 根据当前评论的状态更改审核按钮中的文字。如果当前评论是未审核状态，按钮中显示批准，如果当前评论是已审核状态，按钮中显示驳回
2. 通过事件委托的方式为审核按钮添加点击事件，在事件处理函数中获取到当前评论的状态
3. 向服务器端发送请求，告诉服务器端评论要更改为什么状态，如果修改成功，刷新页面，让页面中显示最新的数据

```js
// 当审核按钮被点击的时候
$('#commentsBox').on('click', '.status', function () {
	// 获取当前评论的状态
	var status = $(this).attr('data-status');
	// 获取当前要修改的评论id
	var id = $(this).attr('data-id');
	// 向服务器端发送请求 更改评论状态
	$.ajax({
		type: 'put',
		url: '/comments/' + id,
		data: {
			state: status == 0 ? 1 : 0
		},
		success: function () {
			location.reload();
		}
	})
});
```

```js
// 用户模块
const { Comment } = require('../../../model/Comment');

module.exports = async (req, res) => {
	// 待修改评论id
	const id = req.params['id'];

	let comment = await Comment.findByIdAndUpdate(id, {$set: {state: req.body.state}}, {new: true});
	// 响应
	res.send(comment);	
};
```



# 评论删除

1. 通过事件委托的方式为删除按钮添加点击事件，在事件处理函数中弹出删除确认框
2. 获取到管理员要删除的评论id值
3. 向服务器端发送请求，执行删除评论操作，评论如果删除成功，刷新页面

```js
// 当删除按钮被点击时
$('#commentsBox').on('click', '.delete', function () {
	if (confirm('您真的要执行删除操作吗')) {
		// 获取管理员要删除的评论的id
		var id = $(this).attr('data-id');
		// 向服务器端发送请求 执行删除操作
		$.ajax({
			type: 'delete',
			url: '/comments/' + id,
			success: function () {
				location.reload();
			}
		})
	}
});
```

```js
const { Comment } = require('../../../model/Comment');

module.exports = async (req, res) => {
	const id = req.params['id'];
	let comment = await Comment.findByIdAndDelete(id);
	// 响应
	res.send(comment);
	
};
```